<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Pacientes Veterinaria</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        // PEGA AQU√ç TU CONFIGURACI√ìN DE FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyBrYOiaa_skDuvRDD_zMZvUBknfwmTyDko",
          authDomain: "ale-veterinaria.firebaseapp.com",
          projectId: "ale-veterinaria",
          storageBucket: "ale-veterinaria.appspot.com",
          messagingSenderId: "87862276548",
          appId: "1:87862276548:web:a55b3154a31e4c6948b491",
          measurementId: "G-PNKMJC92K3"
        };

        // Initialize Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, runTransaction, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.db = db;
            window.firebase = { collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, runTransaction, orderBy, addDoc };
        } catch (e) {
            console.error("Firebase initialization error. Please check your firebaseConfig.", e);
        }
    </script>
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #F4F7F6; }
        h1, h2, h3, button, .font-poppins { font-family: 'Poppins', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .btn-primary { background-color: #FF7F50; color: white; }
        .btn-primary:hover { background-color: #FF6347; }
        .btn-secondary { background-color: #48D1CC; color: white; }
        .btn-secondary:hover { background-color: #20B2AA; }
        .btn-tertiary { background-color: #9370DB; color: white; }
        .btn-tertiary:hover { background-color: #8A2BE2; }
        .btn-action { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .btn-action:hover { background-color: #e5e7eb; }
        .text-accent-dark { color: #008B8B; }
        .text-highlight { color: #9370DB; }
        .ring-accent:focus { --tw-ring-color: #48D1CC; }
        input[type="text"], input[type="date"], input[type="email"], input[type="tel"], textarea, select { border: 1px solid #CBD5E0; border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: border-color 0.2s, box-shadow 0.2s; width: 100%;}
        input[type="text"]:focus, textarea:focus, select:focus { border-color: #8FB9A8; box-shadow: 0 0 0 3px rgba(143, 185, 168, 0.3); outline: none; }
        input[readonly] { background-color: #F3F4F6; cursor: not-allowed; }
        .form-radio, .form-checkbox { color: #8FB9A8; }
        .form-radio:checked, .form-checkbox:checked { background-color: #8FB9A8; border-color: #8FB9A8; }
        .section-header { border-bottom: 2px solid #8FB9A8; padding-bottom: 0.5rem; margin-bottom: 1.5rem; color: #004D40; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="max-w-6xl mx-auto p-4 md:p-8">

        <!-- ===== Portada / Dashboard View ===== -->
        <div id="view-dashboard" class="view active">
            <header class="text-center my-8">
                <img src="logo1.png" alt="Logo de la cl√≠nica veterinaria" class="w-32 h-32 mx-auto mb-4 rounded-full shadow-lg">
                <h1 class="text-4xl font-bold text-accent-dark">Sistema de Gesti√≥n Cl√≠nica</h1>
                <p class="text-gray-500 mt-2">Dra. Alejandra Caut√≠n Bast√≠as</p>
            </header>
            <main class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-accent-dark mb-4">Buscar Paciente</h2>
                    <div class="flex space-x-2">
                        <input id="search-input" type="text" placeholder="N¬∫ de Ficha o Nombre" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 ring-accent">
                        <button id="search-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Buscar</button>
                    </div>
                    <div id="search-results" class="mt-4"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col items-center justify-center">
                    <h2 class="text-2xl font-bold text-accent-dark mb-4">Acciones</h2>
                    <button id="new-patient-btn" class="w-full btn-primary py-3 rounded-lg text-lg font-bold shadow-md transform hover:scale-105 transition-transform">+ Crear Ficha de Paciente</button>
                </div>
            </main>
        </div>

        <!-- ===== Vista de Datos del Paciente (HUB) ===== -->
        <div id="view-patient-hub" class="view">
            <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-6">
                <div>
                    <h1 id="hub-patient-name" class="text-3xl font-bold text-accent-dark capitalize"></h1>
                    <p id="hub-patient-id" class="text-gray-500"></p>
                </div>
                <button class="back-to-dashboard-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">‚Üê Volver</button>
            </header>
            
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold text-accent-dark mb-2">Ficha Paciente</h2>
                        <div id="hub-patient-summary" class="space-y-1 text-sm"></div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-accent-dark mb-2">Propietario</h2>
                        <div id="hub-tutor-summary" class="space-y-1 text-sm"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
                <div id="action-buttons" class="flex flex-wrap gap-2">
                    <button data-modal="consultation" class="btn-action px-4 py-2 rounded-lg font-semibold">Consulta</button>
                    <button data-modal="vaccine" class="btn-action px-4 py-2 rounded-lg font-semibold">Vacunas</button>
                    <button data-modal="deworming" class="btn-action px-4 py-2 rounded-lg font-semibold">Desparasitaci√≥n</button>
                    <button id="go-to-prescription-btn" class="btn-action px-4 py-2 rounded-lg font-semibold">Recetas</button>
                    <button data-modal="exam" class="btn-action px-4 py-2 rounded-lg font-semibold">Ex√°menes</button>
                    <button data-modal="certificate" class="btn-action px-4 py-2 rounded-lg font-semibold">Certificados</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-accent-dark">Historial de Consultas</h2>
                    <button id="edit-patient-data-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold">Editar Datos Paciente</button>
                </div>
                <div id="consultation-history-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- ===== Vista de Edici√≥n de Datos ===== -->
        <div id="view-edit-patient-data" class="view">
             <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-6">
                <h1 class="text-3xl font-bold text-accent-dark">Datos del Paciente</h1>
                <button id="back-to-hub-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">‚Üê Volver a Ficha</button>
            </header>
            <form id="patient-data-form">
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-bold text-accent-dark mb-4">I. Datos del Tutor</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="data-tutor-name" class="block text-sm font-medium">Nombre Completo:</label><input type="text" id="data-tutor-name"></div>
                        <div><label for="data-tutor-rut" class="block text-sm font-medium">C√©dula de Identidad/DNI:</label><input type="text" id="data-tutor-rut"></div>
                        <div><label for="data-tutor-phone" class="block text-sm font-medium">Tel√©fono Principal:</label><input type="tel" id="data-tutor-phone"></div>
                        <div><label for="data-tutor-phone2" class="block text-sm font-medium">Tel√©fono Secundario:</label><input type="tel" id="data-tutor-phone2"></div>
                        <div><label for="data-tutor-email" class="block text-sm font-medium">Correo Electr√≥nico:</label><input type="email" id="data-tutor-email"></div>
                        <div><label for="data-tutor-city" class="block text-sm font-medium">Ciudad/Comuna:</label><input type="text" id="data-tutor-city"></div>
                        <div class="md:col-span-2"><label for="data-tutor-address" class="block text-sm font-medium">Direcci√≥n Completa:</label><input type="text" id="data-tutor-address"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-bold text-accent-dark mb-4">II. Datos del Paciente</h2>
                    <p class="mb-4 text-lg"><strong>N¬∫ de Ficha:</strong> <span id="data-ficha-number" class="text-highlight font-bold"></span></p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div><label for="data-patient-name" class="block text-sm font-medium">Nombre del Paciente:</label><input type="text" id="data-patient-name" required></div>
                        <div><label for="data-breed" class="block text-sm font-medium">Raza:</label><input type="text" id="data-breed"></div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Especie:</label>
                            <div class="flex items-center gap-4">
                                <label><input type="radio" name="species" value="Canina" class="form-radio"> Canina</label>
                                <label><input type="radio" name="species" value="Felina" class="form-radio"> Felina</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Sexo:</label>
                            <div class="flex items-center gap-4">
                                <label><input type="radio" name="sex" value="Macho" class="form-radio"> Macho</label>
                                <label><input type="radio" name="sex" value="Hembra" class="form-radio"> Hembra</label>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-1">Estado Reproductivo:</label>
                            <div class="flex items-center gap-4">
                                <label><input type="radio" name="reproductiveStatus" value="Entero" class="form-radio"> Entero</label>
                                <label><input type="radio" name="reproductiveStatus" value="Castrado" class="form-radio"> Castrado</label>
                                <label><input type="radio" name="reproductiveStatus" value="Esterilizada" class="form-radio"> Esterilizada</label>
                            </div>
                        </div>
                        <div><label for="data-birth-date" class="block text-sm font-medium">Fecha de Nacimiento (Estimada):</label><input type="date" id="data-birth-date"></div>
                        <div><label for="data-age" class="block text-sm font-medium">Edad Actual:</label><input type="text" id="data-age" readonly></div>
                        <div><label for="data-color-markings" class="block text-sm font-medium">Color/Se√±as Particulares:</label><input type="text" id="data-color-markings"></div>
                        <div><label for="data-microchip" class="block text-sm font-medium">Microchip (N¬∞):</label><input type="text" id="data-microchip"></div>
                        <div><label for="data-weight" class="block text-sm font-medium">Peso Actual (kg):</label><input type="text" id="data-weight"></div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-1">Origen:</label>
                            <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                                <label><input type="radio" name="origin" value="Criadero" class="form-radio"> Criadero</label>
                                <label><input type="radio" name="origin" value="Refugio" class="form-radio"> Refugio</label>
                                <label><input type="radio" name="origin" value="Rescate" class="form-radio"> Rescate</label>
                                <label><input type="radio" name="origin" value="Particular" class="form-radio"> Particular</label>
                                <label class="flex items-center gap-2"><input type="radio" name="origin" value="Otro" class="form-radio"> Otro: <input type="text" id="data-origin-other" class="p-1 text-sm"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end items-center gap-4">
                    <button type="submit" class="btn-primary px-6 py-3 rounded-lg text-lg font-bold">Guardar Datos</button>
                </div>
            </form>
        </div>

        <!-- ===== Vista de Recetario ===== -->
        <div id="view-prescription" class="view">
            <header class="flex justify-between items-center mb-4 no-print">
                 <h1 class="text-3xl font-bold text-accent-dark">Generar Receta</h1>
                <button class="back-to-hub-btn-from-rx bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">‚Üê Volver a Ficha</button>
            </header>
            <div id="prescription-content" class="bg-white p-8 rounded-xl shadow-lg">
                <header class="text-center pb-4 border-b-2 border-gray-100">
                    <img src="logo1.png" alt="Logo" class="w-40 h-auto mx-auto mb-4">
                    <h1 class="text-2xl font-bold text-accent-dark">Dra. Alejandra Caut√≠n Bast√≠as</h1>
                    <p class="text-gray-500">M√©dica Veterinaria</p>
                    <p class="text-xs italic mt-2">"Cuidar no es solo curar, es acompa√±ar con conciencia."</p>
                </header>
                
                <div class="my-6 p-4 bg-gray-50 rounded-lg no-print">
                    <label for="rx-email" class="block text-sm font-medium mb-1">Correo del Tutor para env√≠o:</label>
                    <div class="flex items-center gap-2">
                        <input type="email" id="rx-email" placeholder="correo@ejemplo.com" class="w-full">
                        <button type="button" id="send-email-btn" class="btn-tertiary px-4 py-2 rounded-lg font-semibold text-sm">Enviar</button>
                    </div>
                </div>

                <section class="my-6 p-4 bg-gray-50 rounded-lg">
                    <h2 class="text-xl font-bold text-accent-dark mb-4 text-center">Recetario Terap√©utico Personalizado</h2>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div><strong>N¬∫ Ficha:</strong> <span id="rx-ficha-id"></span></div>
                        <div><strong>Tutor Responsable:</strong> <span id="rx-tutor-name"></span></div>
                        <div><strong>Paciente:</strong> <span id="rx-patient-name" class="capitalize"></span></div>
                        <div><strong>RUT:</strong> <span id="rx-tutor-rut"></span></div>
                        <div><strong>Especie:</strong> <span id="rx-species"></span></div>
                        <div><strong>Fecha:</strong> <span id="rx-date"></span></div>
                        <div><strong>Raza:</strong> <span id="rx-breed"></span></div>
                        <div><strong>Edad:</strong> <span id="rx-age"></span></div>
                    </div>
                </section>

                <p class="text-sm text-gray-600 my-6 text-center">Este recetario fue elaborado de forma personalizada tras la evaluaci√≥n cl√≠nica de su mascota. Cada indicaci√≥n fue explicada detalladamente. Ante cualquier duda, <strong>no modifique la dosis ni el tratamiento sin consultar previamente</strong>.</p>
                
                <form id="prescription-form">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-accent-dark mb-2 border-b pb-1">Tratamiento Indicado</h3>
                        <textarea id="rx-treatment-notes" rows="10" class="w-full p-2 border rounded-lg" placeholder="Medicamento, dosis, frecuencia..."></textarea>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-accent-dark mb-2 border-b pb-1">Indicaciones Adicionales</h3>
                        <textarea id="rx-indications-notes" rows="6" class="w-full p-2 border rounded-lg" placeholder="Dieta, cuidados, pr√≥ximo control..."></textarea>
                    </div>

                    <div class="my-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-bold text-accent-dark mb-2">¬øQu√© hacer si...?</h3>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>Olvida una dosis:</strong> Admin√≠strela tan pronto lo recuerde, a menos que ya sea casi la hora de la siguiente. En ese caso, omita la dosis olvidada y contin√∫e con el horario regular. <strong>Nunca duplique la dosis.</strong></li>
                            <li><strong>Su mascota vomita la medicina:</strong> No repita la dosis sin consultar. Anote la hora y el medicamento y contacte a su veterinario.</li>
                            <li><strong>Nota efectos secundarios:</strong> Observe los s√≠ntomas (ej: letargo, diarrea, picaz√≥n) y contacte a su veterinario de inmediato.</li>
                        </ul>
                    </div>

                    <footer class="text-center mt-8 pt-8 border-t">
                        <p class="text-sm italic text-gray-600 mb-4">Cuidar es un viaje, no un destino. Si necesita orientaci√≥n, cuente conmigo.</p>
                        <div class="text-xs text-gray-500 mb-8 space-y-1">
                            <p>üìû <strong>WhatsApp:</strong> +56 9 7604 0797</p>
                            <p>üìß <strong>Correo:</strong> avmveterinaria@gmail.com</p>
                            <p>üì∏ <strong>Instagram:</strong> @AleVeterinaria | Santiago, Chile</p>
                        </div>
                        <div class="grid grid-cols-2 gap-8 text-left mt-12">
                            <div>
                                <p class="font-bold text-gray-700 mb-2">Timbre M√©dico:</p>
                                <div class="h-24 border border-gray-300 border-dashed rounded-md flex items-center justify-center">
                                    <img id="rx-timbre" src="timbre.png" alt="Timbre M√©dico" class="max-h-full max-w-full object-contain p-2">
                                </div>
                            </div>
                            <div>
                                <p class="font-bold text-gray-700 mb-2">Firma del M√©dico:</p>
                                <div class="h-24 border-b-2 border-gray-500 flex flex-col justify-end items-center">
                                    <p class="font-semibold">Dra. Alejandra Caut√≠n Bast√≠as</p>
                                </div>
                            </div>
                        </div>
                    </footer>
                    <div class="flex justify-end items-center gap-4 mt-8 no-print">
                        <button type="button" id="download-pdf-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Descargar PDF</button>
                        <button type="submit" class="btn-primary px-5 py-2 rounded-lg font-semibold">Guardar Receta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="notification-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50"></div>
    <div id="consultation-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 overflow-y-auto p-4"></div>
    <div id="vaccine-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 overflow-y-auto p-4"></div>
    <div id="deworming-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 overflow-y-auto p-4"></div>
    <div id="exam-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 overflow-y-auto p-4"></div>
    <div id="certificate-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 overflow-y-auto p-4"></div>
    
    <script type="module">
        // --- App State ---
        let currentPatientId = null;

        // --- DOM Elements ---
        const views = {
            dashboard: document.getElementById('view-dashboard'),
            patientHub: document.getElementById('view-patient-hub'),
            editPatientData: document.getElementById('view-edit-patient-data'),
            prescription: document.getElementById('view-prescription'),
        };
        const modals = { 
            notification: document.getElementById('notification-modal'),
            consultation: document.getElementById('consultation-modal'),
            vaccine: document.getElementById('vaccine-modal'),
            deworming: document.getElementById('deworming-modal'),
            exam: document.getElementById('exam-modal'),
            certificate: document.getElementById('certificate-modal'),
        };
        
        // --- Navigation & Modals ---
        function navigateTo(viewName, patientId = null) {
            currentPatientId = patientId;
            Object.values(views).forEach(v => v.classList.remove('active'));
            if (views[viewName]) views[viewName].classList.add('active');
        }
        function showModal(modalName) { if(modals[modalName]) modals[modalName].classList.add('active'); }
        function hideModal(modalName) { if(modals[modalName]) modals[modalName].classList.remove('active'); }

        function showNotification(message) {
            modals.notification.innerHTML = `<div class="bg-white rounded-xl shadow-xl p-8 m-4 max-w-sm text-center"><p class="text-lg text-gray-700">${message}</p><button id="notification-close-btn" class="mt-6 btn-secondary text-white px-5 py-2 rounded-lg font-semibold">Cerrar</button></div>`;
            showModal('notification');
            document.getElementById('notification-close-btn').addEventListener('click', () => hideModal('notification'));
        }

        // --- Patient Hub Logic ---
        async function openPatientHub(patientId) {
            navigateTo('patientHub', patientId);
            const { doc, getDoc } = window.firebase;
            const db = window.db;
            const docRef = doc(db, "patients", patientId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('hub-patient-name').textContent = data.name || 'Paciente sin nombre';
                document.getElementById('hub-patient-id').textContent = `N¬∫ Ficha: ${patientId}`;
                
                document.getElementById('hub-patient-summary').innerHTML = `
                    <p><strong>Especie:</strong> ${data.species || 'N/A'}</p>
                    <p><strong>Raza:</strong> ${data.breed || 'N/A'}</p>
                    <p><strong>Edad:</strong> ${data.age || 'N/A'}</p>
                    <p><strong>Sexo:</strong> ${data.sex || 'N/A'}</p>
                    <p><strong>Estado Reproductivo:</strong> ${data.reproductiveStatus || 'N/A'}</p>
                    <p><strong>Peso:</strong> ${data.weight || 'N/A'} kg</p>
                `;
                document.getElementById('hub-tutor-summary').innerHTML = `
                    <p><strong>Nombre:</strong> ${data.tutorName || 'N/A'}</p>
                    <p><strong>Email:</strong> ${data.tutorEmail || 'N/A'}</p>
                    <p><strong>Celular:</strong> ${data.tutorPhone || 'N/A'}</p>
                `;
                loadConsultationHistory(patientId);
            }
        }
        
        // --- New Modal Openers ---
        function openModalByName(modalName) {
            const modal = modals[modalName];
            if (!modal) return;
            
            if (modalName === 'consultation') {
                modal.innerHTML = `...`; // Consultation form HTML
                showModal('consultation');
                modal.querySelector('form').addEventListener('submit', saveNewConsultation);
                modal.querySelector('#cancel-consultation-btn').addEventListener('click', () => hideModal('consultation'));
            } else if (modalName === 'vaccine') {
                modal.innerHTML = `...`; // Vaccine form HTML
                showModal('vaccine');
                // Add vaccine-specific event listeners
            } // ... and so on for other modals
        }

        // --- The rest of the JS logic will be updated to handle the new modals and data structures ---
        
        // --- Search Logic ---
        async function searchPatients() {
            const { getDocs, collection, query, where, doc, getDoc } = window.firebase;
            const db = window.db;
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) return;
            const searchResultsEl = document.getElementById('search-results');
            searchResultsEl.innerHTML = '<p>Buscando...</p>';
            let results = [];
            try {
                const docRef = doc(db, "patients", searchTerm);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    results.push({ id: docSnap.id, ...docSnap.data() });
                }
                const q = query(collection(db, "patients"), where("name", "==", searchTerm.toLowerCase()));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    if (!results.some(r => r.id === doc.id)) {
                        results.push({ id: doc.id, ...doc.data() });
                    }
                });
            } catch(e) { console.error(e); }
            displaySearchResults(results);
        }

        function displaySearchResults(patients) {
            const searchResultsEl = document.getElementById('search-results');
            searchResultsEl.innerHTML = patients.length === 0 ? '<p>No se encontraron pacientes.</p>' : '';
            const list = document.createElement('ul');
            list.className = 'space-y-2';
            patients.forEach(patient => {
                const item = document.createElement('li');
                item.className = 'p-3 border rounded-lg flex justify-between items-center';
                item.innerHTML = `<span class="capitalize font-semibold text-gray-700">${patient.name} <span class="text-sm text-gray-500 font-normal">(${patient.id})</span></span>`;
                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'Ver Ficha';
                viewBtn.className = 'btn-secondary text-white px-3 py-1 text-sm rounded-md font-semibold';
                viewBtn.onclick = () => openPatientHub(patient.id);
                item.appendChild(viewBtn);
                list.appendChild(item);
            });
            searchResultsEl.appendChild(list);
        }

        // --- Initial Load & Event Listeners ---
        document.getElementById('search-btn').addEventListener('click', searchPatients);
        document.getElementById('search-input').addEventListener('keyup', e => e.key === 'Enter' && searchPatients());
        document.getElementById('new-patient-btn').addEventListener('click', () => openPatientDataForm(null));
        document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => btn.addEventListener('click', () => navigateTo('dashboard')));
        document.getElementById('edit-patient-data-btn').addEventListener('click', () => openPatientDataForm(currentPatientId));
        document.getElementById('back-to-hub-btn').addEventListener('click', () => openPatientHub(currentPatientId));
        document.getElementById('go-to-prescription-btn').addEventListener('click', () => openPrescriptionView(currentPatientId));
        document.querySelector('.back-to-hub-btn-from-rx').addEventListener('click', () => openPatientHub(currentPatientId));

        document.querySelectorAll('#action-buttons button[data-modal]').forEach(button => {
            button.addEventListener('click', () => openModalByName(button.dataset.modal));
        });

        navigateTo('dashboard');
    </script>
</body>
</html>
