<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ale Veterinaria | Cuidado a Domicilio en Santiago</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBrYOiaa_skDuvRDD_zMZvUBknfwmTyDko",
          authDomain: "ale-veterinaria.firebaseapp.com",
          projectId: "ale-veterinaria",
          storageBucket: "ale-veterinaria.appspot.com",
          messagingSenderId: "87862276548",
          appId: "1:87862276548:web:a55b3154a31e4c6948b491",
          measurementId: "G-PNKMJC92K3"
        };
        
        // --- Firebase Initialization ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, runTransaction, orderBy, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const storage = getStorage(app);
            // Make Firebase services globally available
            window.db = db;
            window.auth = auth;
            window.storage = storage;
            window.firebase = { 
                collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, 
                runTransaction, orderBy, addDoc, deleteDoc, updateDoc, signInWithEmailAndPassword, 
                onAuthStateChanged, signOut, ref, uploadBytes, getDownloadURL
            };
        } catch (e) {
            console.error("Firebase initialization error.", e);
        }
    </script>
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Custom Styles -->
    <style>
        :root {
            --color-background: #F9F5EF; /* Beige claro */
            --color-surface: #FFFFFF;
            --color-primary: #a3b2cc; /* Lavanda suave */
            --color-secondary: #cce2d8; /* Menta suave */
            --color-accent: #CFEDEC;
            --color-highlight: #DAD4E6;
            --text-main: #4B4B4B;
            --text-muted: #7C7C75;
            --text-contrast: #FFFFFF;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--text-main); }
        h1, h2, h3, button, .font-poppins { font-family: 'Poppins', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        
        .btn-primary { background-color: var(--color-primary); color: var(--text-main); transition: all 0.3s; }
        .btn-primary:hover { background-color: #8f9db8; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-secondary { background-color: transparent; color: var(--text-main); border: 2px solid var(--color-primary); transition: all 0.3s; }
        .btn-secondary:hover { background-color: var(--color-primary); color: var(--text-main); }
        
        .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
        details[open] .accordion-body { max-height: 1000px; padding-top: 1rem; }
        details summary::-webkit-details-marker { display: none; }

        .nav-link.active { color: var(--color-primary); font-weight: 600; }

        .btn-tertiary { background-color: var(--color-accent); color: var(--text-main); transition: background-color 0.3s; }
        .btn-tertiary:hover { background-color: #BDE6E5; }
        .btn-danger { background-color: #EF4444; color: white; transition: background-color 0.3s; }
        .btn-danger:hover { background-color: #DC2626; }
        input, textarea, select { border: 1px solid #CBD5E0; border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: border-color 0.2s, box-shadow 0.2s; width: 100%;}
        input:focus, textarea:focus, select:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(163, 178, 204, 0.3); outline: none; }
        .hub-section-btn.active-hub-btn, .tutor-portal-btn.active { background-color: var(--color-primary); color: var(--text-main); }
    </style>
</head>
<body class="antialiased">

    <!-- ===== Public View ===== -->
    <div id="view-landing" class="view active">
        <div class="min-h-screen bg-[var(--color-surface)]">
            <nav class="bg-[var(--color-surface)] shadow-sm sticky top-0 z-40">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <a href="#inicio" class="text-xl font-bold font-poppins text-[var(--text-main)]">Ale Veterinaria</a>
                        <div class="hidden md:flex items-center space-x-8" id="desktop-nav">
                            <a href="#quien-soy" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Quién soy</a>
                            <a href="#servicios" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Servicios</a>
                            <a href="#agenda" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Agendar</a>
                            <a href="#contacto" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Contacto</a>
                        </div>
                        <div class="flex items-center gap-4">
                             <button id="show-tutor-portal-modal-btn-nav" class="btn-secondary px-4 py-2 rounded-lg font-semibold text-sm">Portal Tutor</button>
                             <button id="mobile-menu-btn" class="md:hidden ml-4 text-[var(--text-muted)] hover:text-[var(--text-main)]">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="mobile-menu" class="md:hidden hidden bg-[var(--color-surface)] border-t">
                    <a href="#quien-soy" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Quién soy</a>
                    <a href="#servicios" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Servicios</a>
                    <a href="#agenda" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Agenda</a>
                    <a href="#contacto" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Contacto</a>
                    <button id="show-tutor-portal-modal-btn-mobile" class="w-full text-left block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Portal de Tutores</button>
                </div>
            </nav>
            
            <main id="public-main-content">
                <section id="inicio" class="relative min-h-[calc(100vh-4rem)] flex items-center bg-[var(--color-background)]">
                    <div class="absolute inset-0 bg-cover bg-center z-0 opacity-30" style="background-image: url('https://images.unsplash.com/photo-1548199973-03cce0bbc87b?q=80&w=2069&auto=format&fit=crop');"></div>
                    <div class="absolute inset-0 bg-gradient-to-r from-[var(--color-background)] via-[var(--color-background)]/90 to-transparent z-0"></div>
                    <div class="relative max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 z-10 w-full">
                        <div class="max-w-xl text-left">
                            <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-main)] font-poppins leading-tight">Cuidar con respeto.<br>Acompañar con conciencia.</h1>
                            <p class="mt-6 text-lg text-[var(--text-muted)] max-w-lg">Veterinaria a domicilio en Santiago. Atención cálida, responsable y sin apuro para el bienestar de tu compañero de vida.</p>
                            <div class="mt-10 flex flex-col sm:flex-row items-start gap-4">
                                <a href="#agenda" class="nav-link btn-primary px-8 py-3 rounded-lg font-semibold text-lg text-center shadow-lg">Agendar visita</a>
                                <button id="show-tutor-portal-modal-btn-hero" class="btn-secondary px-6 py-3 rounded-lg font-semibold text-center text-sm">¿Ya eres paciente?</button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section id="quien-soy" class="py-20 bg-[var(--color-surface)]">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 grid md:grid-cols-3 gap-12 items-center">
                        <div class="md:col-span-1">
                            <img src="https://placehold.co/400x400/F7DCDC/4B4B4B?text=Dra.+Alejandra" alt="Foto de Dra. Alejandra" class="rounded-full shadow-xl mx-auto w-64 h-64 md:w-full md:h-auto object-cover">
                        </div>
                        <div class="md:col-span-2">
                            <h2 class="text-3xl font-bold text-[var(--text-main)] font-poppins mb-4">Dra. Alejandra Cautín Bastias</h2>
                            <p class="text-[var(--text-muted)] mb-6 text-base leading-relaxed">Hola, soy Alejandra. Médica Veterinaria, mamá perruna y gatuna, y una enamorada de ese lazo tan profundo que creamos con nuestros animales. Mi misión es cuidarlos con respeto, calma y cariño, tal como me gustaría que cuiden a los míos. Después de años en clínicas, entendí que la medicina necesita más tiempo, más contención y menos apuro. Por eso hoy acompaño desde el hogar, donde cada perro y gato puede sentirse seguro, sin miedo, sin jaulas, sin estrés. Trabajo con un enfoque preventivo e integrativo, poniendo atención no solo a su cuerpo, sino también a su bienestar emocional. Mi propósito es estar presente en cada etapa: desde que llega un cachorro a casa, hasta ese último respiro que nos rompe el alma.</p>
                            <blockquote class="border-l-4 border-[var(--color-primary)] pl-4 italic text-lg text-[var(--text-main)]">
                                "Acompaño desde el cuidado consciente, respetando la conexión sagrada entre tutor y animal."
                            </blockquote>
                        </div>
                    </div>
                </section>

                <section id="servicios" class="py-20 bg-[var(--color-background)]">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-3xl font-bold text-center text-[var(--text-main)] font-poppins mb-12">Mis Servicios</h2>
                        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-8">
                            <div class="bg-[var(--color-surface)] p-8 rounded-xl shadow-lg text-center flex flex-col items-center transition hover:shadow-xl hover:-translate-y-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-[var(--color-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" /></svg>
                                <h3 class="font-bold text-xl text-[var(--text-main)] mb-2 mt-4">Consulta a Domicilio</h3>
                                <p class="text-[var(--text-muted)] text-sm">Evaluación integral en un ambiente seguro y tranquilo para tu mascota.</p>
                            </div>
                            <div class="bg-[var(--color-surface)] p-8 rounded-xl shadow-lg text-center flex flex-col items-center transition hover:shadow-xl hover:-translate-y-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-[var(--color-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" /><path d="M5.707 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L12 5.414l-2.293 2.293a1 1 0 01-1.414 0z" /></svg>
                                <h3 class="font-bold text-xl text-[var(--text-main)] mb-2 mt-4">Vacunación y Desparasitación</h3>
                                <p class="text-[var(--text-muted)] text-sm">Planes preventivos actualizados para proteger a tu compañero de vida.</p>
                            </div>
                             <div class="bg-[var(--color-surface)] p-8 rounded-xl shadow-lg text-center flex flex-col items-center transition hover:shadow-xl hover:-translate-y-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-[var(--color-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 12L3 12m4 4l4-4m6 4v-4m0 4l4-4m-4 4l-4-4" /></svg>
                                <h3 class="font-bold text-xl text-[var(--text-main)] mb-2 mt-4">Toma de Exámenes</h3>
                                <p class="text-[var(--text-muted)] text-sm">Toma de muestras de sangre y orina para análisis en laboratorio.</p>
                            </div>
                            <div class="bg-[var(--color-surface)] p-8 rounded-xl shadow-lg text-center flex flex-col items-center transition hover:shadow-xl hover:-translate-y-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-[var(--color-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
                                <h3 class="font-bold text-xl text-[var(--text-main)] mb-2 mt-4">Implantación de Microchip</h3>
                                <p class="text-[var(--text-muted)] text-sm">Registro e identificación oficial de tu mascota de forma segura.</p>
                            </div>
                            <div class="bg-[var(--color-surface)] p-8 rounded-xl shadow-lg text-center flex flex-col items-center transition hover:shadow-xl hover:-translate-y-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-[var(--color-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                <h3 class="font-bold text-xl text-[var(--text-main)] mb-2 mt-4">Certificados de Salud</h3>
                                <p class="text-[var(--text-muted)] text-sm">Emisión de documentos necesarios para viajes y otros trámites.</p>
                            </div>
                            <div class="bg-[var(--color-surface)] p-8 rounded-xl shadow-lg text-center flex flex-col items-center transition hover:shadow-xl hover:-translate-y-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-[var(--color-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                                <h3 class="font-bold text-xl text-[var(--text-main)] mb-2 mt-4">Seguimiento y Asesorías</h3>
                                <p class="text-[var(--text-muted)] text-sm">Acompañamiento en tratamientos y orientación en bienestar emocional.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="agenda" class="py-20 bg-[var(--color-surface)]">
                    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                        <h2 class="text-3xl font-bold text-[var(--text-main)] font-poppins mb-6">Agenda una visita</h2>
                        <p class="text-[var(--text-muted)] mb-8 max-w-2xl mx-auto">Comienza ingresando tu RUT para buscar tus datos. Si eres un nuevo tutor, ¡no te preocupes! Podrás completar tu información a continuación.</p>
                        
                        <form id="agenda-form" class="space-y-4 text-left bg-white p-8 rounded-lg shadow-md">
                            <div>
                                <label for="agenda-tutor-rut" class="block text-sm font-medium text-[var(--text-muted)]">RUT del tutor</label>
                                <input type="text" id="agenda-tutor-rut" required class="mt-1" placeholder="Ej: 12.345.678-9">
                                <div id="agenda-rut-validation-message" class="text-red-500 text-xs mt-1"></div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label for="agenda-tutor-name" class="block text-sm font-medium text-[var(--text-muted)]">Nombre completo del tutor</label>
                                    <input type="text" id="agenda-tutor-name" required class="mt-1">
                                </div>
                                <div>
                                    <label for="agenda-tutor-commune" class="block text-sm font-medium text-[var(--text-muted)]">Comuna</label>
                                    <input type="text" id="agenda-tutor-commune" required class="mt-1">
                                </div>
                            </div>
                            
                            <div id="agenda-pet-selection-container" class="pt-4 border-t hidden">
                                <p class="font-semibold mb-2 text-center">Selecciona tu mascota</p>
                                <div id="existing-pets-list" class="space-y-2"></div>
                                <div id="new-patient-fields" class="hidden space-y-4 mt-4">
                                    <p class="font-semibold text-center">Datos de tu nueva mascota</p>
                                    <input type="text" id="agenda-pet-name" placeholder="Nombre de la mascota" required class="mt-1">
                                </div>
                            </div>

                            <div class="pt-4 text-center">
                                <button type="submit" class="btn-primary inline-block px-10 py-3 rounded-lg font-semibold text-lg shadow-lg">Continuar a agendamiento</button>
                            </div>
                        </form>
                    </div>
                </section>

                <section id="recursos" class="py-20 bg-[var(--color-background)]">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 grid md:grid-cols-5 gap-12">
                        <div class="md:col-span-3">
                            <h3 class="text-2xl font-bold text-center md:text-left text-[var(--text-main)] font-poppins mb-8">Preguntas Frecuentes</h3>
                            <div class="space-y-4">
                                <details class="group bg-white p-4 rounded-lg shadow-sm">
                                    <summary class="font-semibold cursor-pointer list-none flex justify-between items-center text-[var(--text-main)]">
                                        ¿Qué comunas de Santiago atiendes?
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                    </summary>
                                    <div class="accordion-body">
                                        <p class="text-[var(--text-muted)]">Atiendo principalmente en las comunas del sector oriente de Santiago (Las Condes, Vitacura, Lo Barnechea, Providencia, Ñuñoa). Si vives en otra comuna, contáctame para confirmar si tu dirección está dentro de mi zona de cobertura.</p>
                                    </div>
                                </details>
                                <details class="group bg-white p-4 rounded-lg shadow-sm">
                                    <summary class="font-semibold cursor-pointer list-none flex justify-between items-center text-[var(--text-main)]">
                                        ¿Qué hago en una emergencia?
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                    </summary>
                                    <div class="accordion-body">
                                        <p class="text-[var(--text-muted)]">Mi servicio es de atención programada y no de urgencia. En caso de una emergencia vital (ej: atropello, intoxicación, dificultad respiratoria severa), te recomiendo acudir a la clínica de urgencias 24 horas más cercana para una atención inmediata.</p>
                                    </div>
                                </details>
                                <details class="group bg-white p-4 rounded-lg shadow-sm">
                                    <summary class="font-semibold cursor-pointer list-none flex justify-between items-center text-[var(--text-main)]">
                                        ¿Cuál es el valor de la consulta?
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                    </summary>
                                    <div class="accordion-body">
                                        <p class="text-[var(--text-muted)]">El valor de la consulta a domicilio varía según la comuna. Por favor, contáctame por WhatsApp para darte el valor exacto para tu ubicación. Los procedimientos y medicamentos tienen un costo adicional.</p>
                                    </div>
                                </details>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                             <h3 class="text-2xl font-bold text-center md:text-left text-[var(--text-main)] font-poppins mb-8">Recursos Educativos</h3>
                             <div class="space-y-4">
                                <a href="#" class="block border border-gray-200 bg-white rounded-lg p-4 flex items-center gap-4 transition hover:shadow-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[var(--color-primary)] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                    <div>
                                        <h4 class="font-bold text-[var(--text-main)]">Guía de Primeros Auxilios</h4>
                                        <p class="text-sm text-[var(--text-muted)]">Un PDF práctico con lo esencial.</p>
                                    </div>
                                </a>
                                <a href="#" class="block border border-gray-200 bg-white rounded-lg p-4 flex items-center gap-4 transition hover:shadow-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[var(--color-primary)] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                                    <div>
                                        <h4 class="font-bold text-[var(--text-main)]">Alimentación Natural</h4>
                                        <p class="text-sm text-[var(--text-muted)]">Artículo sobre dieta BARF.</p>
                                    </div>
                                </a>
                             </div>
                        </div>
                    </div>
                </section>

                <section id="homenaje" class="py-20 bg-[var(--color-surface)]">
                    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                        <h2 class="text-3xl font-bold text-[var(--text-main)] font-poppins mb-4">Huella Eterna</h2>
                        <p class="text-[var(--text-muted)] mb-12 max-w-2xl mx-auto">Un espacio para recordar con amor a aquellos que dejaron una marca imborrable en nuestras vidas. Su luz nunca se apaga.</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-8">
                            <div class="text-center">
                                <img src="https://placehold.co/200x200/DAD4E6/4B4B4B?text=Rocky" class="rounded-full w-32 h-32 mx-auto shadow-md object-cover">
                                <h4 class="mt-4 font-semibold text-[var(--text-main)]">Rocky</h4>
                                <p class="text-xs text-gray-500 italic">"Siempre en nuestros corazones."</p>
                            </div>
                            <div class="text-center">
                                <img src="https://placehold.co/200x200/cce2d8/4B4B4B?text=Luna" class="rounded-full w-32 h-32 mx-auto shadow-md object-cover">
                                <h4 class="mt-4 font-semibold text-[var(--text-main)]">Luna</h4>
                                <p class="text-xs text-gray-500 italic">"Gracias por tanta alegría."</p>
                            </div>
                            <div class="text-center">
                                <img src="https://placehold.co/200x200/F9F5EF/4B4B4B?text=Max" class="rounded-full w-32 h-32 mx-auto shadow-md object-cover">
                                <h4 class="mt-4 font-semibold text-[var(--text-main)]">Max</h4>
                                <p class="text-xs text-gray-500 italic">"Compañero fiel."</p>
                            </div>
                            <div class="text-center">
                                <img src="https://placehold.co/200x200/a3b2cc/FFFFFF?text=Mila" class="rounded-full w-32 h-32 mx-auto shadow-md object-cover">
                                <h4 class="mt-4 font-semibold text-[var(--text-main)]">Mila</h4>
                                <p class="text-xs text-gray-500 italic">"Te extrañamos cada día."</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="contacto" class="py-20 bg-[var(--color-background)]">
                    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                        <h2 class="text-3xl font-bold text-[var(--text-main)] font-poppins mb-10">Hablemos</h2>
                        <div class="flex flex-col md:flex-row justify-center items-center gap-8 md:gap-12">
                            <a href="https://wa.me/56976040797" target="_blank" class="text-center group">
                                <div class="bg-white p-5 rounded-full inline-block group-hover:scale-110 group-hover:shadow-lg transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.839 8.839 0 01-4.43-1.232l-2.148.862.92-2.093A8.958 8.958 0 012 10c0-4.418 4.477-8 10-8s8 3.582 8 8zm-4.812-3.248a.75.75 0 00-1.202-.88l-2.36 1.77a.75.75 0 00.33 1.333l4.03-1.343a.75.75 0 00.202-.98zM10 15a.75.75 0 00.75-.75v-4.5a.75.75 0 00-1.5 0v4.5A.75.75 0 0010 15z" clip-rule="evenodd" /></svg>
                                </div>
                                <p class="font-semibold mt-3 text-[var(--text-main)]">WhatsApp</p>
                                <p class="text-sm text-[var(--text-muted)]">(Sólo mensajes)</p>
                            </a>
                            <a href="mailto:avmveterinaria@gmail.com" class="text-center group">
                                <div class="bg-white p-5 rounded-full inline-block group-hover:scale-110 group-hover:shadow-lg transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                                </div>
                                <p class="font-semibold mt-3 text-[var(--text-main)]">Email</p>
                                <p class="text-sm text-[var(--text-muted)]">avmveterinaria@gmail.com</p>
                            </a>
                            <a href="https://instagram.com/AleVeterinaria" target="_blank" class="text-center group">
                                <div class="bg-white p-5 rounded-full inline-block group-hover:scale-110 group-hover:shadow-lg transition-all">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-pink-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM5.5 8.5a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /><path d="M10 14a4 4 0 100-8 4 4 0 000 8z" /></svg>
                                </div>
                                <p class="font-semibold mt-3 text-[var(--text-main)]">Instagram</p>
                                <p class="text-sm text-[var(--text-muted)]">@AleVeterinaria</p>
                            </a>
                        </div>
                         <div class="mt-12 text-sm text-[var(--text-muted)] border-t pt-6 max-w-md mx-auto">
                            <p><strong>Zona de atención:</strong> Principalmente sector Oriente, Santiago.</p>
                            <p><strong>Horario:</strong> Lunes a Viernes de 9:00 a 18:00 hrs.</p>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="bg-gray-800 text-white py-8">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-400">
                    <p>&copy; 2024 Dra. Alejandra Cautín Bastias. Todos los derechos reservados.</p>
                    <p class="text-xs mt-2">La información en este sitio es educativa y no reemplaza una consulta veterinaria profesional.</p>
                    <a href="#" id="show-admin-login-link" class="text-xs text-gray-500 hover:text-white mt-4 inline-block">Acceso Profesional</a>
                </div>
            </footer>
        </div>
    </div>

    <!-- ===== Tutor Portal View ===== -->
    <div id="view-tutor-portal" class="view">
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
                <h1 class="text-xl font-bold font-poppins text-[var(--text-main)]">Portal del Tutor</h1>
                <button id="tutor-logout-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold text-sm">Cerrar Sesión</button>
            </div>
        </header>
        <main class="max-w-5xl mx-auto p-4 md:p-8">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h2 id="tutor-welcome-message" class="text-2xl font-bold text-[var(--text-main)] mb-4"></h2>
                <div>
                    <label for="pet-selector" class="block text-sm font-medium text-[var(--text-muted)]">Selecciona tu mascota:</label>
                    <select id="pet-selector" class="mt-1 max-w-xs"></select>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
                <div id="tutor-portal-nav" class="flex flex-wrap gap-2">
                    <button data-section="ficha" class="tutor-portal-btn flex-1 px-3 py-2 rounded-md font-semibold text-sm text-center">Ficha</button>
                    <button data-section="vacunas" class="tutor-portal-btn flex-1 px-3 py-2 rounded-md font-semibold text-sm text-center">Vacunas</button>
                    <button data-section="desparasitacion" class="tutor-portal-btn flex-1 px-3 py-2 rounded-md font-semibold text-sm text-center">Desparasitación</button>
                    <button data-section="recetas" class="tutor-portal-btn flex-1 px-3 py-2 rounded-md font-semibold text-sm text-center">Recetas</button>
                    <button data-section="examenes" class="tutor-portal-btn flex-1 px-3 py-2 rounded-md font-semibold text-sm text-center">Exámenes</button>
                    <button data-section="certificados" class="tutor-portal-btn flex-1 px-3 py-2 rounded-md font-semibold text-sm text-center">Certificados</button>
                </div>
            </div>

            <div id="tutor-portal-content" class="bg-white p-6 rounded-xl shadow-lg min-h-[300px]">
                <!-- Contenido dinámico se insertará aquí -->
            </div>
        </main>
    </div>

    <!-- ===== Admin Application Container ===== -->
    <div id="app-container" class="hidden">
        <header class="bg-[#FFFFFF] shadow-md p-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-[#4A4A4A]">Gestión Clínica Veterinaria</h1>
            <button id="admin-logout-btn" class="btn-danger px-4 py-2 rounded-lg font-semibold">Cerrar Sesión</button>
        </header>
        <div id="admin-app-content" class="max-w-5xl mx-auto p-4 md:p-8">
            <!-- Vistas del Admin se insertarán aquí por JS -->
        </div>
    </div>
    
    <!-- Template for Admin HTML Content -->
    <template id="admin-panel-template">
        <div id="app">
            <!-- ===== Dashboard View ===== -->
            <div id="view-dashboard" class="admin-view">
                <main class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">Buscar Paciente</h2>
                        <div class="flex space-x-2">
                            <input id="search-input" type="text" placeholder="Nº Ficha, Nombre o RUT" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 ring-accent">
                        </div>
                        <div id="search-results" class="mt-4"></div>
                    </div>
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg flex flex-col items-center justify-center">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">Acciones</h2>
                        <button id="new-patient-btn" class="w-full btn-primary py-3 rounded-lg text-lg font-bold shadow-md transform hover:scale-105 transition-transform">+ Crear Ficha de Paciente</button>
                    </div>
                </main>
            </div>
            <!-- All other admin views will be added here dynamically -->
        </div>
    </template>


    <!-- ===== Modals ===== -->
    <div id="login-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md m-4 relative">
            <button id="close-login-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-[var(--text-main)] mb-6">Acceso Profesional</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-[#7F8B96] mb-1">Correo Electrónico</label>
                    <input id="login-email" type="email" required class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-[#7F8B96] mb-1">Contraseña</label>
                    <input id="login-password" type="password" required class="w-full px-4 py-2 border rounded-lg">
                </div>
                <button type="submit" class="w-full bg-[var(--color-primary)] text-white py-3 rounded-lg text-lg font-bold shadow-md">Ingresar</button>
            </form>
        </div>
    </div>
    
    <div id="tutor-login-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md m-4 relative">
            <button id="close-tutor-login-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-[var(--text-main)] mb-6">Portal de Tutores</h2>
            <p class="text-center text-sm text-[var(--text-muted)] mb-4">Ingresa tu RUT para ver la información de tus mascotas.</p>
            <form id="tutor-login-form">
                <div class="mb-4">
                    <label for="tutor-login-rut" class="block text-sm font-medium text-[#7F8B96] mb-1">RUT</label>
                    <input id="tutor-login-rut" type="text" required placeholder="12.345.678-9" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <button type="submit" class="w-full bg-[var(--color-primary)] text-white py-3 rounded-lg text-lg font-bold shadow-md">Ingresar</button>
            </form>
        </div>
    </div>
    
    <!-- Main Application Logic -->
    <script type="module">
        let currentTutorData = null; 
        let allPatientsCache = []; // Cache for admin search

        // --- UTILITY FUNCTIONS ---
        const normalizeText = (text) => {
            if (!text) return '';
            return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        };

        const formatRut = (rut) => {
            if (!rut) return '';
            let cleanRut = rut.replace(/[^0-9kK]/g, '').toUpperCase();
            if (cleanRut.length <= 1) return cleanRut;
            let body = cleanRut.slice(0, -1);
            let dv = cleanRut.slice(-1);
            let formattedBody = body.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return `${formattedBody}-${dv}`;
        };

        const validateRut = (rut) => {
            if (!rut || !/^[0-9]{1,2}\.?[0-9]{3}\.?[0-9]{3}-[0-9kK]{1}$/.test(rut)) return false;
            const cleanRut = rut.replace(/[.-]/g, '');
            let body = cleanRut.slice(0, -1);
            let dv = cleanRut.slice(-1).toUpperCase();
            let sum = 0;
            let multiple = 2;
            for (let i = body.length - 1; i >= 0; i--) {
                sum += multiple * body.charAt(i);
                if (multiple < 7) multiple++;
                else multiple = 2;
            }
            const dvExpected = 11 - (sum % 11);
            const dvCalculated = (dvExpected === 11) ? '0' : (dvExpected === 10) ? 'K' : String(dvExpected);
            return dv === dvCalculated;
        };

        function showModal(modalName) { document.getElementById(modalName).classList.add('active'); }
        function hideModal(modalName) { document.getElementById(modalName).classList.remove('active'); }
        
        // --- PUBLIC PAGE & AGENDA LOGIC ---
        function initializePublicPage() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetElement = document.querySelector(link.getAttribute('href'));
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                        mobileMenu.classList.add('hidden');
                    }
                });
            });

            const agendaRutInput = document.getElementById('agenda-tutor-rut');
            agendaRutInput.addEventListener('input', (e) => e.target.value = formatRut(e.target.value));
            agendaRutInput.addEventListener('blur', findTutorPets);
            document.getElementById('agenda-form').addEventListener('submit', handleAgendaSubmit);
        }

        async function findTutorPets() {
            const rutInput = document.getElementById('agenda-tutor-rut');
            const nameInput = document.getElementById('agenda-tutor-name');
            const communeInput = document.getElementById('agenda-tutor-commune');
            const petSelectionContainer = document.getElementById('agenda-pet-selection-container');
            const existingPetsList = document.getElementById('existing-pets-list');
            const newPatientFields = document.getElementById('new-patient-fields');

            const cleanRut = rutInput.value.replace(/[.-]/g, '');
            if (!validateRut(rutInput.value)) return;

            const { getDocs, collection, query, where } = window.firebase;
            const db = window.db;
            const q = query(collection(db, "patients"), where("tutorRut", "==", cleanRut));
            const querySnapshot = await getDocs(q);

            petSelectionContainer.classList.remove('hidden');
            existingPetsList.innerHTML = '';
            newPatientFields.classList.add('hidden');

            if (!querySnapshot.empty) {
                const pets = [];
                querySnapshot.forEach(doc => pets.push({ id: doc.id, ...doc.data() }));

                nameInput.value = pets[0].tutorName || '';
                communeInput.value = pets[0].tutorCity || '';

                pets.forEach((pet, index) => {
                    const div = document.createElement('div');
                    div.innerHTML = `<label class="flex items-center"><input type="radio" name="agenda-pet" value="${pet.name}" class="form-radio mr-2" ${index === 0 ? 'checked' : ''}> <span class="capitalize">${pet.name}</span> (${pet.species})</label>`;
                    existingPetsList.appendChild(div);
                });

                const newPetOption = document.createElement('div');
                newPetOption.innerHTML = `<label class="flex items-center"><input type="radio" name="agenda-pet" value="new" class="form-radio mr-2"> Agregar otra mascota</label>`;
                existingPetsList.appendChild(newPetOption);
                
                existingPetsList.addEventListener('change', (e) => {
                    newPatientFields.classList.toggle('hidden', e.target.value !== 'new');
                });

            } else {
                nameInput.value = '';
                communeInput.value = '';
                existingPetsList.innerHTML = '<p class="text-sm text-center text-gray-500">No encontramos mascotas registradas. Por favor, ingresa los datos de tu nuevo compañero.</p>';
                newPatientFields.classList.remove('hidden');
            }
        }

        function handleAgendaSubmit(e) {
            e.preventDefault();
            const tutorName = document.getElementById('agenda-tutor-name').value;
            const tutorRut = document.getElementById('agenda-tutor-rut').value;
            const tutorCommune = document.getElementById('agenda-tutor-commune').value;
            
            let petName = '';
            const selectedPetRadio = document.querySelector('input[name="agenda-pet"]:checked');
            if (selectedPetRadio) {
                petName = selectedPetRadio.value === 'new' ? document.getElementById('agenda-pet-name').value : selectedPetRadio.value;
            }

            if (!tutorName || !tutorRut || !petName) {
                alert("Por favor, completa todos los campos requeridos.");
                return;
            }
            
            const calendlyUrl = `https://calendly.com/avmveterinaria?name=${encodeURIComponent(tutorName)}&email=&a1=${encodeURIComponent(tutorRut)}&a2=${encodeURIComponent(petName)}&a3=${encodeURIComponent(tutorCommune)}`;
            window.open(calendlyUrl, '_blank');
        }

        // --- TUTOR PORTAL LOGIC ---
        async function handleTutorLogin(e) {
            e.preventDefault();
            const rutInput = document.getElementById('tutor-login-rut');
            rutInput.value = formatRut(rutInput.value);
            const cleanRut = rutInput.value.replace(/[.-]/g, '');

            if (!validateRut(rutInput.value)) {
                alert("RUT inválido. Por favor, ingrésalo con el formato correcto.");
                return;
            }

            const { getDocs, collection, query, where } = window.firebase;
            const db = window.db;
            const q = query(collection(db, "patients"), where("tutorRut", "==", cleanRut));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("No se encontraron mascotas asociadas a este RUT.");
                return;
            }

            currentTutorData = [];
            querySnapshot.forEach(doc => currentTutorData.push({ id: doc.id, ...doc.data() }));
            loadTutorPortal();
        }

        function loadTutorPortal() {
            document.getElementById('view-landing').classList.remove('active');
            document.getElementById('view-tutor-portal').classList.add('active');
            hideModal('tutor-login-modal');

            document.getElementById('tutor-welcome-message').textContent = `¡Hola, ${currentTutorData[0].tutorName}!`;
            
            const petSelector = document.getElementById('pet-selector');
            petSelector.innerHTML = '';
            currentTutorData.forEach(pet => {
                const option = document.createElement('option');
                option.value = pet.id;
                option.textContent = pet.name;
                petSelector.appendChild(option);
            });

            petSelector.addEventListener('change', () => displayTutorContent(petSelector.value));
            
            document.querySelectorAll('.tutor-portal-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tutor-portal-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    displayTutorContent(petSelector.value);
                });
            });

            document.querySelector('.tutor-portal-btn[data-section="ficha"]').classList.add('active');
            displayTutorContent(petSelector.value);
        }
        
        async function displayTutorContent(patientId) {
            const contentArea = document.getElementById('tutor-portal-content');
            const activeSection = document.querySelector('.tutor-portal-btn.active').dataset.section;
            const petData = currentTutorData.find(p => p.id === patientId);
            
            contentArea.innerHTML = `<p class="text-center p-10">Cargando...</p>`;

            let html = '';
            const { collection, query, getDocs } = window.firebase;
            const db = window.db;

            switch(activeSection) {
                case 'ficha':
                    html = `
                        <h3 class="text-xl font-bold mb-4 capitalize">${petData.name}</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>Especie:</strong> ${petData.species || 'N/A'}</div>
                            <div><strong>Raza:</strong> ${petData.breed || 'N/A'}</div>
                            <div><strong>Sexo:</strong> ${petData.sex || 'N/A'}</div>
                            <div><strong>Nacimiento:</strong> ${petData.birthDate || 'N/A'}</div>
                            <div><strong>Microchip:</strong> ${petData.microchip || 'No posee'}</div>
                        </div>`;
                    break;
                case 'vacunas':
                case 'desparasitacion':
                case 'recetas':
                case 'examenes':
                case 'certificados':
                    const subcollection = activeSection;
                    const q = query(collection(db, "patients", patientId, subcollection));
                    const snapshot = await getDocs(q);
                    html = `<h3 class="text-xl font-bold mb-4 capitalize">${activeSection.replace('-', ' ')}</h3>`;
                    if (snapshot.empty) {
                        html += `<p>No hay registros de ${subcollection}.</p>`;
                    } else {
                        html += `<div class="overflow-x-auto"><table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50"><tr>
                                        <th class="p-2">Fecha</th>
                                        <th class="p-2">Detalle</th>
                                        ${subcollection === 'examenes' ? '<th class="p-2">Archivo</th>' : ''}
                                        ${subcollection === 'vacunas' || subcollection === 'desparasitacion' ? '<th class="p-2">Próxima Dosis</th>' : ''}
                                    </tr></thead><tbody>`;
                        const sortedDocs = snapshot.docs.sort((a, b) => {
                            const dataA = a.data();
                            const dataB = b.data();
                            let timeA = 0;
                            let timeB = 0;
                            if (dataA.date) timeA = new Date(dataA.date).getTime();
                            else if (dataA.createdAt && dataA.createdAt.toMillis) timeA = dataA.createdAt.toMillis();
                            if (dataB.date) timeB = new Date(dataB.date).getTime();
                            else if (dataB.createdAt && dataB.createdAt.toMillis) timeB = dataB.createdAt.toMillis();
                            return timeB - timeA;
                        });
                        sortedDocs.forEach(doc => {
                            const data = doc.data();
                            let detail = data.type || data.product || data.treatment || data.description || data.typeName || 'N/A';
                            let date = data.date || (data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString('es-CL') : 'N/A');
                            html += `<tr class="border-b">
                                        <td class="p-2">${date}</td>
                                        <td class="p-2">${detail}</td>
                                        ${subcollection === 'examenes' ? `<td class="p-2">${data.fileURL ? `<a href="${data.fileURL}" target="_blank" class="text-blue-500 hover:underline">Ver</a>` : 'N/A'}</td>` : ''}
                                        ${subcollection === 'vacunas' || subcollection === 'desparasitacion' ? `<td class="p-2">${data.nextDose || 'N/A'}</td>` : ''}
                                     </tr>`;
                        });
                        html += `</tbody></table></div>`;
                    }
                    break;
            }
            contentArea.innerHTML = html;
        }

        function tutorLogout() {
            currentTutorData = null;
            document.getElementById('view-tutor-portal').classList.remove('active');
            document.getElementById('view-landing').classList.add('active');
        }

        // --- ADMIN PANEL LOGIC ---
        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const { signInWithEmailAndPassword } = window.firebase;
            const auth = window.auth;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideModal('login-modal');
                // onAuthStateChanged will handle showing the admin panel
            } catch (error) {
                console.error("Admin login failed:", error);
                alert("Correo o contraseña incorrectos.");
            }
        }

        async function initializeAdminApp() {
            const adminContent = document.getElementById('admin-app-content');
            if (!adminContent) return;
            
            const template = document.getElementById('admin-panel-template');
            const clone = template.content.cloneNode(true);
            adminContent.innerHTML = '';
            adminContent.appendChild(clone);

            const dashboardView = adminContent.querySelector('#view-dashboard');
            if(dashboardView) dashboardView.classList.add('active');

            // Cache all patients for search
            const { getDocs, collection } = window.firebase;
            const db = window.db;
            const querySnapshot = await getDocs(collection(db, "patients"));
            allPatientsCache = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Add event listeners for the admin panel
            const searchInput = adminContent.querySelector('#search-input');
            if (searchInput) searchInput.addEventListener('input', searchPatients);
            
            // This is where the rest of the original admin functions and listeners would go
            // For example:
            // const newPatientBtn = adminContent.querySelector('#new-patient-btn');
            // if (newPatientBtn) newPatientBtn.addEventListener('click', openPatientDataForm);
        }

        function searchPatients() {
            const searchInput = document.getElementById('search-input');
            const searchResultsEl = document.getElementById('search-results');
            if (!searchInput || !searchResultsEl) return;

            const searchTerm = normalizeText(searchInput.value);
            if (searchTerm.length < 1) {
                searchResultsEl.innerHTML = '';
                return;
            }
            
            const results = allPatientsCache.filter(patient => {
                const normalizedName = normalizeText(patient.name);
                const normalizedTutor = normalizeText(patient.tutorName);
                const normalizedRut = normalizeText(patient.tutorRut);
                const normalizedId = normalizeText(patient.id);

                return normalizedName.includes(searchTerm) || 
                       normalizedTutor.includes(searchTerm) || 
                       normalizedRut.includes(searchTerm) ||
                       normalizedId.includes(searchTerm);
            });

            displaySearchResults(results);
        }

        function displaySearchResults(patients) {
            const searchResultsEl = document.getElementById('search-results');
            searchResultsEl.innerHTML = patients.length === 0 ? '<p>No se encontraron pacientes.</p>' : '';
            const list = document.createElement('ul');
            list.className = 'space-y-2';
            patients.forEach(patient => {
                const item = document.createElement('li');
                item.className = 'p-3 border rounded-lg flex justify-between items-center hover:bg-gray-50';
                item.innerHTML = `<span class="capitalize font-semibold text-gray-700">${patient.name} <span class="text-sm text-gray-500 font-normal">(${patient.id})</span></span>`;
                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'Ver Ficha';
                viewBtn.className = 'btn-tertiary text-xs px-3 py-1 rounded-md font-semibold';
                // This function needs to be defined within the admin scope to work
                // For now, it will log to console to show it's connected
                viewBtn.onclick = () => {
                    alert(`Funcionalidad para abrir ficha de ${patient.name} (ID: ${patient.id}) se debe implementar aquí.`);
                    // openPatientHub(patient.id); 
                };
                list.appendChild(viewBtn);
            });
            searchResultsEl.appendChild(list);
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializePublicPage();
            
            // Tutor Portal Listeners
            document.getElementById('show-tutor-portal-modal-btn-nav').addEventListener('click', () => showModal('tutor-login-modal'));
            document.getElementById('show-tutor-portal-modal-btn-hero').addEventListener('click', () => showModal('tutor-login-modal'));
            document.getElementById('show-tutor-portal-modal-btn-mobile').addEventListener('click', () => showModal('tutor-login-modal'));
            document.getElementById('close-tutor-login-modal-btn').addEventListener('click', () => hideModal('tutor-login-modal'));
            document.getElementById('tutor-login-form').addEventListener('submit', handleTutorLogin);
            document.getElementById('tutor-logout-btn').addEventListener('click', tutorLogout);
            document.getElementById('tutor-login-rut').addEventListener('input', (e) => e.target.value = formatRut(e.target.value));

            // Admin Login Listeners
            document.getElementById('show-admin-login-link').addEventListener('click', (e) => { e.preventDefault(); showModal('login-modal'); });
            document.getElementById('close-login-modal-btn').addEventListener('click', () => hideModal('login-modal'));
            document.getElementById('login-form').addEventListener('submit', handleAdminLogin);

            const { onAuthStateChanged, signOut } = window.firebase;
            const auth = window.auth;
            onAuthStateChanged(auth, user => {
                const appContainer = document.getElementById('app-container');
                const landingView = document.getElementById('view-landing');
                const tutorView = document.getElementById('view-tutor-portal');

                if (user) { // Admin is logged in
                    landingView.classList.remove('active');
                    tutorView.classList.remove('active');
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('active');
                    initializeAdminApp(); 
                    
                    const adminLogoutBtn = document.getElementById('admin-logout-btn');
                    if(adminLogoutBtn) adminLogoutBtn.addEventListener('click', () => signOut(auth));
                } else { // No admin logged in
                    appContainer.classList.add('hidden');
                    appContainer.classList.remove('active');
                    if (!tutorView.classList.contains('active')) {
                        landingView.classList.add('active');
                    }
                }
            });
        });
    </script>
</body>
</html>
