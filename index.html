<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ale Veterinaria - Cuidado a domicilio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <script type="module">
        // --- Firebase Configuration ---
        // Para Firebase JS SDK v7.20.0 y versiones posteriores, measurementId es opcional
        const firebaseConfig = {
          apiKey: "AIzaSyBrYOiaa_skDuvRDD_zMZvUBknfwmTyDko",
          authDomain: "ale-veterinaria.firebaseapp.com",
          projectId: "ale-veterinaria",
          storageBucket: "ale-veterinaria.firebasestorage.app",
          messagingSenderId: "87862276548",
          appId: "1:87862276548:web:a55b3154a31e4c6948b491",
          measurementId: "G-PNKMJC92K3"
        };
        
        // --- Firebase Initialization ---
        // Importe las funciones que necesita desde los SDK que necesita
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getFirestore, collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, runTransaction, orderBy, addDoc, deleteDoc, updateDoc, startAt, endAt } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        
        try {
            // Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const storage = getStorage(app);

            // Hacer que Firebase sea accesible globalmente para otras partes de la aplicación
            window.db = db;
            window.auth = auth;
            window.storage = storage;
            window.analytics = analytics;
            window.firebase = { 
                collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, 
                runTransaction, orderBy, addDoc, deleteDoc, updateDoc, signInWithEmailAndPassword, 
                onAuthStateChanged, signOut, ref, uploadBytes, getDownloadURL, startAt, endAt
            };
        } catch (e) {
            console.error("Firebase initialization error. Please check your firebaseConfig.", e);
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --color-background: #F9F5EF;
            --color-surface: #FFFFFF;
            --color-primary: #A3CBB2; /* Menta suave */
            --color-secondary: #F7DCDC; /* Rosa pálido */
            --color-accent: #CFEDEC; /* Turquesa claro */
            --color-highlight: #DAD4E6; /* Lavanda */
            --text-main: #4B4B4B;
            --text-muted: #7C7C75;
            --text-contrast: #FFFFFF;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--text-main); }
        h1, h2, h3, button, .font-poppins { font-family: 'Poppins', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        
        .btn-primary { background-color: var(--color-primary); color: var(--text-contrast); transition: all 0.3s; transform: translateY(0); }
        .btn-primary:hover { background-color: #8FBBA1; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-secondary { background-color: var(--color-highlight); color: var(--text-main); transition: all 0.3s; transform: translateY(0); }
        .btn-secondary:hover { background-color: #C9C3D9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-tertiary { background-color: var(--color-accent); color: var(--text-main); transition: all 0.3s; transform: translateY(0); }
        .btn-tertiary:hover { background-color: #B8E0DE; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-danger { background-color: #EF4444; color: white; transition: all 0.3s; transform: translateY(0); }
        .btn-danger:hover { background-color: #DC2626; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        input[type="text"], input[type="date"], input[type="time"], input[type="email"], input[type="tel"], input[type="password"], textarea, select { border: 1px solid #CBD5E0; border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: border-color 0.2s, box-shadow 0.2s; width: 100%;}
        input:focus, textarea:focus, select:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(163, 203, 178, 0.3); outline: none; }
        .form-radio, .form-checkbox { color: var(--color-primary); }
        .form-radio:checked, .form-checkbox:checked { background-color: var(--color-primary); border-color: var(--color-primary); }

        .accordion-header { cursor: pointer; padding: 1rem; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s; }
        .accordion-header:hover { background-color: #f3f4f6; }
        .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; padding: 0 1rem; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background-color: var(--color-surface); }
        .accordion-body.expanded { padding: 1.5rem 1rem; max-height: 1500px; }
        .accordion-arrow { transition: transform 0.3s ease-in-out; }
        .accordion-header.active .accordion-arrow { transform: rotate(180deg); }
        
        @media print { 
            .no-print { display: none !important; } 
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        .active-hub-btn { background-color: var(--color-primary) !important; color: white !important; }
        .exam-tab-content { display: none; }
        .exam-tab-content.active { display: block; }
        .exam-tab-btn.active { border-bottom: 2px solid var(--color-primary); color: var(--color-primary); }
    </style>
</head>
<body class="antialiased">

    <div id="view-landing" class="view active">
        <div class="min-h-screen bg-var(--color-background)">
            <nav class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex-shrink-0 flex items-center gap-2"><img src="https://placehold.co/100x40/A3CBB2/FFFFFF?text=Logo" alt="Logo Ale Veterinaria" class="h-8 w-auto"><a href="#inicio" class="text-2xl font-bold text-[var(--text-main)] font-poppins">Ale Veterinaria</a>
</div>
                        <div class="hidden md:flex items-center space-x-8" id="desktop-nav">
                            <a href="#quien-soy" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Quién soy</a>
                            <a href="#servicios" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Servicios</a>
                            <a href="#informacion" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Información</a>
                            <a href="#preguntas" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Preguntas</a>
                            <a href="#contacto" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Contacto</a>
                        </div>
                        <div class="hidden md:flex items-center gap-2">
    <button id="show-tutor-portal-btn-desktop" class="btn-primary px-4 py-2 rounded-lg font-semibold">Portal de Tutores</button>
    <button id="show-login-modal-btn-desktop" class="btn-secondary px-4 py-2 rounded-lg font-semibold">Portal Profesional</button>
</div>
                        <div class="md:hidden">
                            <button id="mobile-menu-btn" class="text-[var(--text-muted)] hover:text-[var(--text-main)]">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="mobile-menu" class="md:hidden hidden bg-white border-t p-4 space-y-2">
                     <a href="#quien-soy" class="block text-center nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Quién soy</a>
                     <a href="#servicios" class="block text-center nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Servicios</a>
                     <a href="#informacion" class="block text-center nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Información</a>
                     <a href="#preguntas" class="block text-center nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Preguntas</a>
                     <a href="#contacto" class="block text-center nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Contacto</a>
                     <button id="show-tutor-portal-btn-mobile" class="w-full btn-primary px-4 py-2 rounded-lg font-semibold">Portal de Tutores</button>
                     <button id="show-login-modal-btn-mobile" class="w-full btn-secondary px-4 py-2 rounded-lg font-semibold">Portal Profesional</button>
                </div>
            </nav>
            
            <main id="public-main-content">
                <section id="inicio" class="min-h-[calc(100vh-4rem)] flex items-center bg-cover bg-center" style="background-image: url('https://placehold.co/1200x800/F9F5EF/4B4B4B?text=Imagen+Cálida+de+Mascota');">
                    <div class="absolute inset-0 bg-[var(--color-background)] opacity-60"></div>
                    <div class="relative max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                        <h1 class="text-4xl md:text-6xl font-bold text-[var(--text-main)] font-poppins leading-tight">Cuidar con respeto,<br>acompañar con conciencia.</h1>
                        <p class="mt-6 text-lg md:text-xl text-[var(--text-muted)]">Veterinaria a domicilio en Santiago. Atención cálida, responsable y sin apuro.</p>
                        <div class="mt-10 flex flex-col sm:flex-row justify-center items-center gap-4">
                            <a href="https://calendly.com/avmveterinaria" target="_blank" class="btn-primary px-8 py-3 rounded-full font-semibold text-lg shadow-lg transform hover:scale-105 transition-transform">Agendar visita</a>
                            <button id="show-tutor-portal-btn" class="font-semibold text-[var(--text-main)] hover:underline">¿Ya eres paciente?</button>
                        </div>
                    </div>
                </section>

                <section id="quien-soy" class="py-20 bg-white">
                     <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 grid md:grid-cols-3 gap-12 items-center">
                        <div class="md:col-span-1">
                            <img src="https://placehold.co/400x400/DAD4E6/4B4B4B?text=Dra.+Ale" alt="Foto de Dra. Alejandra" class="rounded-full shadow-xl mx-auto">
                        </div>
                        <div class="md:col-span-2">
                            <h2 class="text-3xl font-bold text-[var(--text-main)] font-poppins mb-4">Dra. Alejandra Cautín</h2>
                            <p class="text-[var(--text-muted)] mb-4">Soy Médica Veterinaria con un profundo amor por el lazo que nos une a nuestros animales. Mi enfoque es integrativo y respetuoso, entendiendo que cada mascota es un mundo y que su bienestar emocional es tan importante como su salud física. Acompaño a las familias en cada etapa, desde la alegría de un nuevo cachorro hasta el momento sagrado de la despedida, siempre con calma, presencia y todo el corazón.</p>
                            <p class="text-[var(--text-main)] italic text-lg mt-4">"Mi propósito es ser un puente de confianza y tranquilidad entre tú y tu mejor amigo."</p>
                        </div>
                    </div>
                </section>

                <section id="servicios" class="py-20 bg-[var(--color-background)]">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-3xl font-bold text-center text-[var(--text-main)] font-poppins mb-12">Servicios pensados para su bienestar</h2>
                        <div id="services-grid" class="grid sm:grid-cols-1 lg:grid-cols-2 gap-8">
                          </div>
                    </div>
                </section>
                
                <section id="informacion" class="py-20 bg-white">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-3xl font-bold text-center text-[var(--text-main)] font-poppins mb-12">Información Importante</h2>
                        <div class="grid md:grid-cols-3 gap-8 text-center">
                            <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                                <h3 class="font-bold text-xl text-[var(--text-main)] font-poppins mb-2">Zonas de Cobertura</h3>
                                <p class="text-[var(--text-muted)]">Las Condes, Vitacura, Lo Barnechea, Providencia, La Reina, Ñuñoa. Consulta por otras comunas.</p>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                                <h3 class="font-bold text-xl text-[var(--text-main)] font-poppins mb-2">Horarios de Atención</h3>
                                <p class="text-[var(--text-muted)]">Lunes a Viernes: 10:00 - 19:00 hrs.<br>Sábados: 10:00 - 14:00 hrs.</p>
                            </div>
                             <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                                <h3 class="font-bold text-xl text-[var(--text-main)] font-poppins mb-2">Métodos de Pago</h3>
                                <p class="text-[var(--text-muted)]">Transferencia bancaria, tarjetas de débito y crédito.</p>
                            </div>
                        </div>
                    </div>
                </section>

                 <section id="preguntas" class="py-20 bg-[var(--color-background)]">
                     <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-3xl font-bold text-center text-[var(--text-main)] font-poppins mb-12">Preguntas Frecuentes</h2>
                        <div id="faq-accordion" class="space-y-4">
                        </div>
                    </div>
                </section>
                
                <section id="contacto" class="py-20 bg-white">
                    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                        <h2 class="text-3xl font-bold text-[var(--text-main)] font-poppins mb-4">Conversemos</h2>
                        <p class="text-[var(--text-muted)] mb-8">Si tienes dudas o prefieres agendar por otro medio, aquí me encuentras.</p>
                        <div class="flex flex-col md:flex-row justify-center items-center gap-8 text-lg">
                            <a href="https://wa.me/56976040797" target="_blank" class="flex items-center gap-2 text-[var(--text-main)] hover:text-[var(--color-primary)] transition">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.003 2.011.564 3.963 1.648 5.684l.269.444-1.043 3.816 3.817-1.042.433.261z"/></svg>
                                <span>WhatsApp</span>
                            </a>
                            <a href="mailto:avmveterinaria@gmail.com" class="flex items-center gap-2 text-[var(--text-main)] hover:text-[var(--color-primary)] transition">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                                <span>Email</span>
                            </a>
                            <a href="https://instagram.com/AleVeterinaria" target="_blank" class="flex items-center gap-2 text-[var(--text-main)] hover:text-[var(--color-primary)] transition">
                                 <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg>
                                <span>Instagram</span>
                            </a>
                        </div>
                    </div>
                </section>
            </main>
             <footer class="bg-[#2F4F4F] text-white py-8">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-300">
                    <p>&copy; 2024 Dra. Alejandra Cautín. Todos los derechos reservados.</p>
                    <p class="text-sm mt-2">La información en este sitio es educativa y no reemplaza una consulta veterinaria directa.</p>
                </div>
            </footer>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header class="bg-[#FFFFFF] shadow-md p-4 flex justify-between items-center no-print">
            <h1 id="app-header-title" class="text-xl font-bold text-[#4A4A4A]">Gestión Clínica Veterinaria</h1>
            <div>
                <button id="back-to-landing-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold hidden">← Volver al Inicio</button>
                <button id="logout-btn" class="btn-danger px-4 py-2 rounded-lg font-semibold">Cerrar Sesión</button>
            </div>
        </header>

        <div id="app" class="max-w-5xl mx-auto p-4 md:p-8">
            <div id="view-dashboard" class="view">
                <main class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">Buscar Paciente</h2>
                         <div class="relative">
                            <input id="search-input" type="text" placeholder="Escribe un nombre para buscar..." class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Busca por nombre en tiempo real, o por RUT/Ficha y presiona el botón.</p>
                        </div>
                        <button id="search-btn" class="w-full mt-2 btn-secondary px-5 py-2 rounded-lg font-semibold">Buscar por RUT / Ficha</button>
                        <div id="search-results" class="mt-4"></div>
                    </div>
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg flex flex-col items-center justify-center">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">Acciones</h2>
                        <button id="new-patient-btn" class="w-full btn-primary py-3 rounded-lg text-lg font-bold shadow-md transform hover:scale-105 transition-transform">+ Crear Ficha de Paciente</button>
                    </div>
                </main>
            </div>
            <div id="view-tutor-portal" class="view">
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-3xl mx-auto">
                    <h2 class="text-3xl font-bold text-center text-[var(--text-main)] font-poppins mb-2">Portal de Tutores</h2>
                    <p class="text-center text-[var(--text-muted)] mb-6">Ingresa tu RUT para ver la información de tus mascotas.</p>
                    <div class="flex space-x-2">
                        <input id="portal-rut-input" type="text" placeholder="Ej: 12.345.678-9" class="w-full">
                        <button id="portal-search-btn" class="btn-primary px-5 py-2 rounded-lg font-semibold">Buscar</button>
                    </div>
                </div>
                <div id="portal-results-container" class="mt-8 space-y-8"></div>
            </div>
            <div id="view-patient-hub" class="view">
                <header class="flex justify-between items-center bg-[#FFFFFF] p-4 rounded-xl shadow-lg mb-6">
                    <div>
                        <h1 id="hub-patient-name" class="text-3xl font-bold text-[#4A4A4A] capitalize"></h1>
                        <p id="hub-patient-id" class="text-[#7F8B96]"></p>
                    </div>
                    <button class="back-to-dashboard-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver</button>
                </header>
                
                <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-[#4A4A4A]">Datos Principales</h2>
                        <button id="edit-patient-data-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold">Editar Datos</button>
                    </div>
                    <div id="hub-patient-summary" class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm"></div>
                </div>
        
                <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-[#4A4A4A]">Anamnesis Remota</h2>
                        <button id="save-hub-anamnesis-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold">Guardar Anamnesis</button>
                    </div>
                    <textarea id="hub-anamnesis-remota" rows="6" class="w-full p-2 border rounded-lg" placeholder="Antecedentes, alergias, historial de enfermedades importantes..."></textarea>
                </div>
        
                <div class="bg-[#FFFFFF] p-4 rounded-xl shadow-lg mb-6">
                    <div id="hub-section-buttons" class="flex flex-wrap gap-2">
                        <button data-section="consultas" class="hub-section-btn bg-gray-200 px-4 py-2 rounded-lg">Consultas</button>
                        <button data-section="vacunas" class="hub-section-btn bg-gray-200 px-4 py-2 rounded-lg">Vacunas</button>
                        <button data-section="desparasitacion" class="hub-section-btn bg-gray-200 px-4 py-2 rounded-lg">Desparasitación</button>
                        <button data-section="examenes" class="hub-section-btn bg-gray-200 px-4 py-2 rounded-lg">Exámenes</button>
                        <button data-section="certificados" class="hub-section-btn bg-gray-200 px-4 py-2 rounded-lg">Certificados</button>
                        <button data-section="recetas" class="hub-section-btn bg-gray-200 px-4 py-2 rounded-lg">Recetas</button>
                    </div>
                </div>
        
                <div id="hub-content-area"></div>
            </div>
            <div id="view-edit-patient-data" class="view">
                <header class="flex justify-between items-center bg-[#FFFFFF] p-4 rounded-xl shadow-lg mb-6">
                    <h1 class="text-3xl font-bold text-[#4A4A4A]">Datos del Paciente</h1>
                    <button id="back-to-hub-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver a Ficha</button>
                </header>
                <form id="patient-data-form">
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg mb-6">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">I. Datos del Tutor</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="data-tutor-name" class="block text-sm font-medium">Nombre Completo:</label><input type="text" id="data-tutor-name"></div>
                            <div>
                                <label for="data-tutor-rut" class="block text-sm font-medium">Cédula de Identidad/DNI:</label>
                                <input type="text" id="data-tutor-rut" class="rut-input">
                                <div id="rut-validation-message" class="text-red-500 text-xs mt-1"></div>
                            </div>
                            <div>
                                <label for="data-tutor-phone" class="block text-sm font-medium">Teléfono Principal:</label>
                                <input type="tel" id="data-tutor-phone">
                            </div>
                            <div><label for="data-tutor-phone2" class="block text-sm font-medium">Teléfono Secundario:</label><input type="tel" id="data-tutor-phone2"></div>
                            <div>
                                <label for="data-tutor-email" class="block text-sm font-medium">Correo Electrónico:</label>
                                <input type="email" id="data-tutor-email">
                            </div>
                            <div><label for="data-tutor-city" class="block text-sm font-medium">Ciudad/Comuna:</label><input type="text" id="data-tutor-city"></div>
                            <div class="md:col-span-2"><label for="data-tutor-address" class="block text-sm font-medium">Dirección Completa:</label><input type="text" id="data-tutor-address"></div>
                        </div>
                    </div>
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg mb-6">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">II. Datos del Paciente</h2>
                        <p class="mb-4 text-lg"><strong>Nº de Ficha:</strong> <span id="data-ficha-number" class="text-highlight font-bold"></span></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div><label for="data-patient-name" class="block text-sm font-medium">Nombre del Paciente:</label><input type="text" id="data-patient-name" required></div>
                            
                            <div>
                                <label for="data-breed" class="block text-sm font-medium">Raza:</label>
                                <select id="data-breed"></select>
                                <input type="text" id="data-breed-other" class="hidden mt-2" placeholder="Especificar otra raza">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Especie:</label>
                                <div class="flex items-center gap-4"><label><input type="radio" name="species" value="Canina" class="form-radio" checked> Canina</label><label><input type="radio" name="species" value="Felina" class="form-radio"> Felina</label></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Sexo:</label>
                                <div class="flex items-center gap-4"><label><input type="radio" name="sex" value="Macho" class="form-radio"> Macho</label><label><input type="radio" name="sex" value="Hembra" class="form-radio"> Hembra</label></div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-1">Estado Reproductivo:</label>
                                <div class="flex items-center gap-4"><label><input type="radio" name="reproductiveStatus" value="Entero" class="form-radio"> Entero</label><label><input type="radio" name="reproductiveStatus" value="Castrado" class="form-radio"> Castrado</label><label><input type="radio" name="reproductiveStatus" value="Esterilizada" class="form-radio"> Esterilizada</label></div>
                            </div>
                            <div><label for="data-birth-date" class="block text-sm font-medium">Fecha de Nacimiento (Estimada):</label><input type="date" id="data-birth-date"></div>
                            <div><label for="data-age" class="block text-sm font-medium">Edad Actual:</label><input type="text" id="data-age" readonly class="bg-gray-100"></div>
                            <div><label for="data-color-markings" class="block text-sm font-medium">Color/Señas Particulares:</label><input type="text" id="data-color-markings"></div>
                            <div><label for="data-weight" class="block text-sm font-medium">Peso Actual (kg):</label><input type="text" id="data-weight"></div>
                            
                            <div><label for="data-microchip" class="block text-sm font-medium">Microchip (N°):</label><input type="text" id="data-microchip"></div>
                            <div><label for="data-chip-site" class="block text-sm font-medium">Sitio de Implantación del Chip:</label><input type="text" id="data-chip-site"></div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-1">Origen:</label>
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-2"><label><input type="radio" name="origin" value="Criadero" class="form-radio"> Criadero</label><label><input type="radio" name="origin" value="Refugio" class="form-radio"> Refugio</label><label><input type="radio" name="origin" value="Rescate" class="form-radio"> Rescate</label><label><input type="radio" name="origin" value="Particular" class="form-radio"> Particular</label><label class="flex items-center gap-2"><input type="radio" name="origin" value="Otro" class="form-radio"> Otro: <input type="text" id="data-origin-other" class="p-1 text-sm"></label></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center gap-4">
                        <button type="button" id="delete-patient-btn" class="btn-danger px-6 py-3 rounded-lg text-lg font-bold">Eliminar Paciente</button>
                        <button type="submit" class="btn-primary px-6 py-3 rounded-lg text-lg font-bold">Guardar Datos</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md m-4 relative">
            <button id="close-login-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-[#4A4A4A] mb-6">Portal Profesional</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-[#7F8B96] mb-1">Correo Electrónico</label>
                    <input id="login-email" type="email" required class="w-full">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-[#7F8B96] mb-1">Contraseña</label>
                    <input id="login-password" type="password" required class="w-full">
                </div>
                <button type="submit" class="w-full btn-secondary py-3 rounded-lg text-lg font-bold">Ingresar</button>
            </form>
        </div>
    </div>
    <div id="notification-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50"><div class="bg-white rounded-xl shadow-xl p-8 m-4 max-w-sm text-center"><p id="notification-message" class="text-lg text-[#4A4A4A]"></p><button id="notification-close-btn" class="mt-6 btn-secondary px-5 py-2 rounded-lg font-semibold">Cerrar</button></div></div>
    <div id="delete-confirmation-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50"><div class="bg-white rounded-xl shadow-xl p-8 m-4 max-w-sm text-center"><h3 class="text-xl font-bold text-gray-800">Confirmar Eliminación</h3><p id="delete-confirmation-message" class="text-[#7F8B96] my-4"></p><p class="text-sm text-red-600 font-semibold">Esta acción no se puede deshacer.</p><div class="flex justify-center gap-4 mt-6"><button id="cancel-delete-btn" class="bg-gray-300 px-5 py-2 rounded-lg font-semibold">Cancelar</button><button id="confirm-delete-btn" class="btn-danger px-5 py-2 rounded-lg font-semibold">Eliminar Permanentemente</button></div></div></div>
    
<script type="module">
    // --- Application State ---
    let currentPatientId = null;
    let currentPatientSpecies = null;
    let currentPatientData = null;
    let allPatients = []; // Cache for real-time search

    // --- DOM Element References ---
    const appContainer = document.getElementById('app-container');
    const appDiv = document.getElementById('app');
    const modals = { 
        login: document.getElementById('login-modal'),
        notification: document.getElementById('notification-modal'),
        deleteConfirmation: document.getElementById('delete-confirmation-modal'),
    };

    // --- Data Definitions ---
    const canineBreeds = ["Mestizo / Quiltro", "Poodle", "Labrador Retriever", "Bulldog Francés", "Pastor Alemán", "Beagle", "Boxer", "Chihuahua", "Golden Retriever", "Pastor Australiano", "Salchicha (Dachshund)", "Shih Tzu", "Yorkshire Terrier", "Otro"];
    const felineBreeds = ["Doméstico de Pelo Corto", "Doméstico de Pelo Largo", "Siamés", "Persa", "Ragdoll", "Maine Coon", "Bengalí", "Otro"];

    // --- Utility & Core Functions ---
    /**
     * Normalizes text by converting to lowercase and removing diacritics.
     * @param {string} text - The text to normalize.
     * @returns {string} The normalized text.
     */
    function normalizeText(text) {
        if (!text) return '';
        return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }
    
    /**
     * Hides all views and shows the one with the specified ID.
     * @param {string} viewId - The ID of the view to show (e.g., 'view-dashboard').
     */
    function showView(viewId) {
        // Hide all top-level views
        document.querySelectorAll('#view-landing, #app-container').forEach(el => el.classList.remove('active'));
        
        if (viewId === 'view-landing') {
            document.getElementById('view-landing').classList.add('active');
        } else {
            appContainer.classList.remove('hidden');
            appContainer.classList.add('active');
            
            // Hide all views within the app container
            appDiv.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });
            
            // Show the target view
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.style.display = 'block';
            } else {
                console.error(`View with ID ${viewId} not found.`);
            }
        }
    }

    function showModal(modalName) { if(modals[modalName]) modals[modalName].classList.add('active'); }
    function hideModal(modalName) { if(modals[modalName]) modals[modalName].classList.remove('active'); }

    function showNotification(message) {
        const el = document.getElementById('notification-message');
        if(el) el.textContent = message;
        showModal('notification');
    }

    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { signInWithEmailAndPassword } = window.firebase;
        const auth = window.auth;
        try {
            await signInWithEmailAndPassword(auth, email, password);
            hideModal('login');
            // The onAuthStateChanged listener will handle the view transition
        } catch (error) {
            showNotification("Correo o contraseña incorrectos.");
        }
    }

    async function handleLogout() {
        const { signOut } = window.firebase;
        const auth = window.auth;
        try {
            await signOut(auth);
            // The onAuthStateChanged listener will handle the view transition
        } catch(e){
            showNotification("Error al cerrar sesión.");
        }
    }
    
    /**
     * Formats a RUT input in real-time to the Chilean standard.
     * @param {InputEvent} e - The input event.
     */
    function handleRutFormatting(e) {
        let rut = e.target.value.replace(/[^0-9kK]/g, '');
        rut = rut.slice(0, 9); 
        let result = "";
        if (rut.length > 1) {
            const dv = rut.slice(-1);
            const body = rut.slice(0, -1);
            result = body.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + "-" + dv;
        } else {
            result = rut;
        }
        e.target.value = result.toUpperCase();
    }

    const validateRut = (rut) => {
        if (!rut || !/^[0-9]{1,2}(\.?[0-9]{3}){2}-[0-9kK]{1}$/.test(rut)) return false;
        const cleanRut = rut.replace(/[.-]/g, '');
        let body = cleanRut.slice(0, -1);
        let dv = cleanRut.slice(-1).toUpperCase();
        let sum = 0;
        let multiple = 2;
        for (let i = body.length - 1; i >= 0; i--) {
            sum += multiple * body.charAt(i);
            if (multiple < 7) multiple++;
            else multiple = 2;
        }
        const dvExpected = 11 - (sum % 11);
        const dvCalculated = (dvExpected === 11) ? '0' : (dvExpected === 10) ? 'K' : String(dvExpected);
        return dv === dvCalculated;
    };
    
    function calculateAge() {
        const birthDateInput = document.getElementById('data-birth-date');
        const ageInput = document.getElementById('data-age');
        if (!birthDateInput || !ageInput) return;
        if (!birthDateInput.value) {
            ageInput.value = '';
            return;
        }
        try {
            const birthDate = new Date(birthDateInput.value);
            const today = new Date();
            let years = today.getFullYear() - birthDate.getFullYear();
            let months = today.getMonth() - birthDate.getMonth();
            if (months < 0 || (months === 0 && today.getDate() < birthDate.getDate())) {
                years--;
                months = (months + 12) % 12;
            }
            ageInput.value = `${years} años, ${months} meses`;
        } catch (e) {
            ageInput.value = 'Fecha inválida';
        }
    }
    
    // --- App Functions ---
    async function loadAllPatientsForSearch() {
        const { getDocs, collection, query, orderBy } = window.firebase;
        const db = window.db;
        try {
            const q = query(collection(db, "patients"), orderBy("name"));
            const snapshot = await getDocs(q);
            allPatients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch(e) {
            console.error("Error loading patients for search:", e);
            showNotification("No se pudieron cargar los pacientes para la búsqueda.");
        }
    }

    function realTimeSearch() {
        const searchTerm = document.getElementById('search-input').value;
        const normalizedTerm = normalizeText(searchTerm);
        
        if (!normalizedTerm) {
            document.getElementById('search-results').innerHTML = '';
            return;
        }

        const filteredPatients = allPatients.filter(patient => 
            normalizeText(patient.name).includes(normalizedTerm) ||
            normalizeText(patient.tutorName).includes(normalizedTerm)
        );
        
        displaySearchResults(filteredPatients);
    }
    
    async function searchByRutOrFicha() {
        const { doc, getDoc, collection, query, where, getDocs } = window.firebase;
        const db = window.db;
        const searchTerm = document.getElementById('search-input').value.trim();
        const searchResultsEl = document.getElementById('search-results');
        
        if (!searchTerm) return;
        searchResultsEl.innerHTML = '<p>Buscando...</p>';
        let results = new Map();

        try {
            // Search by Ficha
            if (!isNaN(searchTerm)) {
                const docRef = doc(db, "patients", searchTerm);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    results.set(docSnap.id, { id: docSnap.id, ...docSnap.data() });
                }
            }
            // Search by RUT
            if (validateRut(searchTerm)) {
                 const cleanRut = searchTerm.replace(/[.-]/g, '');
                 const qRut = query(collection(db, "patients"), where("tutorRut", "==", cleanRut));
                 const rutSnapshot = await getDocs(qRut);
                 rutSnapshot.forEach((doc) => {
                     results.set(doc.id, { id: doc.id, ...doc.data() });
                 });
            }
        } catch (e) {
            console.error("Search by RUT/Ficha error:", e);
            searchResultsEl.innerHTML = '<p class="text-red-500">Ocurrió un error en la búsqueda.</p>';
        }
        displaySearchResults(Array.from(results.values()));
    }


    function displaySearchResults(patients) {
        const searchResultsEl = document.getElementById('search-results');
        searchResultsEl.innerHTML = patients.length === 0 ? '<p>No se encontraron pacientes.</p>' : '';
        const list = document.createElement('ul');
        list.className = 'space-y-2';
        patients.forEach(patient => {
            const item = document.createElement('li');
            item.className = 'p-3 border rounded-lg flex justify-between items-center hover:bg-gray-50';
            item.innerHTML = `<span class="capitalize font-semibold text-gray-700">${patient.name} <span class="text-sm text-gray-500 font-normal">(${patient.tutorName})</span></span>`;
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'Ver Ficha';
            viewBtn.className = 'btn-tertiary text-xs px-3 py-1 rounded-md font-semibold';
            viewBtn.onclick = () => openPatientHub(patient.id);
            item.appendChild(viewBtn);
            list.appendChild(item);
        });
        searchResultsEl.appendChild(list);
    }

    function updateBreedOptions() {
        const speciesEl = document.querySelector('input[name="species"]:checked');
        if (!speciesEl) return;
        const species = speciesEl.value;
        const breedSelect = document.getElementById('data-breed');
        const breedOtherInput = document.getElementById('data-breed-other');
        const breeds = (species === 'Canina') ? canineBreeds : felineBreeds;

        breedSelect.innerHTML = '';
        breeds.forEach(breed => {
            const option = document.createElement('option');
            option.value = breed;
            option.textContent = breed;
            breedSelect.appendChild(option);
        });
        
        breedSelect.onchange = () => {
             if (breedSelect.value === 'Otro') {
                breedOtherInput.classList.remove('hidden');
            } else {
                breedOtherInput.classList.add('hidden');
                breedOtherInput.value = '';
            }
        };
    }

    async function openPatientDataForm(patientId) {
        showView('view-edit-patient-data');
        currentPatientId = patientId;

        if (patientId) {
            const { doc, getDoc } = window.firebase;
            const db = window.db;
            const docRef = doc(db, "patients", patientId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                currentPatientData = { id: docSnap.id, ...docSnap.data() };
                loadPatientDataIntoForm(currentPatientData, patientId);
            }
        } else {
            currentPatientData = null;
            document.getElementById('patient-data-form').reset();
            document.getElementById('data-ficha-number').textContent = 'Se generará al guardar';
            document.querySelector('input[name="species"][value="Canina"]').checked = true;
            updateBreedOptions();
        }
    }

    function loadPatientDataIntoForm(data, patientId) {
        document.getElementById('data-ficha-number').textContent = patientId;
        document.getElementById('data-tutor-name').value = data.tutorName || '';
        const rutInput = document.getElementById('data-tutor-rut');
        rutInput.value = data.tutorRut || '';
        handleRutFormatting({ target: rutInput }); // Format the loaded RUT
        document.getElementById('data-tutor-phone').value = data.tutorPhone || '';
        document.getElementById('data-tutor-phone2').value = data.tutorPhone2 || '';
        document.getElementById('data-tutor-email').value = data.tutorEmail || '';
        document.getElementById('data-tutor-city').value = data.tutorCity || '';
        document.getElementById('data-tutor-address').value = data.tutorAddress || '';
        document.getElementById('data-patient-name').value = data.name || '';
        if (data.species) document.querySelector(`input[name="species"][value="${data.species}"]`).checked = true;
        
        updateBreedOptions(); 
        const breedSelect = document.getElementById('data-breed');
        const breedOtherInput = document.getElementById('data-breed-other');
        const breedExistsInList = [...breedSelect.options].some(opt => opt.value === data.breed);
        if (data.breed && breedExistsInList) {
            breedSelect.value = data.breed;
            breedOtherInput.classList.add('hidden');
        } else if (data.breed) {
            breedSelect.value = 'Otro';
            breedOtherInput.value = data.breed;
            breedOtherInput.classList.remove('hidden');
        }

        if (data.sex) document.querySelector(`input[name="sex"][value="${data.sex}"]`).checked = true;
        if (data.reproductiveStatus) document.querySelector(`input[name="reproductiveStatus"][value="${data.reproductiveStatus}"]`).checked = true;
        document.getElementById('data-birth-date').value = data.birthDate || '';
        calculateAge();
        document.getElementById('data-color-markings').value = data.colorMarkings || '';
        document.getElementById('data-microchip').value = data.microchip || '';
        document.getElementById('data-chip-site').value = data.chipSite || '';
        document.getElementById('data-weight').value = data.weight || '';
        if (data.origin) {
            const originRadio = document.querySelector(`input[name="origin"][value="${data.origin}"]`);
            if (originRadio) {
                originRadio.checked = true;
            } else {
                document.querySelector(`input[name="origin"][value="Otro"]`).checked = true;
                document.getElementById('data-origin-other').value = data.origin;
            }
        }
    }
    
    async function savePatientData(e) {
        e.preventDefault();
        const { setDoc, doc, serverTimestamp, runTransaction } = window.firebase;
        const db = window.db;

        const getRadioValue = (name) => { const el = document.querySelector(`input[name="${name}"]:checked`); return el ? el.value : ''; };
        let originValue = getRadioValue('origin');
        if (originValue === 'Otro') {
            originValue = document.getElementById('data-origin-other').value;
        }

        let breedValue = document.getElementById('data-breed').value;
        if (breedValue === 'Otro') {
            breedValue = document.getElementById('data-breed-other').value;
        }

        const data = {
            name: document.getElementById('data-patient-name').value.toLowerCase(),
            tutorName: document.getElementById('data-tutor-name').value,
            tutorRut: document.getElementById('data-tutor-rut').value.replace(/[.-]/g, ''),
            tutorPhone: document.getElementById('data-tutor-phone').value,
            tutorPhone2: document.getElementById('data-tutor-phone2').value,
            tutorEmail: document.getElementById('data-tutor-email').value,
            tutorCity: document.getElementById('data-tutor-city').value,
            tutorAddress: document.getElementById('data-tutor-address').value,
            species: getRadioValue('species'),
            breed: breedValue,
            sex: getRadioValue('sex'),
            reproductiveStatus: getRadioValue('reproductiveStatus'),
            birthDate: document.getElementById('data-birth-date').value,
            age: document.getElementById('data-age').value,
            colorMarkings: document.getElementById('data-color-markings').value,
            microchip: document.getElementById('data-microchip').value,
            chipSite: document.getElementById('data-chip-site').value,
            weight: document.getElementById('data-weight').value,
            origin: originValue,
            lastUpdated: serverTimestamp()
        };
        try {
            if (currentPatientId) {
                // IMPORTANT: Use { merge: true } to avoid overwriting existing data
                await setDoc(doc(db, "patients", currentPatientId), data, { merge: true });
                showNotification("Datos actualizados.");
                openPatientHub(currentPatientId);
            } else {
                const counterRef = doc(db, "counters", "patientCounter");
                const newPatientNumber = await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    const lastNumber = counterDoc.data()?.lastNumber || 0;
                    const newNumber = lastNumber + 1;
                    const formattedNumber = String(newNumber);
                    data.createdAt = serverTimestamp();
                    transaction.set(doc(db, "patients", formattedNumber), data);
                    transaction.update(counterRef, { lastNumber: newNumber });
                    return formattedNumber;
                });
                currentPatientId = newPatientNumber;
                showNotification(`Nuevo paciente creado con Ficha Nº ${newPatientNumber}.`);
                await loadAllPatientsForSearch(); // Refresh search cache
                openPatientHub(currentPatientId);
            }
        } catch (error) {
            showNotification("Error al guardar datos.");
            console.error("Error saving patient data:", error);
        }
    }
    
    async function handleDeletePatient() {
        if (!currentPatientId) return;
        const { doc, deleteDoc, collection, getDocs } = window.firebase;
        const db = window.db;

        async function deleteSubcollection(patientId, subcollectionName) {
            const subcollectionRef = collection(db, "patients", patientId, subcollectionName);
            const snapshot = await getDocs(subcollectionRef);
            const deletePromises = [];
            snapshot.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref));
            });
            await Promise.all(deletePromises);
        }

        try {
            await Promise.all([
                deleteSubcollection(currentPatientId, 'consultations'),
                deleteSubcollection(currentPatientId, 'prescriptions'),
                deleteSubcollection(currentPatientId, 'vaccines'),
                deleteSubcollection(currentPatientId, 'deworming'),
                deleteSubcollection(currentPatientId, 'exams'),
                deleteSubcollection(currentPatientId, 'certificates')
            ]);
            await deleteDoc(doc(db, "patients", currentPatientId));
            hideModal('deleteConfirmation');
            showNotification("Paciente eliminado correctamente.");
            await loadAllPatientsForSearch(); // Refresh search cache
            showView('view-dashboard');
        } catch (error) {
            hideModal('deleteConfirmation');
            showNotification("Error al eliminar el paciente.");
            console.error("Error deleting patient:", error);
        }
    }
      
    async function openPatientHub(patientId) {
        const { doc, getDoc } = window.firebase;
        const db = window.db;
        const docRef = doc(db, "patients", patientId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            currentPatientData = { id: docSnap.id, ...docSnap.data() };
            currentPatientId = patientId;
            currentPatientSpecies = currentPatientData.species;
            
            showView('view-patient-hub');
            document.getElementById('hub-patient-name').textContent = currentPatientData.name || 'Paciente sin nombre';
            document.getElementById('hub-patient-id').textContent = `Nº Ficha: ${patientId}`;
            document.getElementById('hub-anamnesis-remota').value = currentPatientData.anamnesisRemota || '';
            
            const summaryEl = document.getElementById('hub-patient-summary');
            summaryEl.innerHTML = `
                <div><strong>Especie:</strong> ${currentPatientData.species || 'N/A'}</div>
                <div><strong>Raza:</strong> ${currentPatientData.breed || 'N/A'}</div>
                <div><strong>Nacimiento:</strong> ${currentPatientData.birthDate || 'N/A'}</div>
                <div><strong>Tutor:</strong> ${currentPatientData.tutorName || 'N/A'}</div>
                <div><strong>Teléfono:</strong> ${currentPatientData.tutorPhone || 'N/A'}</div>
                <div><strong>RUT Tutor:</strong> ${currentPatientData.tutorRut ? handleRutFormatting({target: {value: currentPatientData.tutorRut}}).value : 'N/A'}</div>
            `;
            
            // Placeholder for content area
            document.getElementById('hub-content-area').innerHTML = `<p class="text-center p-4 bg-white rounded-lg shadow">Seleccione una sección para ver el historial.</p>`;
            document.querySelector('.hub-section-btn[data-section="consultas"]').click();
        } else {
            showNotification(`No se encontró el paciente con Ficha Nº ${patientId}.`);
            showView('view-dashboard');
        }
    }

    // --- Event Listener Initializers ---
    
    function initializePublicListeners() {
        document.getElementById('show-login-modal-btn-desktop').addEventListener('click', () => showModal('login'));
        document.getElementById('close-login-modal-btn').addEventListener('click', () => hideModal('login'));
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('notification-close-btn').addEventListener('click', () => hideModal('notification'));
        
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        
        const showTutorPortalView = () => {
             showView('view-tutor-portal');
             document.getElementById('back-to-landing-btn').classList.remove('hidden');
             document.getElementById('logout-btn').classList.add('hidden');
        };
        
        document.getElementById('show-tutor-portal-btn-desktop').addEventListener('click', showTutorPortalView);
        document.getElementById('show-tutor-portal-btn').addEventListener('click', showTutorPortalView);
        document.getElementById('show-tutor-portal-btn-mobile').addEventListener('click', showTutorPortalView);
        document.getElementById('show-login-modal-btn-mobile').addEventListener('click', () => showModal('login'));
        
        document.getElementById('back-to-landing-btn').addEventListener('click', () => {
            appContainer.classList.add('hidden');
            showView('view-landing');
        });
    }

    function initializeAppListeners() {
        // Event delegation for the entire app container
        appDiv.addEventListener('click', (e) => {
            if (e.target.matches('#search-btn')) searchByRutOrFicha();
            if (e.target.matches('#new-patient-btn')) openPatientDataForm(null);
            if (e.target.matches('#portal-search-btn')) searchTutorPets();
            if (e.target.matches('.back-to-dashboard-btn')) showView('view-dashboard');
            if (e.target.matches('#edit-patient-data-btn')) openPatientDataForm(currentPatientId);
            if (e.target.matches('#back-to-hub-btn')) openPatientHub(currentPatientId);
            if (e.target.matches('#delete-patient-btn')) {
                document.getElementById('delete-confirmation-message').textContent = `¿Seguro que quieres eliminar la ficha de ${currentPatientData?.name || 'este paciente'}?`;
                showModal('deleteConfirmation');
            }
            if (e.target.matches('#confirm-delete-btn')) handleDeletePatient();
            if (e.target.matches('#cancel-delete-btn')) hideModal('deleteConfirmation');
            if (e.target.closest('.hub-section-btn')) {
                 const section = e.target.closest('.hub-section-btn').dataset.section;
                document.querySelectorAll('.hub-section-btn').forEach(b => b.classList.remove('active-hub-btn'));
                e.target.closest('.hub-section-btn').classList.add('active-hub-btn');
                document.getElementById('hub-content-area').innerHTML = `<p class="text-center p-4 bg-white rounded-lg shadow">Historial de <strong>${section}</strong> en construcción.</p>`;
            }
        });

        appDiv.addEventListener('input', (e) => {
            if (e.target.matches('#search-input')) realTimeSearch();
            if (e.target.matches('.rut-input')) handleRutFormatting(e);
        });

        appDiv.addEventListener('change', (e) => {
            if (e.target.matches('input[name="species"]')) updateBreedOptions();
            if (e.target.matches('#data-birth-date')) calculateAge();
        });

        appDiv.addEventListener('submit', (e) => {
            if (e.target.matches('#patient-data-form')) savePatientData(e);
        });
    }
    
    async function searchTutorPets() {
        const { collection, query, where, getDocs } = window.firebase;
        const db = window.db;
        const rutInput = document.getElementById('portal-rut-input');
        const resultsContainer = document.getElementById('portal-results-container');
        const cleanRut = rutInput.value.replace(/[.-]/g, '');

        if (!validateRut(rutInput.value)) {
            showNotification("Por favor, ingrese un RUT válido.");
            return;
        }
        
        resultsContainer.innerHTML = `<p>Buscando mascotas...</p>`;
        
        try {
            const q = query(collection(db, "patients"), where("tutorRut", "==", cleanRut));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                resultsContainer.innerHTML = `<p class="text-center">No se encontraron mascotas asociadas a este RUT.</p>`;
                return;
            }
            
            resultsContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const pet = { id: doc.id, ...doc.data() };
                const petCard = document.createElement('div');
                petCard.className = "bg-white rounded-xl shadow-lg p-5";
                petCard.innerHTML = `
                    <h3 class="text-2xl font-bold text-gray-800 capitalize">${pet.name}</h3>
                    <p class="text-sm text-gray-500 mb-4">Ficha N°: ${pet.id}</p>
                    <div class="border-t pt-4">
                        <h4 class="font-bold text-lg mb-2">Historial Reciente</h4>
                        <div id="history-for-${pet.id}" class="space-y-4">
                            <p class="text-sm text-gray-600">Cargando historial...</p>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(petCard);
                loadPetHistoryForTutor(pet.id);
            });

        } catch (e) {
            console.error("Error searching tutor pets:", e);
            resultsContainer.innerHTML = `<p class="text-red-500 text-center">Ocurrió un error al buscar.</p>`;
        }
    }

    async function loadPetHistoryForTutor(petId) {
        // This is a simplified example. You would fetch actual data for vaccines, prescriptions, etc.
        const historyContainer = document.getElementById(`history-for-${petId}`);
        historyContainer.innerHTML = `
            <!-- Example Card: Vaccine -->
            <div class="border border-gray-200 rounded-lg p-4 flex items-start gap-4 hover:bg-gray-50">
                <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <h4 class="font-bold">Vacuna Óctuple</h4>
                    <p class="text-sm text-gray-600">Aplicada: 15/03/2024</p>
                    <p class="text-sm text-gray-500">Próxima: 15/03/2025</p>
                </div>
            </div>
             <!-- Example Card: Prescription -->
            <div class="border border-gray-200 rounded-lg p-4 flex items-start gap-4 hover:bg-gray-50">
                <div class="flex-shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                </div>
                <div>
                    <h4 class="font-bold">Receta: Antiinflamatorio</h4>
                    <p class="text-sm text-gray-600">Fecha: 10/02/2024</p>
                    <a href="#" class="text-sm text-blue-600 hover:underline">Ver detalles</a>
                </div>
            </div>
        `;
    }

    /**
     * Initializes the entire application.
     */
    function initializeApp() {
        const { onAuthStateChanged } = window.firebase;
        const auth = window.auth;

        initializePublicListeners();
        initializeAppListeners();

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('back-to-landing-btn').classList.add('hidden');
                showView('view-dashboard');
                loadAllPatientsForSearch();
            } else {
                appContainer.classList.add('hidden');
                showView('view-landing');
            }
        });

        // --- Dynamic Content Population for Public Page ---
        const serviceData = [
            { title: 'Consulta General a Domicilio', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />', description: 'Evaluación completa y sin estrés en la comodidad de tu hogar.' },
            { title: 'Vacunación y Desparasitación', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />', description: 'Planes de prevención personalizados para proteger a tu compañero.' },
            { title: 'Implantación de Microchip', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 11c.604-2.186 2.232-3.814 4.418-4.418m-8.836 0c2.186.604 3.814 2.232 4.418 4.418m0 0a4.5 4.5 0 11-8.836 0 4.5 4.5 0 018.836 0zM12 3v1m0 16v1m-6.4-2.6l.7-.7m11.4 0l-.7-.7M3 12h1m16 0h-1" />', description: 'Registro oficial y seguro para la identificación de tu mascota.' },
            { title: 'Toma de Exámenes', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m3 3H9" />', description: 'Coordinación y toma de muestras para análisis de laboratorio.' },
            { title: 'Certificados de Salud y Viaje', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />', description: 'Documentos necesarios para viajar o cumplir con normativas.' },
            { title: 'Acompañamiento Final (Eutanasia)', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />', description: 'Un adiós digno y respetuoso en un entorno de paz y amor.' }
        ];
        const servicesGrid = document.getElementById('services-grid');
        if (servicesGrid) {
            servicesGrid.innerHTML = '';
            serviceData.forEach(service => {
                const serviceEl = document.createElement('div');
                serviceEl.className = "bg-white p-6 rounded-xl shadow-md flex items-start gap-4 transition-transform transform hover:scale-105";
                serviceEl.innerHTML = `<div class="flex-shrink-0 w-12 h-12 bg-[var(--color-secondary)] rounded-full flex items-center justify-center"><svg class="w-6 h-6 text-[var(--text-main)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">${service.icon}</svg></div><div><h3 class="font-bold text-xl text-[var(--text-main)] font-poppins mb-1">${service.title}</h3><p class="text-[var(--text-muted)] text-sm">${service.description}</p></div>`;
                servicesGrid.appendChild(serviceEl);
            });
        }
        const faqs = [
            { q: '¿Qué hago si mi perro vomita un medicamento?', a: 'No repita la dosis sin consultar. Anote la hora y el medicamento y contacte a su veterinario para recibir instrucciones.' },
            { q: '¿Cómo saber si mi mascota tiene fiebre?', a: 'La forma más precisa es con un termómetro rectal. La temperatura normal en perros y gatos es de 38°C a 39.2°C.' },
            { q: '¿Cuándo debo llevar a mi mascota a un control?', a: 'Se recomienda un control anual para mascotas adultas sanas. Los cachorros, seniors o con condiciones crónicas necesitan visitas más frecuentes.' }
        ];
        const faqContainer = document.getElementById('faq-accordion');
        if (faqContainer) {
            faqContainer.innerHTML = '';
            faqs.forEach(faq => {
                const item = document.createElement('div');
                item.innerHTML = `<div class="accordion-header"><h3 class="font-semibold text-lg text-gray-700">${faq.q}</h3><svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div class="accordion-body"><p class="text-gray-600">${faq.a}</p></div>`;
                faqContainer.appendChild(item);
            });
            faqContainer.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    e.currentTarget.classList.toggle('active');
                    e.currentTarget.nextElementSibling.classList.toggle('expanded');
                });
            });
        }
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
</script>    
</body>
</html>
