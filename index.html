<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pacientes Veterinaria</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        // --- Firebase Configuration ---
        // ATENCIÓN: Reemplaza esto con la configuración de tu propio proyecto de Firebase.
        // Es crucial proteger esta clave API con restricciones de dominio en la consola de Google Cloud.
        const firebaseConfig = {
            apiKey: "AIzaSyBrYOiaa_skDuvRDD_zMZvUBknfwmTyDko",
            authDomain: "ale-veterinaria.firebaseapp.com",
            projectId: "ale-veterinaria",
            storageBucket: "ale-veterinaria.appspot.com",
            messagingSenderId: "87862276548",
            appId: "1:87862276548:web:a55b3154a31e4c6948b491",
            measurementId: "G-PNKMJC92K3"
        };
        
        // --- Firebase Initialization ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, runTransaction, orderBy, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const storage = getStorage(app);
            window.db = db;
            window.auth = auth;
            window.storage = storage;
            window.firebase = { 
                collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, 
                runTransaction, orderBy, addDoc, deleteDoc, updateDoc, signInWithEmailAndPassword, 
                onAuthStateChanged, signOut, ref, uploadBytes, getDownloadURL
            };
        } catch (e) {
            console.error("Firebase initialization error. Please check your firebaseConfig.", e);
        }
    </script>
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Custom Styles -->
    <style>
        :root {
            --color-background: #F9F5EF;
            --color-surface: #FFFFFF;
            --color-primary: #A3CBB2;
            --color-secondary: #F7DCDC;
            --color-accent: #CFEDEC;
            --color-highlight: #DAD4E6;
            --text-main: #4B4B4B;
            --text-muted: #7C7C75;
            --text-contrast: #FFFFFF;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--text-main); }
        h1, h2, h3, button, .font-poppins { font-family: 'Poppins', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        
        .btn-primary { background-color: var(--color-primary); color: var(--text-contrast); transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #8FBBA1; }
        .btn-secondary { background-color: var(--color-secondary); color: var(--text-main); transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #F5CECE; }
        .btn-tertiary { background-color: var(--color-accent); color: var(--text-main); transition: background-color 0.3s; }
        .btn-tertiary:hover { background-color: #BDE6E5; }
        .btn-danger { background-color: #EF4444; color: white; transition: background-color 0.3s; }
        .btn-danger:hover { background-color: #DC2626; }
        
        .text-accent-dark { color: var(--text-main); }
        .text-highlight { color: var(--color-highlight); }
        .ring-accent:focus { --tw-ring-color: var(--color-accent); }
        
        input[type="text"], input[type="date"], input[type="email"], input[type="tel"], input[type="password"], textarea, select { border: 1px solid #CBD5E0; border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: border-color 0.2s, box-shadow 0.2s; width: 100%;}
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus, select:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(163, 203, 178, 0.3); outline: none; }
        input.invalid { border-color: #EF4444; }
        .validation-message { color: #EF4444; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; }
        input[readonly] { background-color: #F3F4F6; cursor: not-allowed; }
        .form-radio, .form-checkbox { color: var(--color-primary); }
        .form-radio:checked, .form-checkbox:checked { background-color: var(--color-primary); border-color: var(--color-primary); }
        .section-header { border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem; margin-bottom: 1.5rem; color: var(--text-main); }
        .hub-section-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; color: var(--text-main); background-color: #f3f4f6; border: 1px solid transparent; transition: all 0.3s; }
        .hub-section-btn:hover { background-color: #e5e7eb; }
        .hub-section-btn.active-hub-btn { background-color: var(--color-accent); color: var(--text-main); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .accordion-header { cursor: pointer; padding: 1rem; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s; }
        .accordion-header:hover { background-color: #f3f4f6; }
        .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; padding: 0 1rem; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background-color: var(--color-surface); }
        .accordion-body.expanded { padding: 1.5rem 1rem; max-height: 1500px; }
        .accordion-arrow { transition: transform 0.3s ease-in-out; }
        .accordion-header.active .accordion-arrow { transform: rotate(90deg); }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .nav-link.active { color: var(--text-main); font-weight: 600; }
        
        /* Estilos para certificados */
        .cert-section { margin-bottom: 1.5rem; }
        .cert-section h2 { font-size: 1.125rem; font-weight: 700; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .cert-field { display: flex; align-items: baseline; margin-bottom: 0.5rem; }
        .cert-field strong { min-width: 180px; font-weight: 600; }
        .cert-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.8rem; }
        .cert-table th, .cert-table td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        .cert-table th { background-color: #f2f2f2; font-weight: 600; }
        .checkbox-label { display: flex; align-items: center; margin-right: 1rem; }
        .checkbox-symbol { font-family: monospace; font-size: 1.2em; line-height: 1; margin-right: 0.5rem;}

        @media print { 
            .no-print { display: none !important; } 
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .printable-cert { box-shadow: none !important; border: 1px solid #ccc; }
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="antialiased">

    <!-- ===== Landing Page / Public View ===== -->
    <div id="view-landing" class="view active">
        <div class="min-h-screen bg-[var(--color-surface)]">
            <nav class="bg-[var(--color-surface)] shadow-sm sticky top-0 z-40">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="md:hidden">
                            <button id="mobile-menu-btn" class="text-[var(--text-muted)] hover:text-[var(--text-main)]">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                            </button>
                        </div>
                        <div class="hidden md:flex items-center space-x-8" id="desktop-nav">
                            <a href="#inicio" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Inicio</a>
                            <a href="#quien-soy" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Quién soy</a>
                            <a href="#servicios" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Servicios</a>
                            <a href="#agenda" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Agenda</a>
                            <a href="#recursos" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Recursos</a>
                            <a href="#contacto" class="nav-link text-[var(--text-muted)] hover:text-[var(--text-main)] transition">Contacto</a>
                        </div>
                        <div>
                            <button id="show-login-modal-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold">Iniciar Sesión</button>
                        </div>
                    </div>
                </div>
                <div id="mobile-menu" class="md:hidden hidden bg-[var(--color-surface)] border-t">
                    <a href="#inicio" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Inicio</a>
                    <a href="#quien-soy" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Quién soy</a>
                    <a href="#servicios" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Servicios</a>
                    <a href="#agenda" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Agenda</a>
                    <a href="#recursos" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Recursos</a>
                    <a href="#contacto" class="nav-link block py-2 px-4 text-sm text-[var(--text-muted)] hover:bg-[var(--color-background)]">Contacto</a>
                </div>
            </nav>
            
            <main id="public-main-content">
                <!-- Inicio Section -->
                <section id="page-inicio" class="page-section active">
                    <div class="py-20 bg-[var(--color-background)]">
                        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                            <img src="https://alecautin8.github.io/AleVeterinaria/assets/logo1.png" alt="Logo de la clínica veterinaria" class="w-32 h-32 mx-auto mb-6 rounded-full shadow-lg" onerror="this.onerror=null; this.src='https://placehold.co/128x128/A3CBB2/FFFFFF?text=Logo';">
                            <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-main)] font-poppins">Dra. Alejandra Cautin Bastias</h1>
                            <p class="mt-4 text-lg text-[var(--text-muted)] max-w-3xl mx-auto">Medica Veterinaria a domicilio, para cuidar con calidez y respeto lo que más amas.</p>
                             <div class="mt-10 flex flex-wrap justify-center gap-4" id="home-buttons">
                                <a href="#inicio" class="nav-link btn-primary px-6 py-3 rounded-lg font-semibold text-lg">Inicio</a>
                                <a href="#quien-soy" class="nav-link btn-primary px-6 py-3 rounded-lg font-semibold text-lg">Quién soy</a>
                                <a href="#servicios" class="nav-link btn-primary px-6 py-3 rounded-lg font-semibold text-lg">Servicios</a>
                                <a href="#agenda" class="nav-link btn-primary px-6 py-3 rounded-lg font-semibold text-lg">Agenda</a>
                                <a href="#recursos" class="nav-link btn-primary px-6 py-3 rounded-lg font-semibold text-lg">Recursos</a>
                                <a href="#contacto" class="nav-link btn-primary px-6 py-3 rounded-lg font-semibold text-lg">Contacto</a>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Quién soy Section -->
                <section id="page-quien-soy" class="page-section">
                     <div class="py-20 bg-[var(--color-surface)]">
                        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 grid md:grid-cols-3 gap-12 items-center">
                            <div class="md:col-span-1">
                                <img src="https://placehold.co/400x400/F7DCDC/4B4B4B?text=Dra.+A." alt="Foto de Dra. Alejandra" class="rounded-full shadow-xl mx-auto">
                            </div>
                            <div class="md:col-span-2">
                                <h2 class="text-3xl font-bold text-[var(--text-main)] font-poppins mb-4">Sobre Alejandra Cautín</h2>
                                <p class="text-[var(--text-muted)] mb-4">Médica Veterinaria con una profunda pasión por la salud integrativa y el bienestar animal. Mi práctica se centra en fortalecer el vínculo único entre tutores y sus mascotas a través de un cuidado informado y compasivo.</p>
                                <p class="text-[var(--text-main)] italic text-lg">"Acompaño desde el cuidado consciente, respetando la conexión entre tutor y animal."</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Servicios Section -->
                <section id="page-servicios" class="page-section">
                    <div class="py-20 bg-[var(--color-background)]">
                        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                            <h2 class="text-3xl font-bold text-center text-[var(--text-main)] font-poppins mb-12">Mis Servicios</h2>
                            <div id="services-grid" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-8">
                                <!-- Service cards will be injected here by JS -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Agenda Section -->
                <section id="page-agenda" class="page-section">
                    <div class="py-20 bg-[var(--color-surface)]">
                        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                            <h2 class="text-3xl font-bold text-[var(--text-main)] font-poppins mb-8">Agenda tu Cita</h2>
                            <p class="text-[var(--text-muted)] mb-6">Completa tus datos para continuar con el agendamiento en Calendly.</p>
                            <form id="agenda-form" class="space-y-4 text-left">
                                <div>
                                    <label for="agenda-tutor-name" class="block text-sm font-medium text-[var(--text-muted)]">Nombre completo del tutor</label>
                                    <input type="text" id="agenda-tutor-name" required class="mt-1">
                                </div>
                                <div>
                                    <label for="agenda-tutor-rut" class="block text-sm font-medium text-[var(--text-muted)]">RUT del tutor</label>
                                    <input type="text" id="agenda-tutor-rut" required class="mt-1" placeholder="Ej: 12.345.678-9">
                                    <div id="agenda-rut-validation-message" class="validation-message"></div>
                                </div>
                                <div>
                                    <label for="agenda-tutor-commune" class="block text-sm font-medium text-[var(--text-muted)]">Comuna</label>
                                    <input type="text" id="agenda-tutor-commune" required class="mt-1">
                                </div>
                                
                                <div id="agenda-step-2" class="hidden space-y-4 pt-4 border-t">
                                    <div id="existing-pets-container" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                                        <p class="font-semibold mb-2">Hemos encontrado estas mascotas asociadas a tu RUT. ¿Para cuál deseas agendar?</p>
                                        <div id="existing-pets-list" class="space-y-2"></div>
                                    </div>
                                    
                                    <div id="new-patient-fields" class="hidden space-y-4">
                                        <p class="font-semibold">No hemos encontrado mascotas. Por favor, completa los datos de tu nuevo paciente:</p>
                                        <div>
                                            <label for="agenda-pet-name" class="block text-sm font-medium text-[var(--text-muted)]">Nombre de la mascota</label>
                                            <input type="text" id="agenda-pet-name" required class="mt-1">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Especie:</label>
                                            <div class="flex items-center gap-4"><label><input type="radio" name="agenda-species" value="Canina" class="form-radio"> Canina</label><label><input type="radio" name="agenda-species" value="Felina" class="form-radio"> Felina</label></div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Sexo:</label>
                                            <div class="flex items-center gap-4"><label><input type="radio" name="agenda-sex" value="Macho" class="form-radio"> Macho</label><label><input type="radio" name="agenda-sex" value="Hembra" class="form-radio"> Hembra</label></div>
                                        </div>
                                        <div>
                                            <label for="agenda-birth-date" class="block text-sm font-medium">Fecha de Nacimiento (Estimada)</label>
                                            <input type="date" id="agenda-birth-date" class="mt-1">
                                        </div>
                                    </div>
                                </div>

                                <div id="agenda-action-container" class="pt-4">
                                    <button type="button" id="agenda-continue-btn" class="w-full btn-primary py-3 rounded-lg text-lg font-bold">Continuar a agendamiento</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Recursos Section -->
                <section id="page-recursos" class="page-section">
                     <div class="py-20 bg-[var(--color-background)]">
                        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
                            <h2 class="text-3xl font-bold text-center text-[var(--text-main)] font-poppins mb-12">Recursos y Preguntas Frecuentes</h2>
                            <div id="faq-accordion" class="space-y-4">
                                <!-- FAQ items will be inserted here by JS -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Contacto Section -->
                <section id="page-contacto" class="page-section">
                    <div class="py-20 bg-[var(--color-surface)]">
                        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                            <h2 class="text-3xl font-bold text-[var(--text-main)] font-poppins mb-8">Contáctame</h2>
                            <form id="contact-form" class="space-y-4">
                                <input type="text" id="contact-name" placeholder="Tu Nombre" required class="w-full p-3 rounded-lg border">
                                <input type="email" id="contact-email" placeholder="Tu Correo Electrónico" required class="w-full p-3 rounded-lg border">
                                <textarea id="contact-message" placeholder="Tu Mensaje" rows="5" required class="w-full p-3 rounded-lg border"></textarea>
                                <button type="submit" class="btn-secondary px-8 py-3 rounded-lg font-semibold text-lg">Enviar Mensaje</button>
                            </form>
                            <div class="mt-12">
                                <p class="text-[var(--text-muted)]">O contáctame directamente:</p>
                                <p class="font-semibold text-[var(--text-main)] mt-2">avmveterinaria@gmail.com</p>
                                <p class="text-[var(--text-muted)]">Santiago, Chile</p>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="bg-[#2F4F4F] text-white py-8">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-300">
                    <p>&copy; 2024 Dra. Alejandra Cautín. Todos los derechos reservados.</p>
                    <p class="text-sm mt-2">La información en este sitio es educativa y no reemplaza una consulta veterinaria directa.</p>
                </div>
            </footer>
        </div>
    </div>

    <!-- Main Application Container (Authenticated Users) -->
    <div id="app-container" class="hidden">
        <header class="bg-[#FFFFFF] shadow-md p-4 flex justify-between items-center no-print">
            <h1 class="text-xl font-bold text-[#4A4A4A]">Gestión Clínica Veterinaria</h1>
            <button id="logout-btn" class="btn-danger px-4 py-2 rounded-lg font-semibold">Cerrar Sesión</button>
        </header>

        <div id="app" class="max-w-5xl mx-auto p-4 md:p-8">
            <!-- ===== Dashboard View ===== -->
            <div id="view-dashboard" class="view">
                <main class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">Buscar Paciente</h2>
                        <div class="flex space-x-2">
                            <input id="search-input" type="text" placeholder="Nº de Ficha, Nombre o RUT" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 ring-accent">
                            <button id="search-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Buscar</button>
                        </div>
                        <div id="search-results" class="mt-4"></div>
                    </div>
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg flex flex-col items-center justify-center">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">Acciones</h2>
                        <button id="new-patient-btn" class="w-full btn-primary py-3 rounded-lg text-lg font-bold shadow-md transform hover:scale-105 transition-transform">+ Crear Ficha de Paciente</button>
                    </div>
                </main>
            </div>

            <!-- ===== Patient Hub View ===== -->
            <div id="view-patient-hub" class="view">
                <header class="flex justify-between items-center bg-[#FFFFFF] p-4 rounded-xl shadow-lg mb-6">
                    <div>
                        <h1 id="hub-patient-name" class="text-3xl font-bold text-[#4A4A4A] capitalize"></h1>
                        <p id="hub-patient-id" class="text-[#7F8B96]"></p>
                    </div>
                    <button class="back-to-dashboard-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver</button>
                </header>
                
                <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-[#4A4A4A]">Datos Principales</h2>
                        <button id="edit-patient-data-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold">Editar Datos</button>
                    </div>
                    <div id="hub-patient-summary" class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm"></div>
                </div>

                <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-[#4A4A4A]">Anamnesis Remota</h2>
                        <button id="save-hub-anamnesis-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold">Guardar Anamnesis</button>
                    </div>
                    <textarea id="hub-anamnesis-remota" rows="6" class="w-full p-2 border rounded-lg" placeholder="Antecedentes, alergias, historial de enfermedades importantes..."></textarea>
                </div>

                <div class="bg-[#FFFFFF] p-4 rounded-xl shadow-lg mb-6">
                    <div id="hub-section-buttons" class="flex flex-wrap gap-2">
                        <button data-section="consultas" class="hub-section-btn">Consultas</button>
                        <button data-section="vacunas" class="hub-section-btn">Vacunas</button>
                        <button data-section="desparasitacion" class="hub-section-btn">Desparasitación</button>
                        <button data-section="examenes" class="hub-section-btn">Exámenes</button>
                        <button data-section="certificados" class="hub-section-btn">Certificados</button>
                        <button data-section="recetas" class="hub-section-btn">Recetas</button>
                    </div>
                </div>

                <div id="hub-content-area">
                    <div id="hub-consultas-content" class="hub-section-content">
                        <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-[#4A4A4A]">Historial de Consultas</h2>
                                <button id="new-consultation-btn" class="btn-primary px-5 py-2 rounded-lg font-semibold text-lg">+ Nueva Consulta</button>
                            </div>
                            <div id="consultation-history-list" class="space-y-3"></div>
                        </div>
                    </div>
                    <div id="hub-recetas-content" class="hub-section-content hidden">
                        <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-[#4A4A4A]">Historial de Recetas</h2>
                                <button id="new-prescription-btn" class="btn-primary px-5 py-2 rounded-lg font-semibold text-lg">+ Nueva Receta</button>
                            </div>
                            <div id="prescription-history-list" class="space-y-3"></div>
                        </div>
                    </div>
                    <div id="hub-vacunas-content" class="hub-section-content hidden">
                        <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-[#4A4A4A]">Control de Vacunas</h2>
                                <button id="new-vaccine-btn" class="btn-primary px-5 py-2 rounded-lg font-semibold text-lg">+ Nueva Vacuna</button>
                            </div>
                            <div id="vaccine-history-table" class="overflow-x-auto"></div>
                        </div>
                    </div>
                    <div id="hub-desparasitacion-content" class="hub-section-content hidden">
                        <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-[#4A4A4A]">Control de Desparasitaciones</h2>
                                <button id="new-deworming-btn" class="btn-primary px-5 py-2 rounded-lg font-semibold text-lg">+ Nueva Desparasitación</button>
                            </div>
                            <div id="deworming-history-table" class="overflow-x-auto"></div>
                        </div>
                    </div>
                    <div id="hub-examenes-content" class="hub-section-content hidden">
                        <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-[#4A4A4A]">Exámenes</h2>
                                <div>
                                    <button id="new-exam-order-btn" class="btn-primary px-5 py-2 rounded-lg font-semibold text-lg mr-2">Crear Orden</button>
                                    <button id="new-exam-result-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold text-lg">Agregar Resultados</button>
                                </div>
                            </div>
                            <div id="exam-history-list" class="space-y-3"></div>
                        </div>
                    </div>
                    <div id="hub-certificados-content" class="hub-section-content hidden">
                        <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg">
                            <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">Emisión de Certificados</h2>
                            <p class="text-gray-600 mb-6">Selecciona una plantilla para comenzar a generar un certificado.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <button data-template="salud" class="certificate-template-btn btn-tertiary p-4 rounded-lg font-semibold text-center">Certificado de Salud</button>
                                <button data-template="viaje-nacional" class="certificate-template-btn btn-tertiary p-4 rounded-lg font-semibold text-center">Viaje Nacional</button>
                                <button data-template="viaje-internacional" class="certificate-template-btn btn-tertiary p-4 rounded-lg font-semibold text-center">Viaje Internacional (Exportación)</button>
                                <button data-template="implantacion-chip" class="certificate-template-btn btn-tertiary p-4 rounded-lg font-semibold text-center">Implantación de Chip</button>
                                <button data-template="validacion-chip" class="certificate-template-btn btn-tertiary p-4 rounded-lg font-semibold text-center">Validación de Chip</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== Edit Patient Data View ===== -->
            <div id="view-edit-patient-data" class="view">
                 <header class="flex justify-between items-center bg-[#FFFFFF] p-4 rounded-xl shadow-lg mb-6">
                    <h1 class="text-3xl font-bold text-[#4A4A4A]">Datos del Paciente</h1>
                    <button id="back-to-hub-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver a Ficha</button>
                </header>
                <form id="patient-data-form">
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg mb-6">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">I. Datos del Tutor</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="data-tutor-name" class="block text-sm font-medium">Nombre Completo:</label><input type="text" id="data-tutor-name"></div>
                            <div>
                                <label for="data-tutor-rut" class="block text-sm font-medium">Cédula de Identidad/DNI:</label>
                                <input type="text" id="data-tutor-rut">
                                <div id="rut-validation-message" class="validation-message"></div>
                            </div>
                            <div>
                                <label for="data-tutor-phone" class="block text-sm font-medium">Teléfono Principal:</label>
                                <input type="tel" id="data-tutor-phone">
                            </div>
                            <div><label for="data-tutor-phone2" class="block text-sm font-medium">Teléfono Secundario:</label><input type="tel" id="data-tutor-phone2"></div>
                            <div>
                                <label for="data-tutor-email" class="block text-sm font-medium">Correo Electrónico:</label>
                                <input type="email" id="data-tutor-email">
                            </div>
                            <div><label for="data-tutor-city" class="block text-sm font-medium">Ciudad/Comuna:</label><input type="text" id="data-tutor-city"></div>
                            <div class="md:col-span-2"><label for="data-tutor-address" class="block text-sm font-medium">Dirección Completa:</label><input type="text" id="data-tutor-address"></div>
                        </div>
                    </div>
                    <div class="bg-[#FFFFFF] p-6 rounded-xl shadow-lg mb-6">
                        <h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">II. Datos del Paciente</h2>
                        <p class="mb-4 text-lg"><strong>Nº de Ficha:</strong> <span id="data-ficha-number" class="text-highlight font-bold"></span></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div><label for="data-patient-name" class="block text-sm font-medium">Nombre del Paciente:</label><input type="text" id="data-patient-name" required></div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Especie:</label>
                                <div class="flex items-center gap-4">
                                    <label><input type="radio" name="species" value="Canina" class="form-radio"> Canina</label>
                                    <label><input type="radio" name="species" value="Felina" class="form-radio"> Felina</label>
                                    <label><input type="radio" name="species" value="Hurón" class="form-radio"> Hurón</label>
                                </div>
                            </div>
                            <div>
                                <label for="data-breed" class="block text-sm font-medium">Raza:</label>
                                <select id="data-breed"></select>
                            </div>
                            <div id="data-breed-other-container" class="hidden">
                                <label for="data-breed-other" class="block text-sm font-medium">Especificar Raza:</label>
                                <input type="text" id="data-breed-other">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Sexo:</label>
                                <div class="flex items-center gap-4"><label><input type="radio" name="sex" value="Macho" class="form-radio"> Macho</label><label><input type="radio" name="sex" value="Hembra" class="form-radio"> Hembra</label></div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-1">Estado Reproductivo:</label>
                                <div class="flex items-center gap-4"><label><input type="radio" name="reproductiveStatus" value="Entero" class="form-radio"> Entero</label><label><input type="radio" name="reproductiveStatus" value="Castrado" class="form-radio"> Castrado</label><label><input type="radio" name="reproductiveStatus" value="Esterilizada" class="form-radio"> Esterilizada</label></div>
                            </div>
                            <div><label for="data-birth-date" class="block text-sm font-medium">Fecha de Nacimiento (Estimada):</label><input type="date" id="data-birth-date"></div>
                            <div><label for="data-age" class="block text-sm font-medium">Edad Actual:</label><input type="text" id="data-age" readonly class="bg-gray-100"></div>
                            <div><label for="data-color-markings" class="block text-sm font-medium">Color/Señas Particulares:</label><input type="text" id="data-color-markings"></div>
                            <div><label for="data-microchip" class="block text-sm font-medium">Microchip (N°):</label><input type="text" id="data-microchip"></div>
                            <div><label for="data-weight" class="block text-sm font-medium">Peso Actual (kg):</label><input type="text" id="data-weight"></div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-1">Origen:</label>
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-2"><label><input type="radio" name="origin" value="Criadero" class="form-radio"> Criadero</label><label><input type="radio" name="origin" value="Refugio" class="form-radio"> Refugio</label><label><input type="radio" name="origin" value="Rescate" class="form-radio"> Rescate</label><label><input type="radio" name="origin" value="Particular" class="form-radio"> Particular</label><label class="flex items-center gap-2"><input type="radio" name="origin" value="Otro" class="form-radio"> Otro: <input type="text" id="data-origin-other" class="p-1 text-sm"></label></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center gap-4">
                        <button type="button" id="delete-patient-btn" class="btn-danger px-6 py-3 rounded-lg text-lg font-bold">Eliminar Paciente</button>
                        <button type="submit" class="btn-primary px-6 py-3 rounded-lg text-lg font-bold">Guardar Datos</button>
                    </div>
                </form>
            </div>

            <!-- ===== Prescription View (Generator) ===== -->
            <div id="view-prescription" class="view">
                 <header class="flex justify-between items-center mb-4 no-print">
                     <h1 class="text-3xl font-bold text-[#4A4A4A]">Generar Nueva Receta</h1>
                    <button class="back-to-hub-btn-from-rx bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver a Ficha</button>
                </header>
                <div id="prescription-content-generator" class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg">
                    <header class="text-center pb-4 border-b-2 border-gray-100">
                        <img src="https://alecautin8.github.io/AleVeterinaria/assets/logo1.png" alt="Logo" class="w-40 h-auto mx-auto mb-4" onerror="this.onerror=null; this.src='https://placehold.co/200x100/A3CBB2/FFFFFF?text=Logo';">
                        <h1 class="text-2xl font-bold text-[#4A4A4A]">Dra. Alejandra Cautín Bastías</h1>
                        <p class="text-[#7F8B96]">Médica Veterinaria</p>
                        <p class="text-xs italic mt-2">"Cuidar no es solo curar, es acompañar con conciencia."</p>
                    </header>
                    
                    <div class="my-6 p-4 bg-[#E0F5F0] rounded-lg no-print">
                        <label for="rx-email" class="block text-sm font-medium mb-1">Correo del Tutor para envío:</label>
                        <div class="flex items-center gap-2">
                            <input type="email" id="rx-email" placeholder="correo@example.com" class="w-full">
                            <button type="button" id="send-email-btn" class="btn-tertiary px-4 py-2 rounded-lg font-semibold text-sm">Enviar</button>
                        </div>
                    </div>

                    <section class="my-6 p-4 bg-[#E0F5F0] rounded-lg">
                        <h2 class="text-xl font-bold text-[#4A4A4A] mb-4 text-center">Recetario Terapéutico Personalizado</h2>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div><strong>Nº Ficha:</strong> <span id="rx-ficha-id"></span></div>
                            <div><strong>Tutor Responsable:</strong> <span id="rx-tutor-name"></span></div>
                            <div><strong>Paciente:</strong> <span id="rx-patient-name" class="capitalize"></span></div>
                            <div><strong>RUT:</strong> <span id="rx-tutor-rut"></span></div>
                            <div><strong>Especie:</strong> <span id="rx-species"></span></div>
                            <div><strong>Fecha:</strong> <span id="rx-date"></span></div>
                            <div><strong>Raza:</strong> <span id="rx-breed"></span></div>
                            <div><strong>Edad:</strong> <span id="rx-age"></span></div>
                        </div>
                    </section>

                    <p class="text-sm text-[#7F8B96] my-6 text-center">Este recetario fue elaborado de forma personalizada tras la evaluación clínica de su mascota. Cada indicación fue explicada detalladamente. Ante cualquier duda, <strong>no modifique la dosis ni el tratamiento sin consultar previamente</strong>.</p>
                    
                    <form id="prescription-form">
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-[#4A4A4A] mb-2 border-b pb-1">Tratamiento Indicado</h3>
                            <textarea id="rx-treatment-notes" rows="10" class="w-full p-2 border rounded-lg" placeholder="Medicamento, dosis, frecuencia..."></textarea>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-[#4A4A4A] mb-2 border-b pb-1">Indicaciones Adicionales</h3>
                            <textarea id="rx-indications-notes" rows="6" class="w-full p-2 border rounded-lg" placeholder="Dieta, cuidados, próximo control..."></textarea>
                        </div>

                        <div class="my-6 p-4 bg-[#E0F5F0] rounded-lg">
                            <h3 class="text-lg font-bold text-[#4A4A4A] mb-2">¿Qué hacer si...?</h3>
                            <ul class="list-disc list-inside text-sm space-y-1">
                                <li><strong>Olvida una dosis:</strong> Adminístrela tan pronto lo recuerde, a menos que ya sea casi la hora de la siguiente. En ese caso, omita la dosis olvidada y continúe con el horario regular. <strong>Nunca duplique la dosis.</strong></li>
                                <li><strong>Su mascota vomita la medicina:</strong> No repita la dosis sin consultar. Anote la hora y el medicamento y contacte a su veterinario.</li>
                                <li><strong>Nota efectos secundarios:</strong> Observe los síntomas (ej: letargo, diarrea, picazón) y contacte a su veterinario de inmediato.</li>
                            </ul>
                        </div>

                        <footer class="text-center mt-8 pt-8 border-t">
                            <p class="text-sm italic text-[#7F8B96] mb-4">Cuidar es un viaje, no un destino. Si necesita orientación, cuente conmigo.</p>
                            <div class="text-xs text-[#7F8B96] mb-8 space-y-1">
                                <p>📞 <strong>WhatsApp:</strong> +56 9 7604 0797</p>
                                <p>📧 <strong>Correo:</strong> avmveterinaria@gmail.com</p>
                                <p>📸 <strong>Instagram:</strong> @AleVeterinaria | Santiago, Chile</p>
                            </div>
                            <div class="grid grid-cols-2 gap-8 text-left mt-12">
                                <div>
                                    <p class="font-bold text-[#4A4A4A] mb-2">Timbre Médico:</p>
                                    <div class="h-24 border border-gray-300 border-dashed rounded-md flex items-center justify-center">
                                        <img id="rx-timbre" src="https://alecautin8.github.io/AleVeterinaria/assets/timbre.png" alt="Timbre Médico" class="max-h-full max-w-full object-contain p-2" onerror="this.onerror=null; this.src='https://placehold.co/150x100/CFEDEC/4B4B4B?text=Timbre';">
                                    </div>
                                </div>
                                <div>
                                    <p class="font-bold text-[#4A4A4A] mb-2">Firma del Médico:</p>
                                    <div class="h-24 border-b-2 border-gray-500 flex flex-col justify-end items-center">
                                        <p class="font-semibold">Dra. Alejandra Cautín Bastías</p>
                                    </div>
                                </div>
                            </div>
                        </footer>
                        <div class="flex justify-end items-center gap-4 mt-8 no-print">
                            <button type="button" id="download-pdf-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Descargar PDF</button>
                            <button type="submit" class="btn-primary px-5 py-2 rounded-lg font-semibold">Guardar Receta</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- ===== Printable Exam Order View ===== -->
            <div id="view-exam-order-printable" class="view">
                 <header class="flex justify-between items-center mb-4 no-print">
                     <h1 class="text-3xl font-bold text-[#4A4A4A]">Orden de Examen</h1>
                    <button class="back-to-hub-btn-from-exam-order bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver a Ficha</button>
                </header>
                <div id="exam-order-content-generator" class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg">
                    <header class="text-center pb-4 border-b-2 border-gray-100">
                        <img src="https://alecautin8.github.io/AleVeterinaria/assets/logo1.png" alt="Logo" class="w-40 h-auto mx-auto mb-4" onerror="this.onerror=null; this.src='https://placehold.co/200x100/A3CBB2/FFFFFF?text=Logo';">
                        <h1 class="text-2xl font-bold text-[#4A4A4A]">Dra. Alejandra Cautín Bastías</h1>
                        <p class="text-[#7F8B96]">Médica Veterinaria</p>
                    </header>
                    
                    <div class="my-6 p-4 bg-[#E0F5F0] rounded-lg no-print">
                        <label for="exam-order-email" class="block text-sm font-medium mb-1">Correo del Tutor para envío:</label>
                        <div class="flex items-center gap-2">
                            <input type="email" id="exam-order-email" placeholder="correo@example.com" class="w-full">
                            <button type="button" id="send-exam-order-email-btn" class="btn-tertiary px-4 py-2 rounded-lg font-semibold text-sm">Enviar</button>
                        </div>
                    </div>

                    <section class="my-6 p-4 bg-[#E0F5F0] rounded-lg">
                        <h2 class="text-xl font-bold text-[#4A4A4A] mb-4 text-center">Orden de Examen</h2>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div><strong>Nº Ficha:</strong> <span id="exam-order-ficha-id"></span></div>
                            <div><strong>Tutor:</strong> <span id="exam-order-tutor-name"></span></div>
                            <div><strong>Paciente:</strong> <span id="exam-order-patient-name" class="capitalize"></span></div>
                            <div><strong>RUT:</strong> <span id="exam-order-tutor-rut"></span></div>
                            <div><strong>Especie:</strong> <span id="exam-order-species"></span></div>
                            <div><strong>Fecha Orden:</strong> <span id="exam-order-printable-date"></span></div>
                        </div>
                    </section>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-[#4A4A4A] mb-2 border-b pb-1">Exámenes Solicitados</h3>
                        <p id="exam-order-details" class="whitespace-pre-wrap p-2 bg-gray-50 rounded-lg"></p>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-[#4A4A4A] mb-2 border-b pb-1">Indicaciones para el Tutor</h3>
                        <p id="exam-order-printable-instructions" class="whitespace-pre-wrap p-2 bg-gray-50 rounded-lg"></p>
                    </div>

                    <footer class="text-center mt-8 pt-8 border-t">
                        <div class="grid grid-cols-2 gap-8 text-left mt-12">
                            <div>
                                <p class="font-bold text-[#4A4A4A] mb-2">Timbre Médico:</p>
                                <div class="h-24 border border-gray-300 border-dashed rounded-md flex items-center justify-center">
                                    <img src="https://alecautin8.github.io/AleVeterinaria/assets/timbre.png" alt="Timbre Médico" class="max-h-full max-w-full object-contain p-2" onerror="this.onerror=null; this.src='https://placehold.co/150x100/CFEDEC/4B4B4B?text=Timbre';">
                                </div>
                            </div>
                            <div>
                                <p class="font-bold text-[#4A4A4A] mb-2">Firma del Médico:</p>
                                <div class="h-24 border-b-2 border-gray-500"></div>
                            </div>
                        </div>
                    </footer>
                    <div class="flex justify-end items-center gap-4 mt-8 no-print">
                        <button type="button" id="download-exam-order-pdf-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Descargar PDF</button>
                    </div>
                </div>
            </div>

            <!-- ===== Simple Certificate Generator View ===== -->
            <div id="view-certificate-generator" class="view">
                 <header class="flex justify-between items-center mb-4 no-print">
                     <h1 id="certificate-generator-title" class="text-3xl font-bold text-[#4A4A4A]"></h1>
                    <button class="back-to-hub-btn-from-certificate bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver a Ficha</button>
                </header>
                <div id="certificate-content-generator" class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg">
                    <header class="text-center pb-4 border-b-2 border-gray-100">
                        <img src="https://alecautin8.github.io/AleVeterinaria/assets/logo1.png" alt="Logo" class="w-40 h-auto mx-auto mb-4" onerror="this.onerror=null; this.src='https://placehold.co/200x100/A3CBB2/FFFFFF?text=Logo';">
                        <h1 class="text-2xl font-bold text-[#4A4A4A]">Dra. Alejandra Cautín Bastías</h1>
                        <p class="text-[#7F8B96]">Médica Veterinaria</p>
                    </header>
                    
                    <div class="my-6 p-4 bg-[#E0F5F0] rounded-lg no-print">
                        <label for="certificate-email" class="block text-sm font-medium mb-1">Correo del Tutor para envío:</label>
                        <div class="flex items-center gap-2">
                            <input type="email" id="certificate-email" placeholder="correo@example.com" class="w-full">
                            <button type="button" id="send-certificate-email-btn" class="btn-tertiary px-4 py-2 rounded-lg font-semibold text-sm">Enviar</button>
                        </div>
                    </div>

                    <h2 id="certificate-title" class="text-2xl font-bold text-center my-6"></h2>
                    
                    <div id="certificate-body" class="text-justify space-y-4 leading-relaxed">
                        <!-- Certificate content will be injected here -->
                    </div>

                    <footer class="text-center mt-12 pt-8 border-t">
                        <div class="grid grid-cols-2 gap-8 text-left mt-12">
                            <div>
                                <p class="font-bold text-[#4A4A4A] mb-2">Timbre Médico:</p>
                                <div class="h-24 border border-gray-300 border-dashed rounded-md flex items-center justify-center">
                                    <img src="https://alecautin8.github.io/AleVeterinaria/assets/timbre.png" alt="Timbre Médico" class="max-h-full max-w-full object-contain p-2" onerror="this.onerror=null; this.src='https://placehold.co/150x100/CFEDEC/4B4B4B?text=Timbre';">
                                </div>
                            </div>
                            <div>
                                <p class="font-bold text-[#4A4A4A] mb-2">Firma del Médico:</p>
                                <div class="h-24 border-b-2 border-gray-500"></div>
                            </div>
                        </div>
                    </footer>
                    <div class="flex justify-end items-center gap-4 mt-8 no-print">
                        <button type="button" id="download-certificate-pdf-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Descargar PDF</button>
                    </div>
                </div>
            </div>

            <!-- ===== Certificado de Viaje Internacional View ===== -->
            <div id="view-international-travel-certificate" class="view">
                 <header class="flex justify-between items-center mb-4 no-print">
                    <h1 class="text-3xl font-bold text-[#4A4A4A]">Certificado de Salud para Exportación</h1>
                    <div class="flex gap-2">
                        <button id="download-international-cert-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Descargar PDF</button>
                        <button class="back-to-hub-btn-from-cert bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver a Ficha</button>
                    </div>
                </header>
                <div id="international-cert-content" class="bg-white p-8 rounded-xl shadow-lg printable-cert">
                    <h1 class="text-center font-bold text-lg mb-6">CERTIFICADO DE SALUD PARA LA EXPORTACIÓN DE ANIMALES DE COMPAÑÍA (PERROS, GATOS O HURONES)</h1>
                    
                    <section class="cert-section">
                        <h2>1) Identificación del animal de compañía:</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                            <div class="cert-field"><strong>Nombre:</strong> <span id="cert-animal-nombre" class="ml-2"></span></div>
                            <div class="cert-field"><strong>Especie:</strong> <span id="cert-animal-especie" class="ml-2"></span></div>
                            <div class="cert-field"><strong>Raza:</strong> <span id="cert-animal-raza" class="ml-2"></span></div>
                            <div class="cert-field"><strong>Sexo:</strong> <span id="cert-animal-sexo" class="ml-2"></span></div>
                            <div class="cert-field"><strong>Color:</strong> <span id="cert-animal-color" class="ml-2"></span></div>
                            <div class="cert-field"><strong>Fecha de nacimiento o edad:</strong> <span id="cert-animal-edad" class="ml-2"></span></div>
                            <div class="cert-field"><strong>N° de microchip:</strong> <span id="cert-animal-microchip" class="ml-2"></span></div>
                        </div>
                    </section>
            
                    <section class="cert-section">
                        <h2>2) Identificación del Dueño:</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                            <div class="cert-field"><strong>Nombre:</strong> <span id="cert-dueno-nombre" class="ml-2"></span></div>
                            <div class="cert-field"><strong>RUN/RUT:</strong> <span id="cert-dueno-rut" class="ml-2"></span></div>
                            <div class="cert-field"><strong>Teléfono:</strong> <span id="cert-dueno-telefono" class="ml-2"></span></div>
                            <div class="cert-field md:col-span-2"><strong>Dirección:</strong> <span id="cert-dueno-direccion" class="ml-2"></span></div>
                        </div>
                    </section>
            
                    <section class="cert-section">
                        <h2>3) El médico veterinario que suscribe certifica que el animal de compañía:</h2>
                        <ul class="list-disc list-inside text-sm space-y-2">
                            <li>Se encuentra clínicamente sano al examen físico, sin presentar tumoraciones, heridas frescas o en proceso de cicatrización, ni signo alguno de enfermedades infectocontagiosas, cuarentenables o transmisibles, ni presencia de parásitos externos y ha sido tratado contra estos últimos.</li>
                            <li>Se encuentra inscrito o se ha solicitado su inscripción en el Registro Nacional de Mascotas.</li>
                        </ul>
                    </section>

                    <div id="cert-anexo-container"></div>
            
                    <section class="cert-section mt-8">
                        <h2>4) Datos del médico veterinario firmante:</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                            <div class="cert-field"><strong>Nombre:</strong> <span class="ml-2">Alejandra Cautín Bastías</span></div>
                            <div class="cert-field"><strong>RUN/RUT:</strong> <span class="ml-2">12.345.678-9</span></div>
                            <div class="cert-field"><strong>Teléfono:</strong> <span class="ml-2">+56 9 7604 0797</span></div>
                            <div class="cert-field md:col-span-2"><strong>Dirección:</strong> <span class="ml-2">Santiago, Chile</span></div>
                            <div class="cert-field md:col-span-2">
                                <strong>Fecha de la inspección física:</strong> 
                                <span id="cert-fecha-inspeccion" class="ml-2"></span>
                                <em class="ml-4 text-xs text-gray-500">*No debe ser mayor a 10 días previos a la fecha del embarque.</em>
                            </div>
                        </div>
                    </section>
                     <p class="text-xs text-gray-600 mt-6">Nota: Los requisitos específicos según el destino deben adjuntarse a este certificado.</p>
                </div>
            </div>

            <!-- Comprobante de Microchip View -->
            <div id="view-microchip-certificate" class="view">
                <header class="flex justify-between items-center mb-4 no-print">
                    <h1 class="text-3xl font-bold text-[#4A4A4A]">Comprobante de Existencia de Microchip</h1>
                    <div class="flex gap-2">
                        <button id="download-microchip-cert-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Descargar PDF</button>
                        <button class="back-to-hub-btn-from-cert bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver a Ficha</button>
                    </div>
                </header>
                <div id="microchip-cert-content" class="bg-white p-8 rounded-xl shadow-lg printable-cert font-sans">
                    <header class="flex justify-between items-center pb-4 border-b">
                        <div>
                            <h2 class="font-bold text-xl">Comprobante de Existencia para registro con microchip</h2>
                            <p class="text-sm">Mascotas y Animales de Compañía</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg">SUBDERE</p>
                            <p class="text-xs">Gobierno de Chile</p>
                        </div>
                    </header>
        
                    <div class="grid grid-cols-4 gap-6 mt-6">
                        <div class="col-span-3">
                            <section class="mb-6">
                                <h3 class="font-bold border-b pb-1 mb-2">DATOS ANIMAL</h3>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                    <p><strong>Nombre:</strong> <span id="mc-animal-nombre"></span></p>
                                    <div class="flex items-center">
                                        <strong class="mr-2">Especie:</strong>
                                        <div class="checkbox-label"><span id="mc-animal-especie-perro" class="checkbox-symbol">☐</span> Perro</div>
                                        <div class="checkbox-label"><span id="mc-animal-especie-gato" class="checkbox-symbol">☐</span> Gato</div>
                                    </div>
                                    <p><strong>Raza:</strong> <span id="mc-animal-raza"></span></p>
                                    <div class="flex items-center">
                                        <strong class="mr-2">Sexo:</strong>
                                        <div class="checkbox-label"><span id="mc-animal-sexo-macho" class="checkbox-symbol">☐</span> Macho</div>
                                        <div class="checkbox-label"><span id="mc-animal-sexo-hembra" class="checkbox-symbol">☐</span> Hembra</div>
                                    </div>
                                    <p><strong>Color:</strong> <span id="mc-animal-color"></span></p>
                                    <div class="flex items-center">
                                        <strong class="mr-2">Esterilizado:</strong>
                                        <div class="checkbox-label"><span id="mc-animal-esterilizado-si" class="checkbox-symbol">☐</span> Sí</div>
                                        <div class="checkbox-label"><span id="mc-animal-esterilizado-no" class="checkbox-symbol">☐</span> No</div>
                                    </div>
                                    <p><strong>Fecha nacimiento:</strong> <span id="mc-animal-fecha-nacimiento"></span></p>
                                </div>
                            </section>
                        </div>
                        <div class="col-span-1">
                            <div class="border-2 border-dashed h-full flex items-center justify-center p-2 text-center text-gray-500 text-sm">
                                Pegue aquí la etiqueta del microchip
                            </div>
                        </div>
                    </div>
        
                    <section class="grid grid-cols-3 gap-4 text-sm mb-6">
                        <div>
                            <h3 class="font-bold mb-1">Tipo de procedimiento:</h3>
                            <div class="checkbox-label"><span id="mc-proc-implantacion" class="checkbox-symbol">☐</span> Implantación</div>
                            <div class="checkbox-label"><span id="mc-proc-verificacion" class="checkbox-symbol">☐</span> Verificación</div>
                        </div>
                        <div>
                            <h3 class="font-bold mb-1">Modo de obtención:</h3>
                            <div class="checkbox-label"><span id="mc-obt-recogido" class="checkbox-symbol">☐</span> Recogido</div>
                            <div class="checkbox-label"><span id="mc-obt-reubicacion" class="checkbox-symbol">☐</span> Reubicación</div>
                            <div class="checkbox-label"><span id="mc-obt-regalo" class="checkbox-symbol">☐</span> Regalo</div>
                            <div class="checkbox-label"><span id="mc-obt-nacido" class="checkbox-symbol">☐</span> Nacido en casa</div>
                            <div class="checkbox-label"><span id="mc-obt-compra" class="checkbox-symbol">☐</span> Compra</div>
                        </div>
                        <div>
                            <h3 class="font-bold mb-1">Razón Tenencia:</h3>
                            <div class="checkbox-label"><span id="mc-ten-compania" class="checkbox-symbol">☐</span> Compañía</div>
                            <div class="checkbox-label"><span id="mc-ten-asistencia" class="checkbox-symbol">☐</span> Asistencia</div>
                            <div class="checkbox-label"><span id="mc-ten-terapia" class="checkbox-symbol">☐</span> Terapia</div>
                        </div>
                    </section>
        
                    <section class="mb-6">
                        <h3 class="font-bold border-b pb-1 mb-2">DATOS MÉDICO VETERINARIO</h3>
                         <p class="text-xs text-gray-500 mb-2">*En el caso del Tipo de procedimiento 'Verificación', los datos pueden ser de un Técnico Veterinario.</p>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <p><strong>Nombres:</strong> <span>Alejandra</span></p>
                            <p><strong>Apellidos:</strong> <span>Cautín Bastías</span></p>
                            <p><strong>Rut:</strong> <span>12.345.678-9</span></p>
                            <p><strong>Comuna:</strong> <span>Santiago</span></p>
                            <div>
                                <strong class="mr-2">Calidad:</strong>
                                <div class="checkbox-label inline-flex"><span class="checkbox-symbol">☑</span> Médico Veterinario</div>
                                <div class="checkbox-label inline-flex"><span class="checkbox-symbol">☐</span> Técnico Veterinario</div>
                            </div>
                            <p><strong>Fecha procedimiento:</strong> <span id="mc-fecha-procedimiento"></span></p>
                        </div>
                        <div class="mt-8 pt-8 text-center">
                            <div class="inline-block border-t-2 w-64">
                                <p class="text-sm">Firma y Timbre</p>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Modals ===== -->
    <div id="login-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60">
        <div class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg w-full max-w-md m-4 relative">
            <button id="close-login-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-[#4A4A4A] mb-6">Iniciar Sesión</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-[#7F8B96] mb-1">Correo Electrónico</label>
                    <input id="login-email" type="email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 ring-accent">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-[#7F8B96] mb-1">Contraseña</label>
                    <input id="login-password" type="password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 ring-accent">
                </div>
                <button id="login-btn" type="submit" class="w-full btn-secondary py-3 rounded-lg text-lg font-bold shadow-md transform hover:scale-105 transition-transform">Ingresar</button>
            </form>
        </div>
    </div>
    <div id="notification-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50"><div class="bg-[#FFFFFF] rounded-xl shadow-xl p-8 m-4 max-w-sm text-center"><p id="notification-message" class="text-lg text-[#4A4A4A]"></p><button id="notification-close-btn" class="mt-6 btn-secondary px-5 py-2 rounded-lg font-semibold">Cerrar</button></div></div>
    <div id="delete-confirmation-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50"><div class="bg-[#FFFFFF] rounded-xl shadow-xl p-8 m-4 max-w-sm text-center"><h3 class="text-xl font-bold text-gray-800">Confirmar Eliminación</h3><p id="delete-confirmation-message" class="text-[#7F8B96] my-4"></p><p class="text-sm text-red-600 font-semibold">Esta acción no se puede deshacer.</p><div class="flex justify-center gap-4 mt-6"><button id="cancel-delete-btn" class="bg-gray-300 px-5 py-2 rounded-lg font-semibold">Cancelar</button><button id="confirm-delete-btn" class="btn-danger px-5 py-2 rounded-lg font-semibold">Eliminar Permanentemente</button></div></div></div>
    <div id="consultation-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 p-4"><div class="bg-[#FFFFFF] rounded-xl shadow-xl p-6 m-4 max-w-4xl w-full flex flex-col"><h2 class="text-2xl font-bold text-[#4A4A4A] mb-4">Nueva Consulta</h2><form id="consultation-form" class="space-y-6 overflow-y-auto pr-4 modal-content"><section><h3 class="text-lg font-medium text-[#4A4A4A] mb-2">Anamnesis Remota (Editable)</h3><textarea id="modal-anamnesis-remota" rows="4" class="w-full p-2 border rounded-lg"></textarea></section><section><h3 class="text-lg font-medium section-header">III. Historial Médico</h3><h4 class="text-md font-semibold text-[#4A4A4A] mb-2">A. Motivo de Consulta (MC)</h4><div class="grid grid-cols-1 gap-4"><div><label for="modal-mc-fecha" class="block text-sm">Fecha de Consulta:</label><input type="date" id="modal-mc-fecha"></div><div><label for="modal-mc-sintomas" class="block text-sm">Síntomas Principales y Duración:</label><textarea id="modal-mc-sintomas" rows="2"></textarea></div></div><h4 class="text-md font-semibold text-[#4A4A4A] mt-4 mb-2">B. Anamnesis (de la consulta)</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="modal-anamnesis-sintomas" class="block text-sm">Síntomas Adicionales:</label><textarea id="modal-anamnesis-sintomas" rows="2"></textarea></div><div><label for="modal-anamnesis-cambios" class="block text-sm">Cambios Recientes:</label><textarea id="modal-anamnesis-cambios" rows="2"></textarea></div><div><label for="modal-anamnesis-medicamentos" class="block text-sm">Medicamentos Actuales:</label><input type="text" id="modal-anamnesis-medicamentos"></div><div><label for="modal-anamnesis-historial" class="block text-sm">Historial Enfermedades/Cirurgías:</label><textarea id="modal-anamnesis-historial" rows="2"></textarea></div><div><label for="modal-anamnesis-alergias" class="block text-sm">Alergias Conocidas:</label><input type="text" id="modal-anamnesis-alergias"></div><div><label for="modal-anamnesis-habitos" class="block text-sm">Hábitos de Eliminación:</label><input type="text" id="modal-anamnesis-habitos"></div><div><label for="modal-anamnesis-dieta" class="block text-sm">Dieta Actual:</label><input type="text" id="modal-anamnesis-dieta"></div><div><label for="modal-anamnesis-actividad" class="block text-sm">Nivel de Actividad:</label><input type="text" id="modal-anamnesis-actividad"></div><div class="md:col-span-2"><label for="modal-anamnesis-ambiente" class="block text-sm">Ambiente:</label><input type="text" id="modal-anamnesis-ambiente"></div></div></section><section><h3 class="text-lg font-medium section-header">IV. Examen Físico General</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div><label for="modal-efg-temp" class="block text-sm">Temp:</label><input type="text" id="modal-efg-temp"></div><div><label for="modal-efg-fc" class="block text-sm">FC:</label><input type="text" id="modal-efg-fc"></div><div><label for="modal-efg-fr" class="block text-sm">FR:</label><input type="text" id="modal-efg-fr"></div><div><label for="modal-efg-trc" class="block text-sm">TRC:</label><input type="text" id="modal-efg-trc"></div></div><div class="mt-4"><label for="modal-efg-hallazgos" class="block text-sm">Hallazgos Examen Físico:</label><textarea id="modal-efg-hallazgos" rows="4"></textarea></div></section><section><h3 class="text-lg font-medium section-header">V. Diagnóstico y Plan</h3><div><label for="modal-diag-presuntivo" class="block text-sm">Diagnóstico Presuntivo:</label><textarea id="modal-diag-presuntivo" rows="2"></textarea></div><div class="mt-4"><label for="modal-diag-diferencial" class="block text-sm">Diagnóstico Diferencial:</label><textarea id="modal-diag-diferencial" rows="2"></textarea></div><div class="mt-4"><label for="modal-plan-terapeutico" class="block text-sm">Plan Terapéutico:</label><textarea id="modal-plan-terapeutico" rows="3"></textarea></div></section><section><h3 class="text-lg font-medium section-header">VI. Notas Adicionales y Seguimiento</h3><div><label for="modal-notas-adicionales" class="block text-sm">Observaciones Veterinarias:</label><textarea id="modal-notas-adicionales" rows="3"></textarea></div><div class="mt-4"><label for="modal-proxima-cita" class="block text-sm">Próxima Cita/Revisión:</label><input type="text" id="modal-proxima-cita"></div></section><div class="flex justify-end gap-4 mt-4 pt-4 border-t"><button id="cancel-consultation-btn" type="button" class="bg-gray-300 px-4 py-2 rounded-lg">Cancelar</button><button id="save-consultation-btn" type="submit" class="btn-primary px-4 py-2 rounded-lg">Guardar Consulta</button></div></form></div></div>
    <div id="vaccine-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60">
        <div class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg w-full max-w-lg m-4 relative">
            <button id="close-vaccine-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-[#4A4A4A] mb-6">Registrar Vacuna</h2>
            <form id="vaccine-form" class="space-y-4">
                <div>
                    <label for="vaccine-date" class="block text-sm font-medium text-[#7F8B96] mb-1">Fecha de Aplicación</label>
                    <input id="vaccine-date" type="date" required class="w-full">
                </div>
                <div>
                    <label for="vaccine-type" class="block text-sm font-medium text-[#7F8B96] mb-1">Tipo de Vacuna</label>
                    <select id="vaccine-type" required class="w-full"></select>
                </div>
                <div>
                    <label for="vaccine-brand" class="block text-sm font-medium text-[#7F8B96] mb-1">Marca y Lote</label>
                    <input id="vaccine-brand" type="text" placeholder="Ej: Nobivac KC, Lote 12345" class="w-full">
                </div>
                <div>
                    <label for="vaccine-next-dose" class="block text-sm font-medium text-[#7F8B96] mb-1">Próxima Dosis</label>
                    <input id="vaccine-next-dose" type="date" class="w-full">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-vaccine-btn" class="bg-gray-300 px-5 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" class="btn-primary px-5 py-2 rounded-lg font-semibold">Guardar Vacuna</button>
                </div>
            </form>
        </div>
    </div>
    <div id="deworming-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60">
        <div class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg w-full max-w-lg m-4 relative">
            <button id="close-deworming-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-[#4A4A4A] mb-6">Registrar Desparasitación</h2>
            <form id="deworming-form" class="space-y-4">
                <div>
                    <label for="deworming-date" class="block text-sm font-medium text-[#7F8B96] mb-1">Fecha de Aplicación</label>
                    <input id="deworming-date" type="date" required class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-[#7F8B96] mb-1">Tipo</label>
                    <div class="flex items-center gap-4">
                        <label><input type="radio" name="deworming-type" value="Interna" class="form-radio" checked> Interna</label>
                        <label><input type="radio" name="deworming-type" value="Externa" class="form-radio"> Externa</label>
                    </div>
                </div>
                <div>
                    <label for="deworming-product" class="block text-sm font-medium text-[#7F8B96] mb-1">Producto Utilizado</label>
                    <input id="deworming-product" type="text" placeholder="Ej: Drontal, Bravecto..." class="w-full">
                </div>
                <div>
                    <label for="deworming-next-dose" class="block text-sm font-medium text-[#7F8B96] mb-1">Próxima Dosis</label>
                    <input id="deworming-next-dose" type="date" class="w-full">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-deworming-btn" class="bg-gray-300 px-5 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" class="btn-primary px-5 py-2 rounded-lg font-semibold">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="exam-order-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60 p-4">
        <div class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg w-full max-w-2xl m-4 relative flex flex-col modal-content">
            <button id="close-exam-order-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-[#4A4A4A] mb-6 flex-shrink-0">Crear Orden de Examen</h2>
            <form id="exam-order-form" class="space-y-4 flex-grow flex flex-col min-h-0">
                <div class="flex-shrink-0">
                    <label for="exam-order-date" class="block text-sm font-medium text-[#7F8B96] mb-1">Fecha de Orden</label>
                    <input id="exam-order-date" type="date" required class="w-full">
                </div>
                
                <div class="flex-grow flex flex-col min-h-0 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="relative">
                            <label class="block text-sm font-medium text-[#7F8B96] mb-1">Exámenes de Laboratorio</label>
                            <button type="button" id="lab-exam-select-button" class="w-full bg-white border border-gray-300 rounded-lg p-2 text-left flex justify-between items-center">
                                <span id="lab-exam-select-placeholder" class="text-gray-500">Seleccionar...</span>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="lab-exam-select-dropdown" class="absolute z-10 w-full bg-white border rounded-lg mt-1 hidden max-h-60 overflow-y-auto">
                                <!-- Lab exam checkboxes will be populated here -->
                            </div>
                        </div>
                        <div class="relative">
                            <label class="block text-sm font-medium text-[#7F8B96] mb-1">Exámenes de Imágenes</label>
                            <button type="button" id="imaging-exam-select-button" class="w-full bg-white border border-gray-300 rounded-lg p-2 text-left flex justify-between items-center">
                                <span id="imaging-exam-select-placeholder" class="text-gray-500">Seleccionar...</span>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="imaging-exam-select-dropdown" class="absolute z-10 w-full bg-white border rounded-lg mt-1 hidden max-h-60 overflow-y-auto">
                                <!-- Imaging exam checkboxes will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-[#7F8B96] mb-1">Exámenes Seleccionados:</label>
                        <div id="selected-exams-container" class="p-2 border rounded-lg bg-gray-50 min-h-[5rem] flex flex-wrap gap-2">
                            <p class="text-sm text-gray-400">Ningún examen seleccionado.</p>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0">
                    <label for="exam-order-instructions" class="block text-sm font-medium text-[#7F8B96] mb-1">Indicaciones para el Tutor</label>
                    <textarea id="exam-order-instructions" rows="4" placeholder="Las indicaciones se agregarán automáticamente..." class="w-full"></textarea>
                </div>
                <div class="flex justify-end gap-4 pt-4 flex-shrink-0">
                    <button type="button" id="cancel-exam-order-btn" class="bg-gray-300 px-5 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" class="btn-primary px-5 py-2 rounded-lg font-semibold">Guardar Orden</button>
                </div>
            </form>
        </div>
    </div>
    <div id="exam-result-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60">
        <div class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg w-full max-w-lg m-4 relative">
            <button id="close-exam-result-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-[#4A4A4A] mb-6">Agregar Resultados de Examen</h2>
            <form id="exam-result-form" class="space-y-4">
                <div>
                    <label for="exam-result-date" class="block text-sm font-medium text-[#7F8B96] mb-1">Fecha de Resultados</label>
                    <input id="exam-result-date" type="date" required class="w-full">
                </div>
                <div>
                    <label for="exam-result-description" class="block text-sm font-medium text-[#7F8B96] mb-1">Descripción</label>
                    <input id="exam-result-description" type="text" placeholder="Ej: Resultados de Perfil Bioquímico" class="w-full">
                </div>
                <div>
                    <label for="exam-result-file" class="block text-sm font-medium text-[#7F8B96] mb-1">Adjuntar Archivo (PDF, JPG, etc.)</label>
                    <input id="exam-result-file" type="file" class="w-full">
                    <p id="file-upload-status" class="text-xs text-[var(--text-muted)] mt-1"></p>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-exam-result-btn" class="bg-gray-300 px-5 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" class="btn-primary px-5 py-2 rounded-lg font-semibold">Guardar Resultados</button>
                </div>
            </form>
        </div>
    </div>
    <div id="service-detail-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60">
        <div class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg w-full max-w-lg m-4 relative">
            <button id="close-service-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 id="service-modal-title" class="text-2xl font-bold text-center text-[#4A4A4A] mb-6"></h2>
            <p id="service-modal-description" class="text-[#7F8B96]"></p>
        </div>
    </div>
    
    <div id="certificate-details-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60 p-4">
        <div class="bg-[#FFFFFF] p-8 rounded-xl shadow-lg w-full max-w-lg m-4 relative modal-content">
            <button id="close-certificate-details-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 id="certificate-modal-title" class="text-2xl font-bold text-center text-[#4A4A4A] mb-6">Detalles del Certificado</h2>
            <form id="certificate-details-form" class="space-y-4">
                <!-- Campos para viaje -->
                <div id="certificate-form-destination-container" class="hidden">
                    <label for="certificate-destination" class="block text-sm font-medium text-[#7F8B96] mb-1">País de Destino</label>
                    <input id="certificate-destination" type="text" class="w-full">
                </div>
                <div id="certificate-form-travel-date-container" class="hidden">
                    <label for="certificate-travel-date" class="block text-sm font-medium text-[#7F8B96] mb-1">Fecha de Viaje / Embarque</label>
                    <input id="certificate-travel-date" type="date" class="w-full">
                </div>
                
                <!-- Campos para Microchip -->
                <div id="certificate-form-microchip-container" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-[#7F8B96] mb-2">Modo de obtención</label>
                        <select id="certificate-obtencion" class="w-full">
                            <option value="Recogido">Recogido</option>
                            <option value="Reubicacion">Reubicación</option>
                            <option value="Regalo">Regalo</option>
                            <option value="Nacido en casa">Nacido en casa</option>
                            <option value="Compra">Compra</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-[#7F8B96] mb-2">Razón de Tenencia Principal</label>
                        <select id="certificate-tenencia" class="w-full">
                            <option value="Compañia">Compañía</option>
                            <option value="Asistencia">Asistencia</option>
                            <option value="Terapia">Terapia</option>
                            <option value="Trabajo">Trabajo</option>
                            <option value="Seguridad">Seguridad</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-certificate-details-btn" class="bg-gray-300 px-5 py-2 rounded-lg font-semibold">Cancelar</button>
                    <button type="submit" class="btn-primary px-5 py-2 rounded-lg font-semibold">Generar Certificado</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Main Application Logic -->
    <script type="module">
        // --- Application State ---
        let currentPatientId = null;
        let currentPatientSpecies = null;
        let currentPatientData = null;
        let currentCertificateTemplate = null;

        // --- DOM Element References ---
        const views = {
            landing: document.getElementById('view-landing'),
            dashboard: document.getElementById('view-dashboard'),
            patientHub: document.getElementById('view-patient-hub'),
            editPatientData: document.getElementById('view-edit-patient-data'),
            prescription: document.getElementById('view-prescription'),
            examOrderPrintable: document.getElementById('view-exam-order-printable'),
            certificateGenerator: document.getElementById('view-certificate-generator'),
            internationalTravelCertificate: document.getElementById('view-international-travel-certificate'),
            microchipCertificate: document.getElementById('view-microchip-certificate'),
        };
        const appContainer = document.getElementById('app-container');
        const modals = { 
            login: document.getElementById('login-modal'),
            notification: document.getElementById('notification-modal'),
            consultation: document.getElementById('consultation-modal'),
            deleteConfirmation: document.getElementById('delete-confirmation-modal'),
            vaccine: document.getElementById('vaccine-modal'),
            deworming: document.getElementById('deworming-modal'),
            examOrder: document.getElementById('exam-order-modal'),
            examResult: document.getElementById('exam-result-modal'),
            serviceDetail: document.getElementById('service-detail-modal'),
            certificateDetails: document.getElementById('certificate-details-modal'),
        };
        
        // --- Navigation & Modal Functions ---
        function navigateTo(viewName, patientId = null) {
            currentPatientId = patientId;
            Object.values(views).forEach(v => v.classList.remove('active'));
            if (views[viewName]) {
                views[viewName].classList.add('active');
            } else if (viewName !== 'landing') {
                views.dashboard.classList.add('active');
            }
            window.scrollTo(0, 0);
        }
        function showModal(modalName) { if(modals[modalName]) modals[modalName].classList.add('active'); }
        function hideModal(modalName) { if(modals[modalName]) modals[modalName].classList.remove('active'); }

        function showNotification(message, isError = false) {
            const modal = modals.notification;
            const messageEl = modal.querySelector('#notification-message');
            messageEl.textContent = message;
            messageEl.classList.toggle('text-red-600', isError);
            showModal('notification');
        }
        
        function updateBreedDropdown(species, selectedBreed = '') {
            const breedSelect = document.getElementById('data-breed');
            const otherBreedContainer = document.getElementById('data-breed-other-container');
            const otherBreedInput = document.getElementById('data-breed-other');
            breedSelect.innerHTML = '';

            const canineBreeds = [
                "Mestizo", "Affenpinscher", "Aidi", "Airedale Terrier", "Akita Inu", "Akita Americano", "Alano Español",
                "Alaskan Klee Kai", "Alaskan Malamute", "American Bully", "American Foxhound", "American Pit Bull Terrier",
                "American Staffordshire Terrier", "Antiguo Perro Pastor Inglés (Bobtail)", "Appenzeller", "Ariegeois",
                "Artois", "Australian Cattle Dog (Boyero Australiano)", "Australian Shepherd (Pastor Australiano)",
                "Australian Silky Terrier", "Australian Stumpy Tail Cattle Dog", "Azawakh",
                "Balkan Hound", "Basenji", "Basset Azul de Gascuña", "Basset Hound", "Basset Leonado de Bretaña",
                "Beagle", "Beagle Harrier", "Bearded Collie", "Beauceron", "Bedlington Terrier", "Bergamasco",
                "Bichon Boloñés", "Bichon Frisé", "Bichon Habanero", "Billy", "Black and Tan Coonhound",
                "Bloodhound (Perro de San Huberto)", "Boerboel", "Border Collie", "Border Terrier", "Borzoi",
                "Boston Terrier", "Bouvier de Flandes", "Boxer", "Boyero de Appenzell", "Boyero de Berna",
                "Boyero de Entlebuch", "Braco Alemán de Pelo Corto", "Braco Alemán de Pelo Duro", "Braco de Auvernia",
                "Braco de Weimar", "Braco Francés", "Braco Húngaro (Vizsla)", "Braco Italiano", "Bull Terrier",
                "Bulldog Americano", "Bulldog Francés", "Bulldog Inglés", "Bullmastiff",
                "Cairn Terrier", "Cane Corso", "Caniche (Poodle)", "Cavalier King Charles Spaniel", "Chihuahua",
                "Chin Japonés", "Chow Chow", "Cirneco del Etna", "Clumber Spaniel", "Cocker Spaniel Americano",
                "Cocker Spaniel Inglés", "Collie de Pelo Corto", "Collie de Pelo Largo", "Coton de Tulear",
                "Curly Coated Retriever",
                "Dálmata", "Dandie Dinmont Terrier", "Deerhound", "Doberman", "Dogo Argentino", "Dogo de Burdeos",
                "Dogo del Tíbet", "Drentse Patrijshond",
                "Elkhound Noruego", "Epagneul Bretón", "Eurasier",
                "Field Spaniel", "Fila Brasileiro", "Flat-Coated Retriever", "Fox Terrier de Pelo Duro",
                "Fox Terrier de Pelo Liso", "Foxhound Inglés",
                "Galgo Afgano", "Galgo Español", "Galgo Húngaro (Magyar Agár)", "Galgo Inglés (Greyhound)",
                "Galgo Italiano", "Galgo Persa (Saluki)", "Gascon Saintongeois", "Golden Retriever", "Gordon Setter",
                "Gran Danés (Dogo Alemán)", "Gran Gascón de Saintonge", "Gran Munsterlander", "Gran Perro Japonés",
                "Grifón Azul de Gascuña", "Grifón de Bruselas", "Grifón Vendeano",
                "Harrier", "Hovawart", "Husky Siberiano",
                "Ibizan Hound (Podenco Ibicenco)", "Irish Soft Coated Wheaten Terrier", "Irish Terrier",
                "Irish Water Spaniel", "Irish Wolfhound (Lobero Irlandés)",
                "Jack Russell Terrier",
                "Keeshond", "Kerry Blue Terrier", "Komondor", "Kooikerhondje", "Kuvasz",
                "Labrador Retriever", "Lagotto Romagnolo", "Lakeland Terrier", "Landseer", "Lebrel Húngaro",
                "Leonberger", "Lhasa Apso", "Lowchen",
                "Maltés", "Manchester Terrier", "Mastín Español", "Mastín Inglés", "Mastín Napolitano",
                "Mastín Tibetano", "Mudi",
                "Nova Scotia Duck Tolling Retriever",
                "Otterhound",
                "Papillón", "Parson Russell Terrier", "Pastor Alemán", "Pastor Australiano", "Pastor Belga Groenendael",
                "Pastor Belga Laekenois", "Pastor Belga Malinois", "Pastor Belga Tervueren", "Pastor Blanco Suizo",
                "Pastor Catalán", "Pastor de Anatolia", "Pastor de los Pirineos", "Pastor de Shetland (Sheltie)",
                "Pastor Polaco de las Llanuras", "Pastor Vasco", "Pekinés", "Pequeño Lebrel Italiano",
                "Perdiguero de Burgos", "Perdiguero Portugués", "Perro de Agua Americano", "Perro de Agua Español",
                "Perro de Agua Irlandés", "Perro de Agua Portugués", "Perro de Montaña de los Pirineos",
                "Perro Lobo Checoslovaco", "Perro Lobo de Saarloos", "Pharaoh Hound", "Pinscher Alemán",
                "Pinscher Miniatura", "Podenco Canario", "Podenco Ibicenco", "Podenco Portugués", "Pointer",
                "Porcelaine", "Pudelpointer", "Pug (Carlino)", "Puli", "Pumi",
                "Rafeiro do Alentejo", "Ratón de Praga", "Ratonero Bodeguero Andaluz", "Rhodesian Ridgeback",
                "Rottweiler",
                "Sabueso Español", "Sabueso Finlandés", "Sabueso Suizo", "Saluki", "Samoyedo", "San Bernardo",
                "Schapendoes", "Schnauzer Gigante", "Schnauzer Mediano", "Schnauzer Miniatura", "Scottish Terrier",
                "Sealyham Terrier", "Setter Gordon", "Setter Inglés", "Setter Irlandés", "Shar Pei", "Shiba Inu",
                "Shih Tzu", "Shikoku", "Skye Terrier", "Sloughi", "Smousholland", "Spinone Italiano",
                "Spitz Alemán", "Spitz Finlandés", "Spitz Japonés", "Staffordshire Bull Terrier", "Sussex Spaniel",
                "Teckel (Dachshund)", "Terranova", "Terrier Australiano", "Terrier Brasileño", "Terrier Chileno",
                "Terrier Checo", "Terrier de Airedale", "Terrier Escocés", "Terrier Galés", "Terrier Irlandés",
                "Terrier Japonés", "Terrier Negro Ruso", "Terrier Tibetano", "Tosa Inu",
                "Volpino Italiano",
                "Weimaraner", "Welsh Corgi Cardigan", "Welsh Corgi Pembroke", "Welsh Springer Spaniel",
                "Welsh Terrier", "West Highland White Terrier", "Whippet",
                "Xoloitzcuintle",
                "Yorkshire Terrier",
                "Otro"
            ];

            const felineBreeds = [
                "Doméstico de Pelo Corto", "Doméstico de Pelo Largo", "Abisinio", "American Bobtail", "American Curl", "American Shorthair", "American Wirehair",
                "Azul Ruso", "Balinés", "Bengalí (Bengala)", "Birmano", "Bombay", "Bosque de Noruega", "British Shorthair", "Burmés", "Burmilla",
                "Chartreux", "Chausie", "Cornish Rex", "Devon Rex", "Don Sphynx", "Exótico de Pelo Corto", "Gato de Angora Turco", "Gato Europeo",
                "Habana Brown", "Himalayo", "Javanés", "Korat", "Khao Manee", "LaPerm", "Lykoi", "Maine Coon", "Manx",
                "Ocicat", "Oriental de Pelo Corto", "Oriental de Pelo Largo", "Persa", "Peterbald", "Pixie-bob",
                "Ragamuffin", "Ragdoll", "Sagrado de Birmania", "Savannah", "Scottish Fold", "Selkirk Rex", "Siamés", "Siberiano", "Singapura",
                "Snowshoe", "Somalí", "Sphynx (Gato Esfinge)", "Tonkinés", "Toyger", "Van Turco", "Otro"
            ];

            const ferretBreeds = ["Estándar", "Angora", "Otro"];

            let breeds;
            if (species === 'Felina') {
                breeds = felineBreeds;
            } else if (species === 'Hurón') {
                breeds = ferretBreeds;
            } else {
                breeds = canineBreeds;
            }

            breeds.forEach(breed => {
                const option = document.createElement('option');
                option.value = breed;
                option.textContent = breed;
                breedSelect.appendChild(option);
            });

            if (selectedBreed && !breeds.includes(selectedBreed)) {
                breedSelect.value = 'Otro';
                otherBreedInput.value = selectedBreed;
                otherBreedContainer.classList.remove('hidden');
            } else if (selectedBreed) {
                breedSelect.value = selectedBreed;
                otherBreedContainer.classList.add('hidden');
            } else {
                otherBreedContainer.classList.add('hidden');
            }
        }

        // --- Patient Hub Logic ---
        async function openPatientHub(patientId) {
            const { doc, getDoc } = window.firebase;
            const db = window.db;
            const docRef = doc(db, "patients", patientId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                currentPatientData = { id: docSnap.id, ...data };
                currentPatientSpecies = data.species; 
                document.getElementById('hub-patient-name').textContent = data.name || 'Paciente sin nombre';
                document.getElementById('hub-patient-id').textContent = `Nº Ficha: ${patientId}`;
                document.getElementById('hub-anamnesis-remota').value = data.anamnesisRemota || '';
                
                const summaryEl = document.getElementById('hub-patient-summary');
                summaryEl.innerHTML = `
                    <div><strong>Especie:</strong> ${data.species || 'N/A'}</div>
                    <div><strong>Raza:</strong> ${data.breed || 'N/A'}</div>
                    <div><strong>Nacimiento:</strong> ${data.birthDate || 'N/A'}</div>
                    <div><strong>Tutor:</strong> ${data.tutorName || 'N/A'}</div>
                    <div><strong>Teléfono:</strong> ${data.tutorPhone || 'N/A'}</div>
                    <div><strong>Email:</strong> ${data.tutorEmail || 'N/A'}</div>
                `;
                
                document.querySelectorAll('.hub-section-btn').forEach(btn => btn.classList.remove('active-hub-btn'));
                document.querySelector('.hub-section-btn[data-section="consultas"]').classList.add('active-hub-btn');
                document.querySelectorAll('.hub-section-content').forEach(content => content.classList.add('hidden'));
                document.getElementById('hub-consultas-content').classList.remove('hidden');
                
                loadConsultationHistory(patientId);
                loadPrescriptionHistory(patientId);
                loadVaccineHistory(patientId);
                loadDewormingHistory(patientId);
                loadExamHistory(patientId);
                navigateTo('patientHub', patientId);
            } else {
                showNotification(`No se encontró el paciente con Ficha Nº ${patientId}.`, true);
                navigateTo('dashboard');
            }
        }
        
        async function saveHubAnamnesis() {
            if (!currentPatientId) return;
            const { doc, updateDoc, serverTimestamp } = window.firebase;
            const db = window.db;
            const anamnesisText = document.getElementById('hub-anamnesis-remota').value;
            try {
                await updateDoc(doc(db, "patients", currentPatientId), {
                    anamnesisRemota: anamnesisText,
                    lastUpdated: serverTimestamp()
                });
                showNotification("Anamnesis remota guardada.");
            } catch (error) {
                showNotification("Error al guardar la anamnesis.", true);
                console.error("Error saving remote anamnesis:", error);
            }
        }

        async function loadConsultationHistory(patientId) {
            const { collection, query, getDocs, orderBy } = window.firebase;
            const db = window.db;
            const historyList = document.getElementById('consultation-history-list');
            historyList.innerHTML = '<p>Cargando historial...</p>';
            
            try {
                const q = query(collection(db, "patients", patientId, "consultations"), orderBy("consultationDate", "desc"));
                const querySnapshot = await getDocs(q);
                
                historyList.innerHTML = '';
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">No hay consultas registradas.</p>';
                    return;
                }
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.consultationDate || 'Fecha no disponible';

                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';

                    const detailsGrid = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                            <div class="md:col-span-2"><strong class="text-gray-600 block text-base border-b pb-1 mb-2">Anamnesis</strong></div>
                            <div><strong class="text-gray-600 block">Anamnesis Remota (Snapshot):</strong><p class="whitespace-pre-wrap mt-1">${data.anamnesisRemotaSnapshot || 'N/A'}</p></div>
                            <div><strong class="text-gray-600 block">Anamnesis (Consulta):</strong><p class="whitespace-pre-wrap mt-1">${data.anamnesis || 'N/A'}</p></div>
                            <div><strong class="text-gray-600 block">Síntomas Adicionales:</strong><p class="whitespace-pre-wrap mt-1">${data.additionalSymptoms || 'N/A'}</p></div>
                            <div><strong class="text-gray-600 block">Cambios Recientes:</strong><p class="whitespace-pre-wrap mt-1">${data.recentChanges || 'N/A'}</p></div>
                            <div class="md:col-span-2"><strong class="text-gray-600 block text-base border-b pb-1 my-2">Examen Físico</strong></div>
                            <div><strong class="text-gray-600 block">Temp:</strong><p>${data.temp || 'N/A'}</p></div>
                            <div><strong class="text-gray-600 block">FC:</strong><p>${data.hr || 'N/A'}</p></div>
                            <div><strong class="text-gray-600 block">FR:</strong><p>${data.rr || 'N/A'}</p></div>
                            <div><strong class="text-gray-600 block">TRC:</strong><p>${data.crt || 'N/A'}</p></div>
                            <div class="md:col-span-2"><strong class="text-gray-600 block">Hallazgos Examen Físico:</strong><p class="whitespace-pre-wrap mt-1">${data.physicalExamFindings || 'N/A'}</p></div>
                            <div class="md:col-span-2"><strong class="text-gray-600 block text-base border-b pb-1 my-2">Diagnóstico y Plan</strong></div>
                            <div><strong class="text-gray-600 block">Diagnóstico Diferencial:</strong><p class="whitespace-pre-wrap mt-1">${data.differentialDiagnosis || 'N/A'}</p></div>
                            <div><strong class="text-gray-600 block">Plan Terapéutico:</strong><p class="whitespace-pre-wrap mt-1">${data.therapeuticPlan || 'N/A'}</p></div>
                            <div class="md:col-span-2"><strong class="text-gray-600 block">Notas Adicionales:</strong><p class="whitespace-pre-wrap mt-1">${data.additionalNotes || 'N/A'}</p></div>
                            <div><strong class="text-gray-600 block">Próxima Cita:</strong><p class="whitespace-pre-wrap mt-1">${data.nextAppointment || 'N/A'}</p></div>
                        </div>
                    `;

                    accordionItem.innerHTML = `
                        <div class="accordion-header">
                            <div>
                                <p class="font-bold text-lg text-accent-dark">${date}</p>
                                <p class="text-sm text-gray-600"><strong>Motivo:</strong> ${data.consultationReason || 'N/A'}</p>
                                <p class="text-sm text-gray-600"><strong>Diagnóstico Presuntivo:</strong> ${data.presumptiveDiagnosis || 'N/A'}</p>
                            </div>
                            <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                        <div class="accordion-body">
                            ${detailsGrid}
                        </div>
                    `;
                    historyList.appendChild(accordionItem);
                });

                historyList.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const body = header.nextElementSibling;
                        header.classList.toggle('active');
                        body.classList.toggle('expanded');
                    });
                });

            } catch (error) {
                historyList.innerHTML = '<p class="text-center text-red-500">Error al cargar el historial.</p>';
                console.error("Error loading consultation history:", error);
            }
        }

        // --- Edit Patient Data Logic ---
        async function openPatientDataForm(patientId) {
            const form = document.getElementById('patient-data-form');
            form.reset();
            if (patientId) {
                if (currentPatientData && currentPatientData.id === patientId) {
                    loadPatientDataIntoForm(currentPatientData, patientId);
                } else {
                    const { doc, getDoc } = window.firebase;
                    const db = window.db;
                    const docRef = doc(db, "patients", patientId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        loadPatientDataIntoForm({id: docSnap.id, ...docSnap.data()}, patientId);
                    }
                }
            } else {
                document.getElementById('data-ficha-number').textContent = 'Se generará al guardar';
                document.querySelector('input[name="species"][value="Canina"]').checked = true;
                updateBreedDropdown('Canina');
            }
            navigateTo('editPatientData', patientId);
        }

        function loadPatientDataIntoForm(data, patientId) {
            document.getElementById('data-ficha-number').textContent = patientId;
            document.getElementById('data-tutor-name').value = data.tutorName || '';
            document.getElementById('data-tutor-rut').value = data.tutorRut ? formatRut(data.tutorRut) : '';
            document.getElementById('data-tutor-phone').value = data.tutorPhone || '';
            document.getElementById('data-tutor-phone2').value = data.tutorPhone2 || '';
            document.getElementById('data-tutor-email').value = data.tutorEmail || '';
            document.getElementById('data-tutor-city').value = data.tutorCity || '';
            document.getElementById('data-tutor-address').value = data.tutorAddress || '';
            document.getElementById('data-patient-name').value = data.name || '';
            
            const species = data.species || 'Canina';
            document.querySelector(`#view-edit-patient-data input[name="species"][value="${species}"]`).checked = true;
            updateBreedDropdown(species, data.breed);

            if(data.sex) document.querySelector(`#view-edit-patient-data input[name="sex"][value="${data.sex}"]`).checked = true;
            if(data.reproductiveStatus) document.querySelector(`#view-edit-patient-data input[name="reproductiveStatus"][value="${data.reproductiveStatus}"]`).checked = true;
            document.getElementById('data-birth-date').value = data.birthDate || '';
            calculateAge();
            document.getElementById('data-color-markings').value = data.colorMarkings || '';
            document.getElementById('data-microchip').value = data.microchip || '';
            document.getElementById('data-weight').value = data.weight || '';
            if(data.origin) {
                const originRadio = document.querySelector(`#view-edit-patient-data input[name="origin"][value="${data.origin}"]`);
                if(originRadio) {
                    originRadio.checked = true;
                } else {
                    document.querySelector(`#view-edit-patient-data input[name="origin"][value="Otro"]`).checked = true;
                    document.getElementById('data-origin-other').value = data.origin;
                }
            }
        }

        async function savePatientData(e) {
            e.preventDefault();
            const { setDoc, doc, serverTimestamp, runTransaction } = window.firebase;
            const db = window.db;
            
            const getRadioValue = (name) => { const el = document.querySelector(`#view-edit-patient-data input[name="${name}"]:checked`); return el ? el.value : ''; };
            let originValue = getRadioValue('origin');
            if (originValue === 'Otro') {
                originValue = document.getElementById('data-origin-other').value;
            }

            let breedValue = document.getElementById('data-breed').value;
            if (breedValue === 'Otro') {
                breedValue = document.getElementById('data-breed-other').value;
            }

            const data = {
                name: document.getElementById('data-patient-name').value.toLowerCase(),
                tutorName: document.getElementById('data-tutor-name').value,
                tutorRut: document.getElementById('data-tutor-rut').value.replace(/[.-]/g, ''),
                tutorPhone: document.getElementById('data-tutor-phone').value,
                tutorPhone2: document.getElementById('data-tutor-phone2').value,
                tutorEmail: document.getElementById('data-tutor-email').value,
                tutorCity: document.getElementById('data-tutor-city').value,
                tutorAddress: document.getElementById('data-tutor-address').value,
                species: getRadioValue('species'),
                breed: breedValue,
                sex: getRadioValue('sex'),
                reproductiveStatus: getRadioValue('reproductiveStatus'),
                birthDate: document.getElementById('data-birth-date').value,
                age: document.getElementById('data-age').value,
                colorMarkings: document.getElementById('data-color-markings').value,
                microchip: document.getElementById('data-microchip').value,
                weight: document.getElementById('data-weight').value,
                origin: originValue,
                lastUpdated: serverTimestamp()
            };
            try {
                if (currentPatientId) {
                    await setDoc(doc(db, "patients", currentPatientId), data, { merge: true });
                    showNotification("Datos actualizados.");
                    openPatientHub(currentPatientId);
                } else {
                    const counterRef = doc(db, "counters", "patientCounter");
                    const newPatientNumber = await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const lastNumber = counterDoc.data()?.lastNumber || 0;
                        const newNumber = lastNumber + 1;
                        const formattedNumber = String(newNumber);
                        data.createdAt = serverTimestamp();
                        transaction.set(doc(db, "patients", formattedNumber), data);
                        transaction.update(counterRef, { lastNumber: newNumber });
                        return formattedNumber;
                    });
                    currentPatientId = newPatientNumber;
                    showNotification(`Nuevo paciente creado con Ficha Nº ${newPatientNumber}.`);
                    openPatientHub(currentPatientId);
                }
            } catch (error) {
                showNotification("Error al guardar datos.", true);
                console.error("Error saving patient data:", error);
            }
        }

        async function handleDeletePatient() {
            if (!currentPatientId) return;
            const { doc, deleteDoc, collection, getDocs } = window.firebase;
            const db = window.db;

            async function deleteSubcollection(patientId, subcollectionName) {
                const subcollectionRef = collection(db, "patients", patientId, subcollectionName);
                const snapshot = await getDocs(subcollectionRef);
                const deletePromises = [];
                snapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
            }

            try {
                await deleteSubcollection(currentPatientId, 'consultations');
                await deleteSubcollection(currentPatientId, 'prescriptions');
                await deleteSubcollection(currentPatientId, 'vaccines');
                await deleteSubcollection(currentPatientId, 'deworming');
                await deleteSubcollection(currentPatientId, 'exams');
                await deleteSubcollection(currentPatientId, 'certificates');
                await deleteDoc(doc(db, "patients", currentPatientId));
                hideModal('deleteConfirmation');
                showNotification("Paciente eliminado correctamente.");
                document.getElementById('search-input').value = '';
                document.getElementById('search-results').innerHTML = '';
                navigateTo('dashboard');
            } catch (error) {
                hideModal('deleteConfirmation');
                showNotification("Error al eliminar el paciente.", true);
                console.error("Error deleting patient:", error);
            }
        }

        // --- New Consultation Modal Logic ---
        function openNewConsultationModal() {
            const consultationForm = modals.consultation.querySelector('form');
            if(consultationForm) consultationForm.reset();
            
            const today = new Date().toISOString().split('T')[0];
            modals.consultation.querySelector('#modal-mc-fecha').value = today;

            const anamnesisRemotaText = document.getElementById('hub-anamnesis-remota').value;
            modals.consultation.querySelector('#modal-anamnesis-remota').value = anamnesisRemotaText;
            showModal('consultation');
        }

        async function saveNewConsultation(e) {
            e.preventDefault();
            const { collection, addDoc, serverTimestamp, doc, updateDoc } = window.firebase;
            const db = window.db;
            
            const updatedAnamnesisRemota = modals.consultation.querySelector('#modal-anamnesis-remota').value;

            const consultationData = {
                savedAt: serverTimestamp(),
                anamnesisRemotaSnapshot: updatedAnamnesisRemota,
                consultationDate: modals.consultation.querySelector('#modal-mc-fecha').value,
                consultationReason: modals.consultation.querySelector('#modal-mc-sintomas').value,
                anamnesis: modals.consultation.querySelector('#modal-anamnesis-historial').value,
                additionalSymptoms: modals.consultation.querySelector('#modal-anamnesis-sintomas').value,
                recentChanges: modals.consultation.querySelector('#modal-anamnesis-cambios').value,
                currentMedications: modals.consultation.querySelector('#modal-anamnesis-medicamentos').value,
                allergies: modals.consultation.querySelector('#modal-anamnesis-alergias').value,
                eliminationHabits: modals.consultation.querySelector('#modal-anamnesis-habitos').value,
                diet: modals.consultation.querySelector('#modal-anamnesis-dieta').value,
                activityLevel: modals.consultation.querySelector('#modal-anamnesis-actividad').value,
                environment: modals.consultation.querySelector('#modal-anamnesis-ambiente').value,
                temp: modals.consultation.querySelector('#modal-efg-temp').value,
                hr: modals.consultation.querySelector('#modal-efg-fc').value,
                rr: modals.consultation.querySelector('#modal-efg-fr').value,
                crt: modals.consultation.querySelector('#modal-efg-trc').value,
                physicalExamFindings: modals.consultation.querySelector('#modal-efg-hallazgos').value,
                presumptiveDiagnosis: modals.consultation.querySelector('#modal-diag-presuntivo').value,
                differentialDiagnosis: modals.consultation.querySelector('#modal-diag-diferencial').value,
                therapeuticPlan: modals.consultation.querySelector('#modal-plan-terapeutico').value,
                additionalNotes: modals.consultation.querySelector('#modal-notas-adicionales').value,
                nextAppointment: modals.consultation.querySelector('#modal-proxima-cita').value,
            };

            try {
                await addDoc(collection(db, "patients", currentPatientId, "consultations"), consultationData);
                await updateDoc(doc(db, "patients", currentPatientId), { anamnesisRemota: updatedAnamnesisRemota });

                hideModal('consultation');
                loadConsultationHistory(currentPatientId);
                showNotification("Nueva consulta guardada.");
            } catch (error) {
                showNotification("Error al guardar la consulta.", true);
                console.error("Error saving new consultation:", error);
            }
        }

        // --- Prescription View Logic ---
        async function openPrescriptionView(patientId) {
            if (!patientId) return;
            
            document.getElementById('rx-treatment-notes').value = '';
            document.getElementById('rx-indications-notes').value = '';

            if (currentPatientData && currentPatientData.id === patientId) {
                populatePrescriptionData(currentPatientData);
            } else {
                const { doc, getDoc } = window.firebase;
                const db = window.db;
                const docRef = doc(db, "patients", patientId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    populatePrescriptionData({id: docSnap.id, ...docSnap.data()});
                }
            }
            navigateTo('prescription', patientId);
        }
        
        function populatePrescriptionData(data) {
            document.getElementById('rx-ficha-id').textContent = data.id;
            document.getElementById('rx-patient-name').textContent = data.name || '';
            document.getElementById('rx-species').textContent = data.species || '';
            document.getElementById('rx-breed').textContent = data.breed || '';
            document.getElementById('rx-age').textContent = data.age || '';
            document.getElementById('rx-tutor-name').textContent = data.tutorName || '';
            document.getElementById('rx-tutor-rut').textContent = data.tutorRut ? formatRut(data.tutorRut) : '';
            document.getElementById('rx-date').textContent = new Date().toLocaleDateString('es-CL');
            document.getElementById('rx-email').value = data.tutorEmail || '';
        }
        
        async function savePrescriptionData(e) {
            e.preventDefault();
            if (!currentPatientId) return;
            const { collection, addDoc, serverTimestamp } = window.firebase;
            const db = window.db;
            const dataToSave = {
                treatment: document.getElementById('rx-treatment-notes').value,
                indications: document.getElementById('rx-indications-notes').value,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(collection(db, "patients", currentPatientId, "prescriptions"), dataToSave);
                showNotification("Receta guardada con éxito.");
                openPatientHub(currentPatientId);
            } catch (error) {
                showNotification("Error al guardar la receta.", true);
                console.error("Error saving prescription:", error);
            }
        }

        async function loadPrescriptionHistory(patientId) {
            const { collection, query, getDocs, orderBy } = window.firebase;
            const db = window.db;
            const historyList = document.getElementById('prescription-history-list');
            historyList.innerHTML = '<p>Cargando historial de recetas...</p>';
            
            try {
                const q = query(collection(db, "patients", patientId, "prescriptions"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                historyList.innerHTML = '';
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">No hay recetas registradas.</p>';
                    return;
                }
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString('es-CL') : 'Fecha no disponible';
                    
                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';

                    const details = `
                        <div class="mt-2">
                            <strong class="text-gray-600 block">Tratamiento:</strong>
                            <p class="whitespace-pre-wrap text-sm">${data.treatment || 'N/A'}</p>
                        </div>
                        <div class="mt-4">
                            <strong class="text-gray-600 block">Indicaciones:</strong>
                            <p class="whitespace-pre-wrap text-sm">${data.indications || 'N/A'}</p>
                        </div>
                    `;

                    accordionItem.innerHTML = `
                        <div class="accordion-header">
                            <p class="font-bold text-lg text-[#4A4A4A]">${date}</p>
                            <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                        <div class="accordion-body">
                            ${details}
                        </div>
                    `;
                    historyList.appendChild(accordionItem);
                });

                historyList.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const body = header.nextElementSibling;
                        header.classList.toggle('active');
                        body.classList.toggle('expanded');
                    });
                });

            } catch (error) {
                historyList.innerHTML = '<p class="text-center text-red-500">Error al cargar el historial de recetas.</p>';
                console.error("Error loading prescription history:", error);
            }
        }
        
        // --- Vaccine Logic ---
        function openNewVaccineModal() {
            const form = document.getElementById('vaccine-form');
            form.reset();

            const vaccineSelect = document.getElementById('vaccine-type');
            vaccineSelect.innerHTML = '';

            const canineVaccines = ['Sextuple/Octuple', 'Antirrábica', 'Bordetella', 'Otros'];
            const felineVaccines = ['Triple Felina', 'Leucemia Felina', 'Antirrábica'];
            const ferretVaccines = ['Antirrábica', 'Distemper', 'Otros'];
            
            let options;
            if (currentPatientSpecies === 'Felina') {
                options = felineVaccines;
            } else if (currentPatientSpecies === 'Hurón') {
                options = ferretVaccines;
            } else {
                options = canineVaccines;
            }
            
            options.forEach(v => {
                const option = document.createElement('option');
                option.value = v;
                option.textContent = v;
                vaccineSelect.appendChild(option);
            });
            
            showModal('vaccine');
        }

        async function saveNewVaccine(e) {
            e.preventDefault();
            if (!currentPatientId) return;

            const { collection, addDoc, serverTimestamp } = window.firebase;
            const db = window.db;

            const vaccineData = {
                date: document.getElementById('vaccine-date').value,
                type: document.getElementById('vaccine-type').value,
                brand: document.getElementById('vaccine-brand').value,
                nextDose: document.getElementById('vaccine-next-dose').value,
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "patients", currentPatientId, "vaccines"), vaccineData);
                hideModal('vaccine');
                loadVaccineHistory(currentPatientId);
                showNotification("Vacuna registrada con éxito.");
            } catch (error) {
                showNotification("Error al registrar la vacuna.", true);
                console.error("Error saving vaccine:", error);
            }
        }

        async function loadVaccineHistory(patientId) {
            const container = document.getElementById('vaccine-history-table');
            container.innerHTML = '<p>Cargando historial de vacunas...</p>';
            
            const { collection, query, getDocs, orderBy } = window.firebase;
            const db = window.db;

            try {
                const q = query(collection(db, "patients", patientId, "vaccines"), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay vacunas registradas.</p>';
                    return;
                }

                let tableHTML = `
                    <table class="min-w-full bg-white text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-4 text-left">Fecha</th>
                                <th class="py-2 px-4 text-left">Vacuna</th>
                                <th class="py-2 px-4 text-left">Marca/Lote</th>
                                <th class="py-2 px-4 text-left">Próxima Dosis</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    tableHTML += `
                        <tr class="border-b">
                            <td class="py-2 px-4">${data.date || 'N/A'}</td>
                            <td class="py-2 px-4">${data.type || 'N/A'}</td>
                            <td class="py-2 px-4">${data.brand || 'N/A'}</td>
                            <td class="py-2 px-4">${data.nextDose || 'N/A'}</td>
                        </tr>
                    `;
                });

                tableHTML += `</tbody></table>`;
                container.innerHTML = tableHTML;

            } catch (error) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar el historial de vacunas.</p>';
                console.error("Error loading vaccine history:", error);
            }
        }

        // --- Deworming Logic ---
        function openNewDewormingModal() {
            document.getElementById('deworming-form').reset();
            showModal('deworming');
        }

        async function saveNewDeworming(e) {
            e.preventDefault();
            if (!currentPatientId) return;

            const { collection, addDoc, serverTimestamp } = window.firebase;
            const db = window.db;

            const dewormingData = {
                date: document.getElementById('deworming-date').value,
                type: document.querySelector('input[name="deworming-type"]:checked').value,
                product: document.getElementById('deworming-product').value,
                nextDose: document.getElementById('deworming-next-dose').value,
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "patients", currentPatientId, "deworming"), dewormingData);
                hideModal('deworming');
                loadDewormingHistory(currentPatientId);
                showNotification("Desparasitación registrada con éxito.");
            } catch (error) {
                showNotification("Error al registrar la desparasitación.", true);
                console.error("Error saving deworming:", error);
            }
        }

        async function loadDewormingHistory(patientId) {
            const container = document.getElementById('deworming-history-table');
            container.innerHTML = '<p>Cargando historial de desparasitaciones...</p>';
            
            const { collection, query, getDocs, orderBy } = window.firebase;
            const db = window.db;

            try {
                const q = query(collection(db, "patients", patientId, "deworming"), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay desparasitaciones registradas.</p>';
                    return;
                }

                let tableHTML = `
                    <table class="min-w-full bg-white text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-4 text-left">Fecha</th>
                                <th class="py-2 px-4 text-left">Tipo</th>
                                <th class="py-2 px-4 text-left">Producto</th>
                                <th class="py-2 px-4 text-left">Próxima Dosis</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    tableHTML += `
                        <tr class="border-b">
                            <td class="py-2 px-4">${data.date || 'N/A'}</td>
                            <td class="py-2 px-4">${data.type || 'N/A'}</td>
                            <td class="py-2 px-4">${data.product || 'N/A'}</td>
                            <td class="py-2 px-4">${data.nextDose || 'N/A'}</td>
                        </tr>
                    `;
                });

                tableHTML += `</tbody></table>`;
                container.innerHTML = tableHTML;

            } catch (error) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar el historial.</p>';
                console.error("Error loading deworming history:", error);
            }
        }

        // --- Exam Logic ---
        function openNewExamOrderModal() {
            document.getElementById('exam-order-form').reset();
            
            const labDropdown = document.getElementById('lab-exam-select-dropdown');
            const imagingDropdown = document.getElementById('imaging-exam-select-dropdown');
            labDropdown.innerHTML = ''; 
            imagingDropdown.innerHTML = '';
            
            const createDropdownContent = (examData, container) => {
                Object.keys(examData).forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'p-2';
                    categoryDiv.innerHTML = `<h3 class="font-bold text-sm text-gray-500 sticky top-0 bg-gray-100 px-2 py-1">${category}</h3>`;
                    
                    examData[category].forEach(exam => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center space-x-2 p-2 hover:bg-gray-50 cursor-pointer';
                        label.innerHTML = `
                            <input type="checkbox" value="${exam.name}" data-instructions="${exam.instructions}" class="form-checkbox exam-checkbox">
                            <span>${exam.name}</span>
                        `;
                        categoryDiv.appendChild(label);
                    });
                    container.appendChild(categoryDiv);
                });
            };

            createDropdownContent(labExams, labDropdown);
            createDropdownContent(imagingExams, imagingDropdown);
            
            document.querySelectorAll('.exam-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateSelectedExamsDisplay();
                    updateExamInstructions();
                });
            });

            updateSelectedExamsDisplay();
            updateExamInstructions();
            showModal('examOrder');
        }
        
        function updateSelectedExamsDisplay() {
            const checkboxes = document.querySelectorAll('.exam-checkbox:checked');
            const container = document.getElementById('selected-exams-container');
            const labPlaceholder = document.getElementById('lab-exam-select-placeholder');
            const imagingPlaceholder = document.getElementById('imaging-exam-select-placeholder');
            container.innerHTML = '';

            let labCount = 0;
            let imagingCount = 0;
            
            if (checkboxes.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400">Ningún examen seleccionado.</p>';
                labPlaceholder.textContent = 'Seleccionar...';
                imagingPlaceholder.textContent = 'Seleccionar...';
                return;
            }

            checkboxes.forEach(checkbox => {
                const tag = document.createElement('span');
                tag.className = 'bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded flex items-center';
                tag.innerHTML = `
                    ${checkbox.value}
                    <button type="button" data-value="${checkbox.value}" class="ml-2 text-blue-600 hover:text-blue-800 remove-exam-tag">&times;</button>
                `;
                container.appendChild(tag);

                if (document.getElementById('lab-exam-select-dropdown').contains(checkbox)) {
                    labCount++;
                } else {
                    imagingCount++;
                }
            });

            labPlaceholder.textContent = labCount > 0 ? `${labCount} seleccionado(s)` : 'Seleccionar...';
            imagingPlaceholder.textContent = imagingCount > 0 ? `${imagingCount} seleccionado(s)` : 'Seleccionar...';

            container.querySelectorAll('.remove-exam-tag').forEach(button => {
                button.addEventListener('click', (e) => {
                    const valueToRemove = e.target.dataset.value;
                    const checkboxToUncheck = document.querySelector(`.exam-checkbox[value="${valueToRemove}"]`);
                    if (checkboxToUncheck) {
                        checkboxToUncheck.checked = false;
                        updateSelectedExamsDisplay();
                        updateExamInstructions();
                    }
                });
            });
        }
        
        function updateExamInstructions() {
            const instructionsTextarea = document.getElementById('exam-order-instructions');
            const selectedCheckboxes = document.querySelectorAll('.exam-checkbox:checked');
            let instructions = new Set();
            let maxAyuno = 0;

            selectedCheckboxes.forEach(checkbox => {
                const instructionText = checkbox.dataset.instructions || "";
                if (instructionText.toLowerCase().includes('ayuno')) {
                    if (instructionText.includes('12')) maxAyuno = Math.max(maxAyuno, 12);
                    else if (instructionText.includes('8')) maxAyuno = Math.max(maxAyuno, 8);
                    else if (instructionText.includes('6')) maxAyuno = Math.max(maxAyuno, 6);
                }
                if (instructionText.toLowerCase().includes('post prandial')) {
                     instructions.add("Requiere muestra post prandial (2 horas después de comer).");
                }
                if (!instructionText.toLowerCase().includes('ayuno') && instructionText !== 'N/A' && !instructionText.toLowerCase().includes('post prandial')) {
                    instructions.add(instructionText);
                }
            });
            
            if(maxAyuno > 0) {
                instructions.add(`Ayuno de al menos ${maxAyuno} horas de alimento. Puede beber agua.`);
            }

            instructionsTextarea.value = [...instructions].join('\n');
        }

        function openNewExamResultModal() {
            document.getElementById('exam-result-form').reset();
            document.getElementById('file-upload-status').textContent = '';
            showModal('examResult');
        }

        async function saveNewExamOrder(e) {
            e.preventDefault();
            if (!currentPatientId) return;
            const { collection, addDoc, serverTimestamp } = window.firebase;
            const db = window.db;

            const selectedExams = Array.from(document.querySelectorAll('.exam-checkbox:checked')).map(cb => cb.value);

            const examData = {
                date: document.getElementById('exam-order-date').value || new Date().toISOString().split('T')[0],
                details: selectedExams.join(', '),
                instructions: document.getElementById('exam-order-instructions').value,
                type: 'order',
                createdAt: serverTimestamp()
            };
            try {
                const docRef = await addDoc(collection(db, "patients", currentPatientId, "exams"), examData);
                hideModal('examOrder');
                loadExamHistory(currentPatientId);
                showNotification("Orden de examen guardada.");
                openPrintableExamOrder({ id: docRef.id, ...examData });
            } catch (error) {
                showNotification("Error al guardar la orden.", true);
                console.error("Error saving exam order:", error);
            }
        }

        async function saveNewExamResult(e) {
            e.preventDefault();
            if (!currentPatientId) return;
            const { collection, addDoc, serverTimestamp, ref, uploadBytes, getDownloadURL, updateDoc } = window.firebase;
            const db = window.db;
            const storage = window.storage;
            
            const fileInput = document.getElementById('exam-result-file');
            const file = fileInput.files[0];
            const statusEl = document.getElementById('file-upload-status');

            const examData = {
                date: document.getElementById('exam-result-date').value || new Date().toISOString().split('T')[0],
                description: document.getElementById('exam-result-description').value,
                type: 'result',
                createdAt: serverTimestamp(),
                fileName: file ? file.name : 'No se adjuntó archivo',
                fileURL: ''
            };

            try {
                const docRef = await addDoc(collection(db, "patients", currentPatientId, "exams"), examData);

                if (file) {
                    statusEl.textContent = 'Subiendo archivo...';
                    const storageRef = ref(storage, `exam_results/${currentPatientId}/${docRef.id}/${file.name}`);
                    const uploadResult = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(uploadResult.ref);
                    
                    await updateDoc(docRef, { fileURL: downloadURL });
                    statusEl.textContent = 'Archivo subido con éxito.';
                }

                hideModal('examResult');
                loadExamHistory(currentPatientId);
                showNotification("Resultados de examen guardados.");
            } catch (error) {
                showNotification("Error al guardar los resultados.", true);
                statusEl.textContent = 'Error en la subida.';
                console.error("Error saving exam result:", error);
            }
        }

        async function loadExamHistory(patientId) {
            const container = document.getElementById('exam-history-list');
            container.innerHTML = '<p>Cargando historial de exámenes...</p>';
            
            const { collection, query, getDocs, orderBy } = window.firebase;
            const db = window.db;

            try {
                const q = query(collection(db, "patients", patientId, "exams"), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay exámenes registrados.</p>';
                    return;
                }
                
                container.innerHTML = '';
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const docId = docSnap.id;
                    const isOrder = data.type === 'order';
                    
                    let fileLink = '';
                    if (!isOrder && data.fileURL) {
                        fileLink = `<a href="${data.fileURL}" target="_blank" class="text-blue-500 hover:underline">Ver Archivo</a>`;
                    } else if (!isOrder) {
                        fileLink = `<p>${data.fileName}</p>`;
                    }

                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 p-4 rounded-lg border';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-md text-[#4A4A4A]">${data.date || 'N/A'}</p>
                                <p class="font-semibold text-sm ${isOrder ? 'text-blue-600' : 'text-green-600'}">${isOrder ? 'Orden de Examen' : 'Resultados'}</p>
                            </div>
                            ${isOrder ? `<button data-order-id="${docId}" class="view-exam-order-btn btn-tertiary text-xs px-2 py-1 rounded">Ver/Imprimir</button>` : ''}
                        </div>
                        <div class="mt-2 text-sm">
                            <strong class="block">${isOrder ? 'Exámenes Solicitados:' : 'Descripción:'}</strong>
                            <p class="whitespace-pre-wrap">${isOrder ? data.details : data.description || 'N/A'}</p>
                        </div>
                        ${isOrder ? `<div class="mt-2 text-sm"><strong class="block">Indicaciones:</strong><p class="whitespace-pre-wrap">${data.instructions || 'N/A'}</p></div>` : ''}
                        ${!isOrder ? `<div class="mt-2 text-sm"><strong class="block">Archivo:</strong> ${fileLink}</div>` : ''}
                    `;
                    container.appendChild(card);
                });

                container.querySelectorAll('.view-exam-order-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const orderId = e.target.dataset.orderId;
                        const { doc, getDoc } = window.firebase;
                        const orderRef = doc(db, "patients", patientId, "exams", orderId);
                        const orderSnap = await getDoc(orderRef);
                        if (orderSnap.exists()) {
                            openPrintableExamOrder(orderSnap.data());
                        }
                    });
                });

            } catch (error) {
                container.innerHTML = '<p class="text-center text-red-500">Error al cargar el historial de exámenes.</p>';
                console.error("Error loading exam history:", error);
            }
        }
        
        function openPrintableExamOrder(orderData) {
            if (!currentPatientData) return;
            
            document.getElementById('exam-order-ficha-id').textContent = currentPatientData.id;
            document.getElementById('exam-order-patient-name').textContent = currentPatientData.name || '';
            document.getElementById('exam-order-species').textContent = currentPatientData.species || '';
            document.getElementById('exam-order-tutor-name').textContent = currentPatientData.tutorName || '';
            document.getElementById('exam-order-tutor-rut').textContent = currentPatientData.tutorRut ? formatRut(currentPatientData.tutorRut) : '';
            document.getElementById('exam-order-email').value = currentPatientData.tutorEmail || '';

            document.getElementById('exam-order-printable-date').textContent = orderData.date;
            document.getElementById('exam-order-details').textContent = orderData.details;
            document.getElementById('exam-order-printable-instructions').textContent = orderData.instructions;
            
            navigateTo('examOrderPrintable', currentPatientId);
        }
        
        // --- Certificate Logic ---
        function openCertificateDetailsModal(template) {
            currentCertificateTemplate = template;
            const form = document.getElementById('certificate-details-form');
            form.reset();

            const destinationContainer = document.getElementById('certificate-form-destination-container');
            const travelDateContainer = document.getElementById('certificate-form-travel-date-container');
            const microchipContainer = document.getElementById('certificate-form-microchip-container');
            
            destinationContainer.classList.add('hidden');
            travelDateContainer.classList.add('hidden');
            microchipContainer.classList.add('hidden');

            if (template.includes('viaje')) {
                destinationContainer.classList.remove('hidden');
            }
            if (template === 'viaje-internacional') {
                travelDateContainer.classList.remove('hidden');
            }
            if (template.includes('chip')) {
                microchipContainer.classList.remove('hidden');
            }
            
            const templateTitles = {
                'salud': 'Certificado de Salud',
                'viaje-nacional': 'Certificado de Viaje Nacional',
                'viaje-internacional': 'Certificado de Viaje Internacional',
                'implantacion-chip': 'Comprobante de Implantación de Chip',
                'validacion-chip': 'Comprobante de Validación de Chip'
            };
            document.getElementById('certificate-modal-title').textContent = `Detalles para: ${templateTitles[template] || template.replace(/-/g, ' ')}`;
            showModal('certificateDetails');
        }
        
        async function handleCertificateGeneration(e) {
            e.preventDefault();
            hideModal('certificateDetails');

            if (currentCertificateTemplate === 'viaje-internacional') {
                const destination = document.getElementById('certificate-destination').value;
                const travelDate = document.getElementById('certificate-travel-date').value;
                await generateInternationalTravelCertificate({ destination, travelDate });
            } else if (currentCertificateTemplate.includes('chip')) {
                const obtencion = document.getElementById('certificate-obtencion').value;
                const tenencia = document.getElementById('certificate-tenencia').value;
                generateMicrochipCertificate({ obtencion, tenencia });
            } else {
                const destination = document.getElementById('certificate-destination').value;
                generateSimpleCertificate(currentCertificateTemplate, { destination });
            }
        }
        
        function generateSimpleCertificate(template, details) {
            if (!currentPatientData) {
                showNotification("No hay datos del paciente cargados.", true);
                return;
            }
            const data = currentPatientData;
            const certTitleEl = document.getElementById('certificate-title');
            const certBodyEl = document.getElementById('certificate-body');
            const generatorTitleEl = document.getElementById('certificate-generator-title');
            document.getElementById('certificate-email').value = data.tutorEmail || '';
            
            const commonInfo = `
                <div class="space-y-3 mb-6">
                    <p>Por medio del presente, yo, <strong>Dra. Alejandra Cautín Bastías</strong>, Médico Veterinario, certifico que he examinado al paciente que se detalla a continuación:</p>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-left bg-gray-50 p-4 rounded-lg">
                        <div><strong>Paciente:</strong> <span class="capitalize">${data.name}</span></div>
                        <div><strong>Nº Ficha:</strong> ${data.id}</div>
                        <div><strong>Especie:</strong> ${data.species}</div>
                        <div><strong>Raza:</strong> ${data.breed}</div>
                        <div><strong>Sexo:</strong> ${data.sex}</div>
                        <div><strong>Fecha de Nacimiento:</strong> ${data.birthDate}</div>
                        <div><strong>Color y Señas:</strong> ${data.colorMarkings}</div>
                        <div><strong>Microchip:</strong> ${data.microchip || 'No posee'}</div>
                        <div><strong>Tutor:</strong> ${data.tutorName}</div>
                        <div><strong>RUT Tutor:</strong> ${data.tutorRut ? formatRut(data.tutorRut) : ''}</div>
                    </div>
                </div>
            `;

            let content = '';
            const today = new Date().toLocaleDateString('es-CL', { year: 'numeric', month: 'long', day: 'numeric' });
            switch (template) {
                case 'salud':
                    generatorTitleEl.textContent = "Generar Certificado de Salud";
                    certTitleEl.textContent = "CERTIFICADO DE SALUD";
                    content = `<p>Al momento del examen clínico realizado el día ${today}, el paciente se encuentra en buen estado de salud, sin presentar signos de enfermedades infectocontagiosas y con sus controles sanitarios al día.</p>
                               <p class="mt-4">Este certificado se extiende a solicitud del tutor para los fines que estime convenientes y tiene una validez de 10 días a partir de esta fecha.</p>`;
                    break;
                case 'viaje-nacional':
                    generatorTitleEl.textContent = "Generar Certificado de Viaje Nacional";
                    certTitleEl.textContent = "CERTIFICADO DE SALUD PARA VIAJE NACIONAL";
                    content = `<p>Al momento del examen clínico realizado el día ${today}, el paciente se encuentra clínicamente sano, sin signos de enfermedades infecciosas y apto para viajar dentro del territorio nacional.</p>
                               <p>El destino del viaje es: <strong>${details.destination || 'No especificado'}</strong>.</p>
                               <p class="mt-4">Este certificado tiene una validez de 10 días a partir de esta fecha.</p>`;
                    break;
                default:
                     generatorTitleEl.textContent = "Generar Certificado";
                     certTitleEl.textContent = "CERTIFICADO";
                     content = `<p>Contenido del certificado no definido para esta plantilla.</p>`;
            }

            certBodyEl.innerHTML = commonInfo + content + `<p class="mt-8">Se extiende el presente certificado en Santiago, a ${today}.</p>`;
            navigateTo('certificateGenerator', data.id);
        }

        async function generateInternationalTravelCertificate(details) {
            if (!currentPatientData) {
                showNotification("No hay datos del paciente cargados.", true);
                return;
            }

            const data = currentPatientData;

            document.getElementById('cert-animal-nombre').textContent = data.name || 'N/A';
            document.getElementById('cert-animal-especie').textContent = data.species || 'N/A';
            document.getElementById('cert-animal-raza').textContent = data.breed || 'N/A';
            document.getElementById('cert-animal-sexo').textContent = data.sex || 'N/A';
            document.getElementById('cert-animal-color').textContent = data.colorMarkings || 'N/A';
            document.getElementById('cert-animal-edad').textContent = data.birthDate || data.age || 'N/A';
            document.getElementById('cert-animal-microchip').textContent = data.microchip || 'No posee';

            document.getElementById('cert-dueno-nombre').textContent = data.tutorName || 'N/A';
            document.getElementById('cert-dueno-rut').textContent = data.tutorRut ? formatRut(data.tutorRut) : 'N/A';
            document.getElementById('cert-dueno-telefono').textContent = data.tutorPhone || 'N/A';
            document.getElementById('cert-dueno-direccion').textContent = data.tutorAddress || 'N/A';
            
            document.getElementById('cert-fecha-inspeccion').textContent = new Date().toLocaleDateString('es-CL');

            const anexoContainer = document.getElementById('cert-anexo-container');
            if (data.species === 'Canina') {
                anexoContainer.innerHTML = await createCanineAnnexHTML(currentPatientId);
            } else if (data.species === 'Felina') {
                anexoContainer.innerHTML = await createFelineAnnexHTML(currentPatientId);
            } else if (data.species === 'Hurón') {
                anexoContainer.innerHTML = await createFerretAnnexHTML(currentPatientId);
            } else {
                anexoContainer.innerHTML = '<p>Especie no compatible para este certificado.</p>';
            }

            navigateTo('internationalTravelCertificate', currentPatientId);
        }

        async function createCanineAnnexHTML(patientId) {
            const { collection, query, getDocs, orderBy } = window.firebase;
            const db = window.db;

            const vaccineQuery = query(collection(db, "patients", patientId, "vaccines"), orderBy("date", "desc"));
            const vaccineSnapshot = await getDocs(vaccineQuery);
            let vaccineRows = '';
            vaccineSnapshot.forEach(doc => {
                const data = doc.data();
                vaccineRows += `<tr>
                    <td>${data.type || ''}</td><td></td><td>${data.brand || ''}</td><td></td><td>${data.date || ''}</td><td>${data.nextDose || ''}</td>
                </tr>`;
            });

            const dewormingQuery = query(collection(db, "patients", patientId, "deworming"), orderBy("date", "desc"));
            const dewormingSnapshot = await getDocs(dewormingQuery);
            let internalRows = '';
            let externalRows = '';
            dewormingSnapshot.forEach(doc => {
                const data = doc.data();
                const row = `<td>${data.product || ''}</td><td></td><td></td><td></td><td>${data.date || ''}</td><td></td>`;
                if (data.type === 'Interna') internalRows += `<tr>${row}</tr>`;
                if (data.type === 'Externa') externalRows += `<tr>${row}</tr>`;
            });

            return `
                <section class="cert-section">
                    <h2>ANEXO 2: Información del programa de vacunación y desparasitación para CANINOS</h2>
                    <h3 class="font-semibold mt-4 mb-2">Vacunación</h3>
                    <table class="cert-table">
                        <thead><tr><th>Nombre vacuna</th><th>Tipo</th><th>Laboratorio</th><th>N° serie</th><th>Fecha</th><th>Vigencia</th></tr></thead>
                        <tbody>${vaccineRows}</tbody>
                    </table>
                    <em class="text-xs">* La vacuna Antirrábica debe estar respaldada por el certificado original.</em>
                    <h3 class="font-semibold mt-4 mb-2">Desparasitación</h3>
                    <table class="cert-table">
                        <thead><tr><th>Nombre Producto</th><th>Laboratorio</th><th>Principio activo</th><th>Lote</th><th>Fecha</th><th>Hora</th></tr></thead>
                        <tbody>${internalRows}${externalRows}</tbody>
                    </table>
                </section>
            `;
        }

        async function createFelineAnnexHTML(patientId) {
            const { collection, query, getDocs, orderBy } = window.firebase;
            const db = window.db;

            const vaccineQuery = query(collection(db, "patients", patientId, "vaccines"), orderBy("date", "desc"));
            const vaccineSnapshot = await getDocs(vaccineQuery);
            let vaccineRows = '';
            vaccineSnapshot.forEach(doc => {
                const data = doc.data();
                vaccineRows += `<tr>
                    <td>${data.type || ''}</td><td></td><td>${data.brand || ''}</td><td></td><td>${data.date || ''}</td><td>${data.nextDose || ''}</td>
                </tr>`;
            });

            const dewormingQuery = query(collection(db, "patients", patientId, "deworming"), orderBy("date", "desc"));
            const dewormingSnapshot = await getDocs(dewormingQuery);
            let internalRows = '';
            let externalRows = '';
            dewormingSnapshot.forEach(doc => {
                const data = doc.data();
                const row = `<td>${data.product || ''}</td><td></td><td></td><td></td><td>${data.date || ''}</td><td></td>`;
                if (data.type === 'Interna') internalRows += `<tr>${row}</tr>`;
                if (data.type === 'Externa') externalRows += `<tr>${row}</tr>`;
            });

            return `
                <section class="cert-section">
                    <h2>ANEXO 1: Información del programa de vacunación y desparasitación para FELINOS</h2>
                    <h3 class="font-semibold mt-4 mb-2">Vacunación</h3>
                    <table class="cert-table">
                         <thead><tr><th>Nombre vacuna</th><th>Tipo</th><th>Laboratorio</th><th>N° serie</th><th>Fecha</th><th>Vigencia</th></tr></thead>
                        <tbody>${vaccineRows}</tbody>
                    </table>
                    <em class="text-xs">* La vacuna Antirrábica debe estar respaldada por el certificado original.</em>
                    <h3 class="font-semibold mt-4 mb-2">Desparasitación</h3>
                    <table class="cert-table">
                        <thead><tr><th>Nombre Producto</th><th>Laboratorio</th><th>Principio activo</th><th>Lote</th><th>Fecha</th><th>Hora</th></tr></thead>
                        <tbody>${internalRows}${externalRows}</tbody>
                    </table>
                </section>
            `;
        }
        
        async function createFerretAnnexHTML(patientId) {
            // Lógica similar para hurones si es necesario
            return `<section class="cert-section"><h2>ANEXO 3: Información para HURONES</h2><p>Datos de vacunación y desparasitación para hurones...</p></section>`;
        }

        function generateMicrochipCertificate(details) {
            if (!currentPatientData) {
                showNotification("No hay datos del paciente cargados.", true);
                return;
            }

            const data = currentPatientData;
            const procedureType = currentCertificateTemplate;
            const check = '☑';
            const uncheck = '☐';

            document.getElementById('mc-animal-nombre').textContent = data.name || '';
            document.getElementById('mc-animal-raza').textContent = data.breed || '';
            document.getElementById('mc-animal-color').textContent = data.colorMarkings || '';
            document.getElementById('mc-animal-fecha-nacimiento').textContent = data.birthDate ? data.birthDate.split('-').reverse().join('/') : '';
            
            document.getElementById('mc-animal-especie-perro').textContent = data.species === 'Canina' ? check : uncheck;
            document.getElementById('mc-animal-especie-gato').textContent = data.species === 'Felina' ? check : uncheck;

            document.getElementById('mc-animal-sexo-macho').textContent = data.sex === 'Macho' ? check : uncheck;
            document.getElementById('mc-animal-sexo-hembra').textContent = data.sex === 'Hembra' ? check : uncheck;

            const isSterilized = data.reproductiveStatus === 'Castrado' || data.reproductiveStatus === 'Esterilizada';
            document.getElementById('mc-animal-esterilizado-si').textContent = isSterilized ? check : uncheck;
            document.getElementById('mc-animal-esterilizado-no').textContent = !isSterilized ? check : uncheck;

            document.getElementById('mc-proc-implantacion').textContent = procedureType === 'implantacion-chip' ? check : uncheck;
            document.getElementById('mc-proc-verificacion').textContent = procedureType === 'validacion-chip' ? check : uncheck;

            document.getElementById('mc-obt-recogido').textContent = details.obtencion === 'Recogido' ? check : uncheck;
            document.getElementById('mc-obt-reubicacion').textContent = details.obtencion === 'Reubicacion' ? check : uncheck;
            document.getElementById('mc-obt-regalo').textContent = details.obtencion === 'Regalo' ? check : uncheck;
            document.getElementById('mc-obt-nacido').textContent = details.obtencion === 'Nacido en casa' ? check : uncheck;
            document.getElementById('mc-obt-compra').textContent = details.obtencion === 'Compra' ? check : uncheck;

            document.getElementById('mc-ten-compania').textContent = details.tenencia === 'Compañia' ? check : uncheck;
            document.getElementById('mc-ten-asistencia').textContent = details.tenencia === 'Asistencia' ? check : uncheck;
            document.getElementById('mc-ten-terapia').textContent = details.tenencia === 'Terapia' ? check : uncheck;

            document.getElementById('mc-fecha-procedimiento').textContent = new Date().toLocaleDateString('es-CL');

            navigateTo('microchipCertificate', currentPatientId);
        }
        
        // --- Utility Functions ---
        function calculateAge() {
            const birthDateInput = document.getElementById('data-birth-date');
            const ageInput = document.getElementById('data-age');
            if (!birthDateInput.value) {
                ageInput.value = '';
                return;
            }
            try {
                const birthDate = new Date(birthDateInput.value);
                const today = new Date();
                let years = today.getFullYear() - birthDate.getFullYear();
                let months = today.getMonth() - birthDate.getMonth();
                if (months < 0 || (months === 0 && today.getDate() < birthDate.getDate())) {
                    years--;
                    months = (months + 12) % 12;
                }
                ageInput.value = `${years} años, ${months} meses`;
            } catch (e) {
                ageInput.value = 'Fecha inválida';
            }
        }
        
        const formatRut = (rut) => {
            if (!rut) return '';
            rut = rut.replace(/[^0-9kK]/g, '');
            if (rut.length < 2) return rut;
            let body = rut.slice(0, -1);
            let dv = rut.slice(-1).toUpperCase();
            let formattedBody = body.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return `${formattedBody}-${dv}`;
        };

        const validateRut = (rut) => {
            if (!rut || !/^[0-9]{1,2}(\.?[0-9]{3}){2}-[0-9kK]{1}$/.test(rut)) return false;
            const cleanRut = rut.replace(/[.-]/g, '');
            let body = cleanRut.slice(0, -1);
            let dv = cleanRut.slice(-1).toUpperCase();
            let sum = 0;
            let multiple = 2;
            for (let i = body.length - 1; i >= 0; i--) {
                sum += multiple * body.charAt(i);
                if (multiple < 7) multiple++;
                else multiple = 2;
            }
            const dvExpected = 11 - (sum % 11);
            const dvCalculated = (dvExpected === 11) ? '0' : (dvExpected === 10) ? 'K' : String(dvExpected);
            return dv === dvCalculated;
        };
        
        function handleRutInput(e, messageElId) {
            const input = e.target;
            const messageEl = document.getElementById(messageElId);
            
            input.value = formatRut(input.value);
            
            if (validateRut(input.value)) {
                input.classList.remove('invalid');
                messageEl.textContent = '';
                return true;
            } else if (input.value) {
                input.classList.add('invalid');
                messageEl.textContent = 'RUT inválido.';
                return false;
            } else {
                input.classList.remove('invalid');
                messageEl.textContent = '';
                return false;
            }
        }

        function downloadPDF(elementId, fileName) {
            const element = document.getElementById(elementId);
            const opt = {
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
        }

        function sendEmail(email, subject, body) {
            if (!email) {
                showNotification("Por favor, ingrese un correo electrónico.", true);
                return;
            }
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        // --- Search Logic ---
        async function searchPatients() {
            const { getDocs, collection, query, where, doc, getDoc } = window.firebase;
            const db = window.db;
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) return;
            const searchResultsEl = document.getElementById('search-results');
            searchResultsEl.innerHTML = '<
